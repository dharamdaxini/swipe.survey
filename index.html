<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Operator v132.21</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#000; --card:#121212; --border:#333;
  --gold:#d4af37; --grey:#888;
  --font-serif:'Crimson Text',serif;
  --font-sans:'Inter',sans-serif;
  --font-code:'JetBrains Mono',monospace;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

body{
  margin:0;height:100vh;background:var(--bg);
  color:#e0e0e0;font-family:var(--font-sans);
  overflow:hidden;display:flex;flex-direction:column;
}

#header{width:90%;margin:22px auto 0}
.header-meta{
  display:flex;justify-content:space-between;
  font-family:var(--font-code);
  font-size:.75rem;color:#666;letter-spacing:1.5px;
}

.progress-track{width:100%;height:3px;background:#222;margin-top:12px}
#progress-bar{height:100%;background:var(--gold);width:0%}

#stack{
  position:relative;width:90%;max-width:420px;height:62vh;
  margin:auto;perspective:1500px;
  display:flex;align-items:center;justify-content:center;
}

.card{
  position:absolute;width:100%;height:95%;
  background:var(--card);border-radius:12px;
  border:1px solid var(--border);
  padding:35px;
  display:flex;justify-content:center;align-items:center;
  box-shadow:0 20px 60px rgba(0,0,0,.95);
}

.card-q{
  font-family:var(--font-serif);
  font-size:1.7rem;
  line-height:1.45;
  font-weight:600;
  text-align:center;
  color:#d0d0d0;
}

.swipe-label{
  position:absolute;inset:0;
  display:flex;align-items:center;justify-content:center;
  background:#000;
  font-family:var(--font-sans);
  font-weight:700;font-size:1.4rem;
  text-transform:uppercase;
  letter-spacing:1px;
  opacity:0;pointer-events:none;
  color:var(--grey);
}
</style>
</head>

<body>

<div id="header">
  <div class="header-meta">
    <span id="id-ui">BOOT</span>
    <span id="xp-ui">0 XP</span>
  </div>
  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack">
  <div class="card">
    <div class="card-q" style="font-family:var(--font-code);font-size:.9rem;color:#666">
      ALCHEMIST v132.21<br>INITIALIZINGâ€¦
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const MASTER_URL =
  "https://raw.githubusercontent.com/dharamdaxini/swipe.survey/e939bcc47c331c43fb8875e3a77f1125329a3810/master.json";

/* ================= STATE ================= */
let RAW_DATA = [];
let POOL = [];
let SESSION = [];
let XP = 0;

/* ================= UTILS ================= */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function chemText(t){
  return String(t||"")
    .replace(/_([0-9]+)/g,"<sub>$1</sub>")
    .replace(/\^([0-9+\-]+)/g,"<sup>$1</sup>");
}

/* ================= RENDER ================= */
function card(text,labels,cb){
  const stack=document.getElementById("stack");
  stack.innerHTML="";
  const el=document.createElement("div");
  el.className="card";
  el.innerHTML=`
    <div class="card-q">${chemText(text)}</div>
    <div class="swipe-label sl-up">${labels.up||""}</div>
    <div class="swipe-label sl-left">${labels.left||""}</div>
    <div class="swipe-label sl-right">${labels.right||""}</div>
  `;
  stack.appendChild(el);
  new Swipe(el,cb);
}

/* ================= SWIPE ENGINE (STABLE) ================= */
class Swipe{
  constructor(el,cb){
    this.el=el;this.cb=cb;this.start=null;
    el.addEventListener("touchstart",e=>{
      this.start=e.touches[0];
    },{passive:true});
    el.addEventListener("touchend",e=>{
      if(!this.start)return;
      const t=e.changedTouches[0];
      const dx=t.clientX-this.start.clientX;
      const dy=t.clientY-this.start.clientY;
      if(Math.hypot(dx,dy)>80){
        this.cb(this.dir(dx,dy));
      }
      this.start=null;
    });
  }
  dir(dx,dy){
    const a=(Math.atan2(-dy,dx)*180/Math.PI+360)%360;
    if(a>45&&a<135)return"UP";
    if(a>135&&a<225)return"LEFT";
    return"RIGHT";
  }
}

/* ================= FLOW ================= */
function begin(){
  card(
    `SESSION READY\n${RAW_DATA.length} QUESTIONS`,
    {up:"START"},
    d=>d==="UP"&&startQuiz()
  );
}

function startQuiz(){
  POOL=shuffle([...RAW_DATA]);
  SESSION=[];
  XP=0;
  nextQ();
}

function nextQ(){
  if(!POOL.length){exportPDF();return;}
  const d=POOL.shift();
  SESSION.push(d);
  document.getElementById("id-ui").textContent=d.id;

  const opts=shuffle([d.u,d.l,d.r]);
  const map={UP:opts[0],LEFT:opts[1],RIGHT:opts[2]};

  card(d.q,map,dir=>{
    if(map[dir]===d.correct)XP++;
    document.getElementById("xp-ui").textContent=`${XP} XP`;
    document.getElementById("progress-bar").style.width=
      (SESSION.length/RAW_DATA.length*100)+"%";
    nextQ();
  });
}

/* ================= PDF ================= */
function exportPDF(){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  let y=20;

  SESSION.forEach((d,i)=>{
    if(y>260){doc.addPage();y=20;}
    doc.setFontSize(12);
    doc.text(`Q${i+1}. ${d.q}`,15,y);y+=10;
    doc.setFontSize(10);
    doc.text(`A) ${d.u}`,20,y);y+=6;
    doc.text(`B) ${d.l}`,20,y);y+=6;
    doc.text(`C) ${d.r}`,20,y);y+=8;
  });

  doc.save(`ACADEMY_v132_21_${Date.now()}.pdf`);
}

/* ================= INIT ================= */
(async function init(){
  const r=await fetch(MASTER_URL,{cache:"no-store"});
  RAW_DATA=await r.json();
  begin();
})();
</script>

</body>
</html>
