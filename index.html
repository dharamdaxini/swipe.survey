<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Kinetic Loop v136.59</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#000000; 
  --card:#0a0a0a; 
  --border:#222;
  --gold:#ffd600; 
  --green:#2ecc71;
  --text-white:#ffffff;
  --text-grey:#888888;
  --font-serif:'Crimson Text',serif;
  --font-sans:'Inter',sans-serif;
  --font-code:'JetBrains Mono',monospace;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{
  margin:0;height:100vh;background:var(--bg);
  color:var(--text-white);font-family:var(--font-sans);
  overflow:hidden;display:flex;flex-direction:column;
}
#header{width:90%;margin:25px auto 0;z-index:100;flex-shrink:0;}
.header-meta{
  display:flex;justify-content:space-between;
  font-family:var(--font-code);font-size:.75rem;
  color:#666;letter-spacing:1.5px;text-transform:uppercase;
  margin-bottom:15px;
}
.progress-track{width:100%;height:3px;background:#222;border-radius:2px;}
#progress-bar{height:100%;background:var(--gold);width:0%;transition:width .4s ease;border-radius:2px;}
#kinetic-logger{
  width:90%;margin:15px auto 5px;
  font-family:var(--font-code);font-size:.8rem;
  color:#444;line-height:1.4;text-transform:uppercase;
  min-height:60px;display:flex;flex-direction:column;justify-content:flex-end;
  pointer-events:none;
}
.log-line{opacity:.5;transition:opacity .2s;}
.log-line.active{color:var(--green);opacity:1;font-weight:700;}
.log-line.primary{color:var(--gold);opacity:1;font-weight:700;}
#stack{
  position:relative;width:90%;max-width:420px;
  height:calc(100vh - 220px - env(safe-area-inset-bottom));
  margin:10px auto 20px;
  perspective:1500px;
  display:flex;align-items:center;justify-content:center;
}
.card{
  position:absolute;width:100%;height:100%;
  background:var(--card);
  border-radius:14px;border:1px solid var(--border);
  padding:35px;
  display:flex;flex-direction:column;justify-content:center;align-items:center;
  box-shadow:0 20px 60px rgba(0,0,0,.95);
  will-change:transform;transform-style:preserve-3d;
  overflow:hidden;
}
.card-q{
  font-family:var(--font-serif);
  font-size:clamp(1.4rem,5vw,1.9rem);
  line-height:1.4;font-weight:600;text-align:center;
  color:var(--text-white);
  width:100%;max-height:100%;overflow-y:auto;
  padding:0 5px;display:flex;flex-direction:column;justify-content:center;
}
.card-q::-webkit-scrollbar{width:0;}
.card-q sub{font-size:.7em;vertical-align:-.3em;}
.card-q sup{font-size:.7em;vertical-align:.5em;}
.swipe-label{
  position:absolute;inset:0;
  display:flex;align-items:center;justify-content:center;
  background:#000;font-family:var(--font-sans);
  font-weight:900;font-size:1.8rem;
  text-transform:uppercase;letter-spacing:1px;
  text-align:center;padding:40px;
  opacity:0;pointer-events:none;
  transition:opacity .15s ease;border-radius:14px;
  color:var(--text-grey);border:1px solid #333;
}
</style>
</head>
<body>

<div id="header">
  <div class="header-meta">
    <span id="id-ui">VIA.STACK</span>
    <span id="xp-ui">0 XP</span>
  </div>
  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="kinetic-logger">
  <div class="log-line" id="log-1">> SYSTEM BOOT</div>
  <div class="log-line" id="log-2">> WAITING FOR DATA</div>
  <div class="log-line active" id="log-3">> ...</div>
</div>

<div id="stack">
  <div class="card">
    <div class="card-q" style="font-family:var(--font-code);font-size:.9rem;color:#666;">
      INITIALIZING CORE...
    </div>
  </div>
</div>

<script>
const MASTER_KEY="ALCHEMIST_MASTER_V1";
let RAW_DATA=[],SET_CURSOR=0,ACTIVE_SET=null;
let POOL=[],WRONG=[],XP=0,SESSION_ALL=[],VOLUME_LIMIT=null;
let ATTEMPTED=new Set(),REVIEW_INDEX=0;
let SESSION_PDF_DATA=[];

function log(msg,type="normal"){
  const l1=log_1,l2=log_2,l3=log_3;
  l1.innerText=l2.innerText;l1.className=l2.className;
  l2.innerText=l3.innerText;l2.className="log-line";
  l3.innerText=`> ${msg}`;
  l3.className=type==="active"?"log-line active":type==="primary"?"log-line primary":"log-line";
}

const chemText=t=>String(t||"").replace(/_(\d+)/g,"<sub>$1</sub>").replace(/\^([0-9+\-]+)/g,"<sup>$1</sup>");
const cleanPDF=t=>String(t||"").replace(/<[^>]*>/g,"");
const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};

const UI={stack, xp:xp_ui, bar:progress_bar};

class PhysicsController{
 constructor(el,cbs){
  this.el=el;this.cbs=cbs;this.active=false;this.start={x:0,y:0};
  this.labels={UP:el.querySelector(".sl-up"),LEFT:el.querySelector(".sl-left"),RIGHT:el.querySelector(".sl-right"),DOWN:el.querySelector(".sl-down")};
  const s=e=>this.startDrag(e.touches?e.touches[0]:e);
  const m=e=>this.move(e.touches?e.touches[0]:e);
  const e2=()=>this.end();
  el.addEventListener("mousedown",s);window.addEventListener("mousemove",m);window.addEventListener("mouseup",e2);
  el.addEventListener("touchstart",s,{passive:true});
  el.addEventListener("touchmove",ev=>{if(this.active)ev.preventDefault();m(ev)},{passive:false});
  el.addEventListener("touchend",e2);
 }
 startDrag(p){this.active=true;this.start={x:p.clientX,y:p.clientY};this.el.style.transition="none"}
 move(p){
  if(!this.active)return;
  const dx=p.clientX-this.start.x,dy=p.clientY-this.start.y;
  const d=Math.hypot(dx,dy);
  this.el.style.transform=`translate(${dx}px,${dy}px) rotate(${dx/25}deg)`;
  Object.values(this.labels).forEach(l=>l&&(l.style.opacity=0));
  if(d>20){const dir=this.dir(dx,dy);this.labels[dir]&&(this.labels[dir].style.opacity=Math.min(d/50,1))}
 }
 end(){
  if(!this.active)return;this.active=false;
  const m=new WebKitCSSMatrix(getComputedStyle(this.el).transform);
  const dx=m.m41,dy=m.m42;
  if(Math.hypot(dx,dy)>100)this.cbs.onCommit(this.dir(dx,dy));
  else{this.el.style.transition=".4s cubic-bezier(0.2,0.8,0.2,1)";this.el.style.transform="translate(0,0)"}
 }
 dir(dx,dy){
  const a=(Math.atan2(-dy,dx)*180/Math.PI+360)%360;
  if(a>45&&a<135)return"UP";
  if(a>135&&a<225)return"LEFT";
  if(a>225&&a<315)return"DOWN";
  return"RIGHT";
 }
}

function card(text,labels,cb){
 UI.stack.innerHTML="";
 const el=document.createElement("div");
 el.className="card";
 el.innerHTML=`
 <div class="card-q">${chemText(text).replace(/\n/g,"<br>")}</div>
 <div class="swipe-label sl-up">${labels.up||""}</div>
 <div class="swipe-label sl-left">${labels.left||""}</div>
 <div class="swipe-label sl-right">${labels.right||""}</div>
 <div class="swipe-label sl-down">${labels.down||""}</div>`;
 UI.stack.appendChild(el);
 new PhysicsController(el,{onCommit:cb});
}

function begin(){
 log("SESSION READY","active");
 card(`DATA LOADED\n${RAW_DATA.length} UNITS`,{up:"QUIZ"},d=>d==="UP"&&setPick());
}

function setPick(){
 const sets=[...new Set(RAW_DATA.map(d=>d.set))];
 card(sets[SET_CURSOR],{left:"",right:"",up:"SELECT"},dir=>{
  if(dir==="LEFT"){SET_CURSOR=(SET_CURSOR-1+sets.length)%sets.length;setPick()}
  if(dir==="RIGHT"){SET_CURSOR=(SET_CURSOR+1)%sets.length;setPick()}
  if(dir==="UP"){ACTIVE_SET=sets[SET_CURSOR];volumePick()}
 });
}

function volumePick(){
 card("QUESTION VOLUME",{up:"10",left:"25",right:"50",down:"ALL"},dir=>{
  if(dir==="UP")VOLUME_LIMIT=10;
  if(dir==="LEFT")VOLUME_LIMIT=25;
  if(dir==="RIGHT")VOLUME_LIMIT=50;
  if(dir==="DOWN")VOLUME_LIMIT=null;
  startQuiz();
 });
}

function startQuiz(){
 let base=shuffle(RAW_DATA.filter(d=>d.set===ACTIVE_SET));
 if(VOLUME_LIMIT&&VOLUME_LIMIT<base.length)base=base.slice(0,VOLUME_LIMIT);
 SESSION_PDF_DATA=[...base];
 exportSessionPDF();          // âœ… PDF GENERATED HERE
 POOL=[...base];WRONG=[];SESSION_ALL=[];XP=0;ATTEMPTED=new Set();
 nextQ();
}

function nextQ(){
 if(!POOL.length){WRONG.length?review():report();return;}
 const d=POOL.shift();
 SESSION_ALL.push(d);
 const opts=shuffle([d.u,d.l,d.r]);
 const map={UP:opts[0],LEFT:opts[1],RIGHT:opts[2]};
 card(d.q,{up:map.UP,left:map.LEFT,right:map.RIGHT},dir=>{
  const picked=map[dir];
  const correct=[d.u,d.l,d.r].find(o=>o===d.correct)||d.correct;
  if(String(picked).toLowerCase()!==String(correct).toLowerCase())WRONG.push(d);
  else if(!ATTEMPTED.has(d.id))XP++;
  ATTEMPTED.add(d.id);
  UI.xp.textContent=`${XP} / ${SESSION_ALL.length}`;
  UI.bar.style.width=`${(SESSION_ALL.length/(SESSION_ALL.length+POOL.length+WRONG.length))*100}%`;
  nextQ();
 });
}

function review(){report();}

function report(){
 card(`SUMMARY\n\n${XP} / ${SESSION_ALL.length}`,{up:"RESTART"},()=>begin());
}

function exportSessionPDF(){
 if(!SESSION_PDF_DATA.length)return;
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();let y=20;
 SESSION_PDF_DATA.forEach((d,i)=>{
  if(y>260){doc.addPage();y=20}
  doc.setFontSize(12);doc.text(`Q${i+1}: ${cleanPDF(d.q)}`,15,y);y+=8;
  doc.setFontSize(10);
  doc.text(`A) ${cleanPDF(d.u)}`,15,y);y+=5;
  doc.text(`B) ${cleanPDF(d.l)}`,15,y);y+=5;
  doc.text(`C) ${cleanPDF(d.r)}`,15,y);y+=8;
 });
 doc.save(`ALCHEMIST_SESSION_${Date.now()}.pdf`);
}

async function init(){
 const local=localStorage.getItem(MASTER_KEY);
 if(local)RAW_DATA=JSON.parse(local);
 else{const r=await fetch("master.json");RAW_DATA=await r.json()}
 begin();
}
init();
</script>
</body>
</html>
