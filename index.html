<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>Alchemist | Neural Backend</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,600;1,600&family=Inter:wght@400;700&family=JetBrains+Mono&display=swap" rel="stylesheet">

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/auto-render.min.js"></script>

<!-- PDF -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#000;--card:#111;--border:#222;--gold:#ffd600;
  --font-q:'Crimson Text',serif;
  --font-ui:'Inter',sans-serif;
  --font-code:'JetBrains Mono',monospace;
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:#fff;
  font-family:var(--font-ui);height:100vh;
  overflow:hidden;
}
#top{
  display:flex;justify-content:space-between;
  padding:14px 20px;border-bottom:1px solid #222;
  font-family:var(--font-code);font-size:12px;
}
button{
  background:none;border:1px solid #333;
  color:var(--gold);padding:4px 10px;
  cursor:pointer;font-family:var(--font-code);
}
#stack{
  position:relative;width:100%;
  height:calc(100vh - 52px);
  display:flex;align-items:center;justify-content:center;
}
.card{
  position:absolute;width:90%;max-width:420px;
  height:70%;background:var(--card);
  border-radius:40px;border:1px solid var(--border);
  padding:40px;display:flex;
  align-items:center;justify-content:center;
  text-align:center;
  transition:transform .3s,opacity .3s;
}
.q{
  font-family:var(--font-q);
  font-size:1.6rem;line-height:1.4;
}
.opt{
  position:absolute;font-size:.85rem;
  color:#bbb;font-family:var(--font-ui);
}
.opt.up{top:16px;left:50%;transform:translateX(-50%)}
.opt.left{left:16px;bottom:50%;transform:translateY(50%)}
.opt.right{right:16px;bottom:50%;transform:translateY(50%)}
.overlay{
  position:absolute;inset:0;
  background:#000;padding:30px;
  display:none;overflow:auto;
}
.overlay.show{display:block}
</style>
</head>

<body>

<div id="top">
  <div id="qid">BOOT</div>
  <button onclick="exportPDF()">EXPORT PDF</button>
  <div id="xp">0 XP</div>
</div>

<input type="file" id="file" style="display:none">
<div id="stack"></div>

<script>
let DATA=[], SCORE=0;

const fallback=[
  {
    id:"PRE_01",
    q:"Calculate $E^\\circ_{cell}$",
    u:"$E^\\circ_{cathode}-E^\\circ_{anode}$",
    l:"$E^\\circ_{anode}-E^\\circ_{cathode}$",
    r:"$E^\\circ_{cell}/2$",
    correct:"$E^\\circ_{cathode}-E^\\circ_{anode}$",
    logic:"Standard electrochemistry definition."
  }
];

document.body.addEventListener("dblclick",()=>file.click());
file.onchange=e=>loadFile(e.target.files[0]);

function loadFile(f){
  const r=new FileReader();
  r.onload=()=>{
    if(r.result.trim().startsWith("[")){
      DATA=JSON.parse(r.result);
    }else{
      DATA=r.result.split("\n").filter(Boolean).map(l=>{
        const c=l.split("\t");
        return{
          id:c[0],q:c[5],u:c[6],l:c[8],r:c[7],
          correct:c[6],logic:c[10]
        }
      })
    }
    next();
  };
  r.readAsText(f);
}

function renderMath(el){
  renderMathInElement(el,{delimiters:[
    {left:"$",right:"$",display:false},
    {left:"$$",right:"$$",display:true}
  ]});
}

function next(){
  if(!DATA.length) return;
  const d=DATA[0];
  qid.innerText=d.id||"Q";
  stack.innerHTML="";

  const c=document.createElement("div");
  c.className="card";
  c.innerHTML=`
    <div class="q">${d.q}</div>
    <div class="opt up">${d.u||""}</div>
    <div class="opt left">${d.l||""}</div>
    <div class="opt right">${d.r||""}</div>
    <div class="overlay">${d.logic||""}</div>
  `;
  stack.appendChild(c);
  renderMath(c);

  swipe(c,(dir,dx,dy)=>{
    if(dir==="DOWN"){
      c.querySelector(".overlay").classList.add("show");
      c.style.transform="translate(0,0)";
      return;
    }
    const sel=dir==="UP"?d.u:dir==="LEFT"?d.l:d.r;
    if(sel===d.correct){
      SCORE+=10;xp.innerText=SCORE+" XP";
    }
    c.style.transform=`translate(${dx*1.4}px,${dy*1.4}px)`;
    c.style.opacity=0;
    setTimeout(()=>{DATA.shift();next()},300);
  });
}

function swipe(el,cb){
  let sx,sy,dx,dy,act=false;
  el.ontouchstart=e=>{
    act=true;
    sx=e.touches[0].clientX;
    sy=e.touches[0].clientY;
  };
  el.ontouchmove=e=>{
    if(!act)return;
    dx=e.touches[0].clientX-sx;
    dy=e.touches[0].clientY-sy;
    el.style.transform=`translate(${dx}px,${dy}px)`;
  };
  el.ontouchend=()=>{
    act=false;
    const d=Math.hypot(dx,dy);
    if(d<80){
      el.style.transform="translate(0,0)";
      return;
    }
    const dir=Math.abs(dx)>Math.abs(dy)
      ?dx>0?"RIGHT":"LEFT"
      :dy>0?"DOWN":"UP";
    cb(dir,dx,dy);
  };
}

async function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF("p","pt","a4");
  const card=document.querySelector(".card");
  const canvas=await html2canvas(card,{scale:2});
  const img=canvas.toDataURL("image/png");
  pdf.addImage(img,"PNG",20,20,555,780);
  pdf.save("alchemist.pdf");
}

DATA=fallback;
next();
</script>
</body>
</html>
