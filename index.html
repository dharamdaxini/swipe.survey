<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V37.5 Cognitive Engine</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    
    <style>
        :root {
            --bg: #000000;
            --card: #ffffff;
            --accent: #2563eb;
            --trap: #ef4444;
            --text-dark: #1a1a1a;
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; 
            background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; touch-action: none;
        }

        /* V25/V37 Geometric Identity */
        #app { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }

        .view { display: none; position: absolute; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .view.active { display: flex; }

        .card {
            width: 85%; max-width: 400px; height: 60vh;
            background: var(--card); border-radius: 40px;
            padding: 2rem; box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; justify-content: space-between;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: grab; position: relative; z-index: 10;
        }

        .question-text { font-size: 1.4rem; font-weight: 700; color: var(--text-dark); line-height: 1.3; }

        .options-map { margin-top: 1.5rem; }
        .option-item { 
            font-size: 1.1rem; margin-bottom: 0.8rem; color: #444; 
            display: flex; align-items: flex-start;
        }
        .option-item::before {
            content: "•"; color: var(--accent); font-size: 1.8rem; margin-right: 10px; line-height: 1;
        }

        /* Gesture Indicators */
        .hint { position: absolute; bottom: 20px; color: #666; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }

        /* Summary View */
        #view-summary { color: white; text-align: center; }
        button {
            padding: 1rem 2rem; border-radius: 50px; border: none;
            background: var(--accent); color: white; font-weight: bold; font-size: 1.2rem; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="app">
    <div id="view-start" class="view active">
        <h1 style="color: white; margin-bottom: 2rem;">V37.5 Engine</h1>
        <button onclick="APP.start('CORE')">INITIALIZE DECK</button>
    </div>

    <div id="view-game" class="view">
        <div id="main-card" class="card">
            <div id="q-text" class="question-text">Loading...</div>
            <div class="options-map">
                <div id="opt-up" class="option-item"></div>
                <div id="opt-left" class="option-item"></div>
                <div id="opt-right" class="option-item"></div>
            </div>
            <div class="hint">Swipe: ↑ 1 | ← 2 | → 3 | ↓ Map</div>
        </div>
    </div>

    <div id="view-summary" class="view">
        <h2>Assessment Complete</h2>
        <div id="score-report" style="font-size: 3rem; margin: 1rem 0;"></div>
        <button onclick="location.reload()">RESTART SESSION</button>
    </div>
</div>

<script>
// --- DATA BACKEND (CORE DECK) ---
const DECKS = {
    CORE: [
        {
            id: "AS_01",
            question: "Synthesis of $t$-butyl methyl ether via Williamson Ether Synthesis.",
            up: "$(CH_3)_3C-Br + CH_3ONa$",
            left: "$(CH_3)_3CONa + CH_3I$ in $H_2O$",
            right: "$(CH_3)_3CONa + CH_3I$ in $CH_3CN$",
            map: "Eliminate Up: 3° halides undergo E2. Eliminate Left: Protic solvents slow Sn2."
        },
        {
            id: "AS_14",
            question: "Swern Oxidation of $1^\\circ$ Alcohol conditions.",
            up: "$PCC$ in $CH_2Cl_2$",
            left: "$(COCl)_2/DMSO$ at $25^\\circ C$",
            right: "$(COCl)_2/DMSO$ at $-78^\\circ C$",
            map: "Eliminate Left: Reagent decomposes explosively above -60°C."
        }
        // Add all 15 questions here...
    ]
};

// --- LOGIC ENGINE ---
const APP = {
    deck: [],
    idx: 0,
    answers: [],
    startY: 0,
    startX: 0,

    // Fisher-Yates Shuffle Injection
    shuffle(arr) {
        let m = arr.length, t, i;
        while (m) {
            i = Math.floor(Math.random() * m--);
            t = arr[m]; arr[m] = arr[i]; arr[i] = t;
        }
        return arr;
    },

    start(key) {
        this.deck = this.shuffle([...DECKS[key]]); // Kills repetition bug
        this.idx = 0;
        this.answers = [];
        this.showView('view-game');
        this.render();
    },

    showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    },

    render() {
        if (this.idx >= this.deck.length) {
            this.complete();
            return;
        }

        const q = this.deck[this.idx];
        const card = document.getElementById('main-card');
        
        // Reset card physics
        card.style.transform = `translate(0,0) rotate(0)`;
        
        // Inject Content
        document.getElementById('q-text').innerHTML = q.question;
        document.getElementById('opt-up').innerHTML = q.up;
        document.getElementById('opt-left').innerHTML = q.left;
        document.getElementById('opt-right').innerHTML = q.right;

        // Trigger LaTeX re-render
        if (window.renderMathInElement) {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ]
            });
        }
    },

    handleSwipe(dir) {
        // Logging for your Google Sheets Backend
        const payload = {
            id: this.deck[this.idx].id,
            choice: dir,
            latency: Date.now() - this.startTime
        };
        this.answers.push(payload);

        // Visual feedback
        const card = document.getElementById('main-card');
        const directions = {
            'UP': 'translateY(-100vh) rotate(10deg)',
            'LEFT': 'translateX(-100vw) rotate(-20deg)',
            'RIGHT': 'translateX(100vw) rotate(20deg)',
            'DOWN': 'scale(0.8) translateY(100vh)'
        };

        card.style.transform = directions[dir];

        setTimeout(() => {
            if (dir === 'DOWN') {
                alert("ELIMINATION MAP: " + this.deck[this.idx].map);
                card.style.transform = 'translate(0,0)';
            } else {
                this.idx++;
                this.render();
            }
        }, 300);
    },

    complete() {
        this.showView('view-summary');
        document.getElementById('score-report').innerText = `${this.answers.length} Responses Logged`;
    }
};

// --- GESTURE LISTENERS ---
const card = document.getElementById('main-card');

card.addEventListener('touchstart', e => {
    APP.startX = e.touches[0].clientX;
    APP.startY = e.touches[0].clientY;
    APP.startTime = Date.now();
});

card.addEventListener('touchend', e => {
    const diffX = e.changedTouches[0].clientX - APP.startX;
    const diffY = e.changedTouches[0].clientY - APP.startY;
    const threshold = 50;

    if (Math.abs(diffX) > Math.abs(diffY)) {
        if (diffX > threshold) APP.handleSwipe('RIGHT');
        else if (diffX < -threshold) APP.handleSwipe('LEFT');
    } else {
        if (diffY > threshold) APP.handleSwipe('DOWN');
        else if (diffY < -threshold) APP.handleSwipe('UP');
    }
});
</script>

</body>
</html>
