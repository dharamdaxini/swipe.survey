<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Neural Backend v136.09</title>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,600;1,600&family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --bg:#000;--card:#111;--border:#222;
  --gold:#ffd600;--blue:#3498db;
  --green:#2ecc71;--red:#e74c3c;
  --font-chem:'Crimson Text',serif;
  --font-ui:'Inter',sans-serif;
  --font-code:'JetBrains Mono',monospace;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

body{
  margin:0;height:100vh;background:var(--bg);
  color:#fff;font-family:var(--font-ui);
  overflow:hidden;display:flex;flex-direction:column;
}

#header{width:90%;margin:25px auto 0;z-index:100}
.header-meta{
  display:flex;justify-content:space-between;
  font-family:var(--font-code);
  font-size:.7rem;color:#555;letter-spacing:2px
}

/* DYNAMIC HEADER FOR LOGIC TEXT */
#review-text{
  margin-top:15px;
  font-family:var(--font-chem);
  font-size:1.1rem;
  line-height:1.4;
  font-style:italic;
  text-align:center;
  color:#e0e0e0;
  min-height:3.5em; 
  display:flex; align-items:flex-end; justify-content:center;
  text-shadow: 0 2px 10px rgba(0,0,0,0.8);
}

.progress-track{width:100%;height:2px;background:#1a1a1a;margin-top:10px}
#progress-bar{height:100%;background:var(--gold);width:0%;transition:.4s}

#stack{
  position:relative;width:92%;max-width:400px;height:70vh;
  margin:auto;perspective:1200px;
  display:flex;align-items:center;justify-content:center
}

.card{
  position:absolute;width:100%;height:95%;
  background:var(--card);
  border-radius:40px;
  border:1px solid var(--border);
  padding:40px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  box-shadow:0 30px 90px rgba(0,0,0,.9);
  will-change:transform;
  transform-style:preserve-3d
}

.card-q{
  font-family:var(--font-chem);
  font-size:1.7rem;
  line-height:1.45;
  font-style:italic;
  font-weight:600;
  text-align:center;
  pointer-events:none;
}
.card-q sub{font-size:.7em;vertical-align:-.3em}
.card-q sup{font-size:.7em;vertical-align:.45em}

.swipe-label{
  position:absolute;inset:0;display:flex;
  align-items:center;justify-content:center;
  background:#000;font-weight:900;font-size:1.4rem;
  text-transform:uppercase;border-radius:40px;
  opacity:0;pointer-events:none;padding:30px;
  text-align:center;z-index:10;transition:opacity .1s
}
.sl-up{color:var(--green)}
.sl-left,.sl-right{color:var(--red)}
.sl-down{color:var(--blue)}
</style>
</head>
<body>

<div id="header">
  <div class="header-meta">
    <span id="id-ui">BOOT</span>
    <span id="xp-ui">0 XP</span>
  </div>
  <div id="review-text"></div>
  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack">
  <div class="card">
    <div class="card-q" style="font-family:var(--font-code);font-size:11px;color:#666;font-style:normal">
      VIA.STACK<br>INITIALIZING…
    </div>
  </div>
</div>

<script>
/* ================= CHEM TEXT NORMALIZER ================= */
function chemText(t){
  if(!t) return "";
  return String(t)
    .replace(/_([0-9]+)/g,"<sub>$1</sub>")
    .replace(/\^([0-9+\-]+)/g,"<sup>$1</sup>")
    .replace(/<->|↔|\\rightleftharpoons/g,"⇌");
}

/* ================= CONFIG ================= */
const MASTER_URL = "https://raw.githubusercontent.com/dharamdaxini/swipe.survey/e939bcc47c331c43fb8875e3a77f1125329a3810/master.json";
const USER_KEY = "ALCHEMIST_DATA_V1";

/* ================= STATE ================= */
let RAW_DATA=[], MASTER_DATA=[], USER_DATA=[];
const UI={
  stack:document.getElementById("stack"),
  id:document.getElementById("id-ui"),
  xp:document.getElementById("xp-ui"),
  bar:document.getElementById("progress-bar"),
  review:document.getElementById("review-text")
};

let SET_CURSOR=0, ACTIVE_SET=null;
let POOL=[], WRONG=[], REVIEW_INDEX=0;
let SESSION_ALL=[], XP=0;
let VOLUME_LIMIT=null;
let ATTEMPTED = new Set(); // Tracks unique questions seen for scoring

/* ================= PHYSICS ENGINE (UNCHANGED) ================= */
class PhysicsController{
 constructor(el,cbs){
  this.el=el;this.cbs=cbs;this.active=false;this.start={x:0,y:0};
  this.labels={
    UP:el.querySelector(".sl-up"),
    LEFT:el.querySelector(".sl-left"),
    RIGHT:el.querySelector(".sl-right"),
    DOWN:el.querySelector(".sl-down")
  };
  const s=e=>this.startDrag(e.touches?e.touches[0]:e);
  const m=e=>this.move(e.touches?e.touches[0]:e);
  const e2=()=>this.end();
  el.addEventListener("mousedown",s);
  window.addEventListener("mousemove",m);
  window.addEventListener("mouseup",e2);
  el.addEventListener("touchstart",s,{passive:false});
  el.addEventListener("touchmove",ev=>{if(this.active)ev.preventDefault();m(ev)},{passive:false});
  el.addEventListener("touchend",e2);
 }
 startDrag(p){this.active=true;this.start={x:p.clientX,y:p.clientY};this.el.style.transition="none"}
 move(p){
  if(!this.active)return;
  const dx=p.clientX-this.start.x,dy=p.clientY-this.start.y;
  const d=Math.hypot(dx,dy);
  this.el.style.transform=`translate(${dx}px,${dy}px) rotate(${dx/20}deg)`;
  Object.values(this.labels).forEach(l=>l&&(l.style.opacity=0));
  if(d>20){
    const dir=this.dir(dx,dy);
    this.labels[dir]&&(this.labels[dir].style.opacity=Math.min(d/50,1));
  }
 }
 end(){
  if(!this.active)return;this.active=false;
  const m=new WebKitCSSMatrix(getComputedStyle(this.el).transform);
  const dx=m.m41,dy=m.m42;
  if(Math.hypot(dx,dy)>100)this.cbs.onCommit(this.dir(dx,dy));
  else{this.el.style.transition=".4s";this.el.style.transform="translate(0,0)"}
 }
 dir(dx,dy){
  const a=(Math.atan2(-dy,dx)*180/Math.PI+360)%360;
  if(a>45&&a<135)return"UP";
  if(a>135&&a<225)return"LEFT";
  if(a>225&&a<315)return"DOWN";
  return"RIGHT";
 }
}

/* ================= RENDER LOGIC ================= */
function card(text,labels,cb){
 const safeText=chemText(text);
 UI.stack.innerHTML="";
 const el=document.createElement("div");
 el.className="card";
 el.innerHTML=`
  <div class="card-q">${safeText.replace(/\n/g,"<br>")}</div>
  <div class="swipe-label sl-up">${chemText(labels.up)||""}</div>
  <div class="swipe-label sl-left">${chemText(labels.left)||""}</div>
  <div class="swipe-label sl-right">${chemText(labels.right)||""}</div>
  <div class="swipe-label sl-down">${chemText(labels.down)||""}</div>`;
 UI.stack.appendChild(el);
 new PhysicsController(el,{onCommit:cb});
}

/* ================= APP FLOW ================= */
function begin(){
 UI.review.textContent=""; 
 card("BEGIN",{up:"QUIZ",down:"MY PDF",left:"RAPID",right:"LEARN"},dir=>{
  if(dir==="UP") setPick();
  if(dir==="DOWN") exportSessionPDF();
 });
}

function setPick(){
 const sets=[...new Set(RAW_DATA.map(d=>d.set))];
 if(sets.length===0) { alert("No Data Loaded"); return; }
 card(sets[SET_CURSOR],{left:"",right:"",up:"SELECT",down:"BACK"},dir=>{
  if(dir==="LEFT"){SET_CURSOR=(SET_CURSOR+sets.length-1)%sets.length;setPick();}
  if(dir==="RIGHT"){SET_CURSOR=(SET_CURSOR+1)%sets.length;setPick();}
  if(dir==="UP"){ACTIVE_SET=sets[SET_CURSOR];volumePick();}
  if(dir==="DOWN") begin();
 });
}

function volumePick(){
 card(
  `QUESTION VOLUME`,
  {up:"10 Q",left:"25 Q",right:"50 Q",down:"ALL"},
  dir=>{
    if(dir==="UP") VOLUME_LIMIT=10;
    if(dir==="LEFT") VOLUME_LIMIT=25;
    if(dir==="RIGHT") VOLUME_LIMIT=50;
    if(dir==="DOWN") VOLUME_LIMIT=null;
    startQuiz();
  }
 );
}

function startQuiz(){
 let base=RAW_DATA.filter(d=>d.set===ACTIVE_SET).sort(()=>Math.random()-.5);
 if(VOLUME_LIMIT) base=base.slice(0,VOLUME_LIMIT);
 POOL=base;
 WRONG=[]; SESSION_ALL=[]; REVIEW_INDEX=0; XP=0; ATTEMPTED = new Set();
 nextQ();
}

function nextQ(){
 UI.review.textContent=""; 
 if(!POOL.length){
    // === CLOSED LOOP GATEKEEPER ===
    // If WRONG array has items, loop them until empty.
    if(WRONG.length){ review(); return; }
    // Only proceed to Report if WRONG is empty.
    report(); return;
 }
 
 const d=POOL.shift();
 UI.id.textContent=d.id;
 if(!SESSION_ALL.includes(d)) SESSION_ALL.push(d); 

 // SHUFFLE ENGINE: Randomize options A/B/C to UP/LEFT/RIGHT
 const opts = [d.u, d.l, d.r].sort(() => Math.random() - 0.5);
 const map = { up: opts[0], left: opts[1], right: opts[2] };

 card(d.q, map, dir=>{
  let picked = null;
  if(dir==="UP") picked = map.up;
  if(dir==="LEFT") picked = map.left;
  if(dir==="RIGHT") picked = map.right;

  // SAFETY: Resolve "Correct" pointer if data uses directional keys
  let correctVal = d.correct;
  if(correctVal === "UP") correctVal = d.u;
  else if(correctVal === "LEFT") correctVal = d.l;
  else if(correctVal === "RIGHT" || correctVal === "R") correctVal = d.r;

  // CHECK ANSWER
  if(picked !== correctVal){
    WRONG.push(d); // Add to closed loop pile
  } else {
    // FIRST ATTEMPT SCORING: Only award point if ID not in ATTEMPTED
    if(!ATTEMPTED.has(d.id)){
        XP+=1; 
    }
  }
  
  // Track that we've seen this question
  ATTEMPTED.add(d.id);
  
  // Update HUD
  UI.xp.textContent=`${XP} / ${SESSION_ALL.length}`;
  UI.bar.style.width = ((SESSION_ALL.length - POOL.length) / SESSION_ALL.length) * 100 + "%";
  
  nextQ();
 });
}

/* ================= CLOSED LOOP REVIEW ================= */
function review(){
 if(!WRONG.length){ report(); return; } 
 const d=WRONG[REVIEW_INDEX];

 UI.review.innerHTML = chemText(d.logic || "Review this concept.");

 card(
  `HINT\n\n${d.hint || "Recall the definition."}`,
  {up:"RETRY", down:"SKIP"},
  dir=>{
    if(dir==="UP"){
        // === ACTION: RE-INSERT TO ACTIVE DECK ===
        WRONG.splice(REVIEW_INDEX,1); // Remove from 'Wrong' pile
        POOL.unshift(d); // Add to front of 'Active' pile
        
        // Reset index to prevent out-of-bounds
        if(REVIEW_INDEX >= WRONG.length) REVIEW_INDEX=0;
        
        // Go back to Quiz Mode (this will re-shuffle options)
        nextQ();
    }
    if(dir==="DOWN"){
        // Cycle to next wrong card
        REVIEW_INDEX=(REVIEW_INDEX+1)%WRONG.length;
        review();
    }
  }
 );
}

/* ================= 4-WAY REPORT CARD ================= */
function report(){
 UI.review.textContent=""; 
 card(
  `SESSION COMPLETE\n\nSCORE: ${XP} / ${SESSION_ALL.length}`,
  {down:"PDF", up:"RETRY", left:"MENU", right:"NEXT LVL"},
  dir=>{
    if(dir==="DOWN") exportSessionPDF();
    if(dir==="UP") startQuiz(); 
    if(dir==="LEFT") begin();
    if(dir==="RIGHT"){
        // FIND NEXT SET
        const sets=[...new Set(RAW_DATA.map(d=>d.set))];
        const curr = sets.indexOf(ACTIVE_SET);
        if(curr > -1 && curr < sets.length - 1){
            ACTIVE_SET = sets[curr+1];
            volumePick(); // Enter volume selection for next set
        } else {
            alert("All Sets Completed!");
            begin();
        }
    }
  }
 );
}

/* ================= PDF EXPORT ================= */
function exportSessionPDF(){
 if(!SESSION_ALL.length){alert("No session data");return;}
 const {jsPDF}=window.jspdf;const doc=new jsPDF();let y=20;
 
 const seen=new Set();
 const unique=SESSION_ALL.filter(q=>{
  if(seen.has(q.id)) return false;
  seen.add(q.id);return true;
 });

 unique.forEach((d,i)=>{
  if(y>260){doc.addPage();y=20;}
  doc.setFont("courier","bold");doc.text(`Q${i+1} | ${d.id}`,15,y);y+=8;
  doc.setFont("times","normal");
  doc.text(doc.splitTextToSize(d.q,180),15,y);y+=12;
  doc.text(`A) ${d.u}`,15,y);y+=5;
  doc.text(`B) ${d.l}`,15,y);y+=5;
  doc.text(`C) ${d.r}`,15,y);y+=5;
  doc.text(`ANSWER: ${d.correct}`,15,y);y+=10;
 });
 doc.save(`ALCHEMIST_SESSION_${Date.now()}.pdf`);
 setTimeout(begin,500);
}

/* ================= BOOTSTRAP ================= */
async function init(){
 try{USER_DATA=JSON.parse(localStorage.getItem(USER_KEY)||"[]");}catch{USER_DATA=[];}
 try{const r=await fetch(MASTER_URL);MASTER_DATA=await r.json();}catch{MASTER_DATA=[];}
 RAW_DATA=[...MASTER_DATA,...USER_DATA];
 begin();
}
init();
</script>
</body>
</html>
