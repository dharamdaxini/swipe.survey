<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Final Grey v136.36</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#000;
  --card:#121212;
  --border:#333;
  --gold:#d4af37;
  --grey:#888;

  --font-serif:'Crimson Text',serif;
  --font-sans:'Inter',sans-serif;
  --font-code:'JetBrains Mono',monospace;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

body{
  margin:0;height:100vh;background:var(--bg);color:#e0e0e0;
  font-family:var(--font-sans);overflow:hidden;
  display:flex;flex-direction:column;
}

#header{width:90%;margin:24px auto 0}
.header-meta{
  display:flex;justify-content:space-between;
  font-family:var(--font-code);
  font-size:.75rem;color:#666;letter-spacing:1.4px;
}

#review-text{
  margin-top:18px;
  min-height:3.2em;
  font-family:var(--font-serif);
  font-size:1.2rem;
  font-style:italic;
  text-align:center;
  color:#e0e0e0;
}

.progress-track{height:3px;background:#222;margin-top:12px}
#progress-bar{height:100%;background:var(--gold);width:0%;transition:.3s}

#stack{
  position:relative;
  width:90%;max-width:420px;height:62vh;
  margin:auto;perspective:1200px;
  display:flex;align-items:center;justify-content:center;
}

.card{
  position:absolute;width:100%;height:95%;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:34px;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 20px 60px rgba(0,0,0,.95);
}

.card-q{
  font-family:var(--font-serif);
  font-size:1.6rem;
  font-weight:600;
  line-height:1.45;
  text-align:center;
  color:#d0d0d0;
  pointer-events:none;
}

.card-q sub{font-size:.7em;vertical-align:-.3em}
.card-q sup{font-size:.7em;vertical-align:.5em}

.swipe-label{
  position:absolute;inset:0;
  display:flex;align-items:center;justify-content:center;
  background:#000;
  font-size:1.5rem;
  font-weight:700;
  letter-spacing:1px;
  color:var(--grey);
  opacity:0;
  pointer-events:none;
}
</style>
</head>

<body>

<div id="header">
  <div class="header-meta">
    <span id="id-ui">BOOT</span>
    <span id="xp-ui">0 XP</span>
  </div>
  <div id="review-text"></div>
  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack"></div>

<script>
/* ================= CONFIG ================= */
const MASTER_KEY = "ALCHEMIST_MASTER_V1";

/* ================= UTILS ================= */
const chem = t => String(t||"")
 .replace(/_([0-9]+)/g,"<sub>$1</sub>")
 .replace(/\^([0-9+\-]+)/g,"<sup>$1</sup>")
 .replace(/<->|↔️|\\rightleftharpoons/g,"⇌");

const shuffle=a=>{
 for(let i=a.length-1;i>0;i--){
  const j=Math.floor(Math.random()*(i+1));
  [a[i],a[j]]=[a[j],a[i]];
 }
 return a;
};

/* ================= STATE ================= */
let RAW=[];
let SETS=[];
let ACTIVE_SET=null;
let POOL=[],WRONG=[],SESSION=[];
let XP=0,VOLUME=null,REVIEW_I=0;
let ATTEMPTED=new Set();

/* ================= UI ================= */
const UI={
 stack:document.getElementById("stack"),
 id:document.getElementById("id-ui"),
 xp:document.getElementById("xp-ui"),
 bar:document.getElementById("progress-bar"),
 review:document.getElementById("review-text")
};

/* ================= NORMALIZE ================= */
function normalize(d){
 if(!d||!d.id||!d.q) return null;
 let c=d.correct;
 if(c==="UP"||c==="A")c=d.u;
 if(c==="LEFT"||c==="B")c=d.l;
 if(c==="RIGHT"||c==="C"||c==="R")c=d.r;
 return {
  id:String(d.id),
  set:d.set||"SET_A",
  q:d.q,u:d.u,l:d.l,r:d.r,
  correct:c||d.u,
  hint:d.hint||"",
  logic:d.logic||"",
  trap:d.trap||"",
  step1:d.step1||"",
  step2:d.step2||""
 };
}

/* ================= SWIPE ENGINE (FIXED) ================= */
class Swipe{
 constructor(el,cb){
  this.el=el;this.cb=cb;this.sx=0;this.sy=0;this.active=false;
  el.addEventListener("touchstart",e=>this.start(e.touches[0]),{passive:false});
  el.addEventListener("touchmove",e=>this.move(e.touches[0]),{passive:false});
  el.addEventListener("touchend",()=>this.end());
 }
 start(p){this.active=true;this.sx=p.clientX;this.sy=p.clientY;this.el.style.transition="none"}
 move(p){
  if(!this.active)return;
  const dx=p.clientX-this.sx,dy=p.clientY-this.sy;
  this.el.style.transform=`translate(${dx}px,${dy}px) rotate(${dx/25}deg)`;
 }
 end(){
  if(!this.active)return;this.active=false;
  const r=this.el.getBoundingClientRect();
  const dx=r.left+r.width/2-window.innerWidth/2;
  const dy=r.top+r.height/2-window.innerHeight/2;
  if(Math.hypot(dx,dy)>90)this.cb(dir(dx,dy));
  this.el.style.transition=".3s";
  this.el.style.transform="translate(0,0)";
 }
}
const dir=(dx,dy)=>{
 const a=(Math.atan2(-dy,dx)*180/Math.PI+360)%360;
 if(a>45&&a<135)return"UP";
 if(a>135&&a<225)return"LEFT";
 if(a>225&&a<315)return"DOWN";
 return"RIGHT";
};

/* ================= CARD ================= */
function card(text,labels,cb){
 UI.stack.innerHTML="";
 const el=document.createElement("div");
 el.className="card";
 el.innerHTML=`
  <div class="card-q">${chem(text).replace(/\n/g,"<br>")}</div>
  <div class="swipe-label">${labels.up||""}</div>
 `;
 UI.stack.appendChild(el);
 new Swipe(el,cb);
}

/* ================= FLOW ================= */
function begin(){
 card(`SESSION READY\n${RAW.length} Questions Loaded`,{up:"QUIZ"},d=>{
  if(d==="UP")pickSet();
 });
}

function pickSet(){
 SETS=[...new Set(RAW.map(d=>d.set))];
 let i=0;
 card(SETS[i],{up:"SELECT"},d=>{
  if(d==="UP"){ACTIVE_SET=SETS[i];pickVolume();}
 });
}

function pickVolume(){
 card("QUESTION VOLUME",{up:"10",left:"25",right:"50",down:"ALL"},d=>{
  if(d==="UP")VOLUME=10;
  if(d==="LEFT")VOLUME=25;
  if(d==="RIGHT")VOLUME=50;
  if(d==="DOWN")VOLUME=null;
  start();
 });
}

function start(){
 let base=shuffle(RAW.filter(d=>d.set===ACTIVE_SET));
 if(VOLUME)base=base.slice(0,VOLUME);
 POOL=base;WRONG=[];SESSION=[];XP=0;ATTEMPTED.clear();
 next();
}

function next(){
 UI.review.textContent="";
 if(!POOL.length){WRONG.length?review():report();return;}
 const d=POOL.shift();
 SESSION.push(d);UI.id.textContent=d.id;
 const opts=shuffle([d.u,d.l,d.r]);
 card(d.q,{up:opts[0]},dir=>{
  const pick=opts[dir==="UP"?0:1]||"";
  if(pick.toLowerCase()!==d.correct.toLowerCase())WRONG.push(d);
  else if(!ATTEMPTED.has(d.id))XP++;
  ATTEMPTED.add(d.id);
  UI.xp.textContent=`${XP} / ${SESSION.length}`;
  UI.bar.style.width=(SESSION.length/(SESSION.length+POOL.length))*100+"%";
  next();
 });
}

function review(){
 const d=WRONG[REVIEW_I];
 UI.review.textContent=`HINT: ${d.hint||"Recall basics"}`;
 card(`REVIEW\n\n${d.logic||""}`,{up:"RETRY"},dir=>{
  if(dir==="UP"){WRONG.splice(REVIEW_I,1);POOL.unshift(d);next();}
 });
}

function report(){
 card(`SUMMARY\n\n${XP}/${SESSION.length}`,{up:"RESTART"},()=>begin());
}

/* ================= INIT (LOCAL-FIRST HARD STOP) ================= */
(function init(){
 let raw;
 try{raw=JSON.parse(localStorage.getItem(MASTER_KEY)||"[]");}catch{raw=[];}
 RAW=raw.map(normalize).filter(Boolean);
 begin();
})();
</script>
</body>
</html>
