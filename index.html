<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Final Grey v136.18</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#000; --card:#121212; --border:#333;
  --gold:#d4af37;
  --option-grey:#888;
  --font-serif:'Crimson Text',serif;
  --font-sans:'Inter',sans-serif;
  --font-code:'JetBrains Mono',monospace;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
  margin:0;height:100vh;background:var(--bg);
  color:#e0e0e0;font-family:var(--font-sans);
  overflow:hidden;display:flex;flex-direction:column;
}
#header{width:90%;margin:25px auto 0;z-index:100}
.header-meta{
  display:flex;justify-content:space-between;
  font-family:var(--font-code);font-size:.75rem;
  color:#666;letter-spacing:1.5px;text-transform:uppercase;
}
#review-text{
  margin-top:20px;font-family:var(--font-serif);
  font-size:1.2rem;line-height:1.4;font-style:italic;
  text-align:center;color:#e0e0e0;min-height:3.5em;
  display:flex;align-items:flex-end;justify-content:center;
}
.progress-track{width:100%;height:3px;background:#222;margin-top:15px}
#progress-bar{height:100%;background:var(--gold);width:0%;transition:.4s}
#stack{
  position:relative;width:90%;max-width:420px;height:62vh;
  margin:auto;perspective:1500px;
  display:flex;align-items:center;justify-content:center;
}
.card{
  position:absolute;width:100%;height:95%;
  background:var(--card);border-radius:12px;
  border:1px solid var(--border);padding:35px;
  display:flex;flex-direction:column;justify-content:center;
}
.card-q{
  font-family:var(--font-serif);font-size:1.7rem;
  line-height:1.4;font-weight:600;text-align:center;
  color:#d0d0d0;
}
.swipe-label{
  position:absolute;inset:0;display:flex;
  align-items:center;justify-content:center;
  background:#000;font-weight:700;font-size:1.5rem;
  opacity:0;pointer-events:none;
  color:var(--option-grey);border:1px solid #333;
}
</style>
</head>
<body>

<div id="header">
  <div class="header-meta">
    <span id="id-ui">BOOT</span>
    <span id="xp-ui">0 XP</span>
  </div>
  <div id="review-text"></div>
  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack">
  <div class="card">
    <div class="card-q" style="font-family:var(--font-code);font-size:.9rem;color:#666">
      VIA.STACK | FINAL<br>INITIALIZING SYSTEM...
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const MASTER_KEY = "ALCHEMIST_MASTER_V1";

/* ================= STATE ================= */
let RAW_DATA=[];
let POOL=[],WRONG=[],SESSION_ALL=[];
let ACTIVE_SET=null,SET_CURSOR=0,VOLUME_LIMIT=null;
let XP=0,ATTEMPTED=new Set();

/* ================= UTILS ================= */
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function chemText(t){return t||""}

/* ================= LOAD MASTER (FIXED) ================= */
function loadMasterStrict(){
  const local = localStorage.getItem(MASTER_KEY);
  if(!local){
    alert("MASTER VAULT EMPTY.\nUpload via Admin Panel first.");
    return [];
  }
  try{
    const parsed = JSON.parse(local);
    return Array.isArray(parsed) ? parsed : [];
  }catch{
    alert("MASTER DATA CORRUPTED.");
    return [];
  }
}

/* ================= INIT ================= */
function init(){
  RAW_DATA = loadMasterStrict();   // ðŸ”’ ONLY SOURCE
  begin();
}

/* ================= UI CORE ================= */
const UI={
 stack:document.getElementById("stack"),
 id:document.getElementById("id-ui"),
 xp:document.getElementById("xp-ui"),
 bar:document.getElementById("progress-bar"),
 review:document.getElementById("review-text")
};

function card(text,labels,cb){
 UI.stack.innerHTML="";
 const el=document.createElement("div");
 el.className="card";
 el.innerHTML=`
  <div class="card-q">${chemText(text)}</div>
  <div class="swipe-label sl-up">${labels.up||""}</div>
  <div class="swipe-label sl-left">${labels.left||""}</div>
  <div class="swipe-label sl-right">${labels.right||""}</div>
  <div class="swipe-label sl-down">${labels.down||""}</div>`;
 UI.stack.appendChild(el);
 el.onclick=()=>cb("UP");
}

/* ================= FLOW ================= */
function begin(){
 UI.review.textContent="";
 card("BEGIN SESSION",{up:"QUIZ"},()=>setPick());
}

function setPick(){
 const sets=[...new Set(RAW_DATA.map(d=>d.set))];
 ACTIVE_SET=sets[0];
 volumePick();
}

function volumePick(){
 VOLUME_LIMIT=null;
 startQuiz();
}

function startQuiz(){
 POOL=shuffle(RAW_DATA.filter(d=>d.set===ACTIVE_SET));
 WRONG=[];SESSION_ALL=[];XP=0;ATTEMPTED.clear();
 nextQ();
}

function nextQ(){
 if(!POOL.length){report();return}
 const d=POOL.shift();
 SESSION_ALL.push(d);
 UI.id.textContent=d.id;
 card(d.q,{up:d.u,left:d.l,right:d.r},()=>{
   XP++;
   UI.xp.textContent=`${XP}`;
   nextQ();
 });
}

function report(){
 card(`DONE\n${XP} / ${SESSION_ALL.length}`,{up:"RESTART"},begin);
}

/* ================= START ================= */
init();
</script>
</body>
</html>
