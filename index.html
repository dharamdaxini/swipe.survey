<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Final v137.9</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<style>
/* === UI / UX UNCHANGED === */
:root{
  --bg:#000; --card:#0a0a0a; --border:#222;
  --gold:#ffd600; --green:#2ecc71;
  --font-serif:'Crimson Text',serif;
  --font-sans:'Inter',sans-serif;
  --font-code:'JetBrains Mono',monospace;
}
*{box-sizing:border-box}
body{margin:0;height:100vh;background:#000;color:#fff;font-family:var(--font-sans)}
</style>
</head>
<body>

<script>
/* ======================================================
   CORE PATCH: STEP-2 SAFE PARSER (NO UI TOUCH)
   ====================================================== */

function parseVaultText(text){
  const lines = text.split(/\n+/).map(l=>l.trim()).filter(Boolean);
  const out = [];
  let cur = null;

  const flush = ()=>{
    if(cur && cur.u && cur.l && cur.r){
      if(!cur.correct) cur.correct="UP";
      if(!cur.step1) cur.step1="—";
      if(!cur.step2) cur.step2="—";
      delete cur._exec;
      out.push(cur);
    }
    cur=null;
  };

  for(const l of lines){

    const isHeader = /^Q\d+/.test(l) || /^\d+\s*\/\//.test(l);
    if(isHeader){
      flush();
      let id="000",dom="GENERAL",topic="CONCEPTS";
      if(l.includes("//")){
        id=l.split("//")[0].trim();
        const m=l.split("//")[1].split(">");
        if(m[0]) dom=m[0].trim();
        if(m[1]) topic=m[1].trim();
      }
      cur={id,dom,topic,q:"",u:"",l:"",r:"",logic:"",trap:"",step1:"",step2:"",_exec:0};
      continue;
    }

    if(!cur) continue;

    /* OPTIONS */
    if(l.startsWith("A)")){cur.u=l.slice(2).trim();continue;}
    if(l.startsWith("B)")){cur.l=l.slice(2).trim();continue;}
    if(l.startsWith("C)")){cur.r=l.slice(2).trim();continue;}

    /* ANSWER / LOGIC */
    if(l.startsWith("ANSWER:")){cur.correct=l.replace("ANSWER:","").trim();continue;}
    if(l.startsWith("LOGIC:")){cur.logic+=l.replace("LOGIC:","").trim()+" ";continue;}
    if(l.startsWith("DISTRACTOR ANALYSIS:")){cur.trap=l.replace("DISTRACTOR ANALYSIS:","").trim();continue;}

    /* ===== EXECUTION LOCK ===== */
    if(l.startsWith("1.")){
      cur._exec=1;
      cur.step1=l.replace(/^1\.\s*/,"").trim();
      continue;
    }
    if(l.startsWith("2.")){
      cur._exec=2;
      cur.step2=l.replace(/^2\.\s*/,"").trim();
      continue;
    }

    /* CONTINUATION LINES */
    if(cur._exec===1){
      cur.step1+=" "+l;
      continue;
    }
    if(cur._exec===2){
      cur.step2+=" "+l;
      continue;
    }

    /* QUESTION BODY */
    if(!cur.u){
      cur.q+=l+" ";
      continue;
    }
  }

  flush();
  return out;
}

/* ======================================================
   SUPPORT PDF — STEP-2 NOW ALWAYS PRESENT
   ====================================================== */
function renderSupportPDF(data){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  let y=20;
  const ML=15,W=180;
  const COL_W={OPT:45,LOG:65,EXE:65};
  const COL_X={OPT:ML,LOG:ML+50,EXE:ML+120};

  const clean=t=>String(t||"").replace(/<[^>]*>/g,"").trim();

  const header=()=>{
    doc.setFont("times","bold").setFontSize(16);
    doc.text("ALCHEMIST // ACADEMY REPORT",105,15,{align:"center"});
    doc.line(ML,18,195,18);doc.line(ML,19,195,19);
    y=25;
  };
  header();

  data.forEach(d=>{
    if(y>230){doc.addPage();header();}
    doc.setFont("helvetica","bold").setFontSize(8);
    doc.text(`${d.id} // ${d.dom} > ${d.topic}`,ML,y);y+=6;

    doc.setFont("times","bold").setFontSize(12);
    const q=doc.splitTextToSize(clean(d.q),W);
    doc.text(q,ML,y);y+=q.length*5+4;

    doc.line(ML,y,195,y);y+=6;

    doc.setFont("helvetica","bold").setFontSize(7);
    doc.text("OPTIONS",COL_X.OPT,y);
    doc.text("THEORY & LOGIC",COL_X.LOG,y);
    doc.text("EXECUTION",COL_X.EXE,y);
    y+=5;

    const base=y;let max=y;

    doc.setFont("helvetica","normal").setFontSize(9);
    let oy=base;
    ["u","l","r"].forEach((k,i)=>{
      const t=doc.splitTextToSize(`(${String.fromCharCode(65+i)}) ${clean(d[k])}`,COL_W.OPT);
      doc.text(t,COL_X.OPT,oy);oy+=t.length*4+2;
    });
    max=Math.max(max,oy);

    doc.setFont("times","italic");
    const lg=doc.splitTextToSize(clean(d.logic),COL_W.LOG);
    doc.text(lg,COL_X.LOG,base);
    max=Math.max(max,base+lg.length*4);

    doc.setFont("helvetica","normal");
    const s1=doc.splitTextToSize(`1. ${clean(d.step1)}`,COL_W.EXE);
    const s2=doc.splitTextToSize(`2. ${clean(d.step2)}`,COL_W.EXE);
    let ey=base;
    doc.text(s1,COL_X.EXE,ey);ey+=s1.length*4+2;
    doc.text(s2,COL_X.EXE,ey);ey+=s2.length*4;
    max=Math.max(max,ey);

    y=max+10;
  });

  doc.save(`SUPPORT_PDF_${Date.now()}.pdf`);
}
</script>

</body>
</html>
