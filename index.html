<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Treatment Survey</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  position: fixed;
  background: #e8e8e8;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  touch-action: none;
  overscroll-behavior: none;
}

#app {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  pointer-events: none;
}

.card {
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
  width: 100%;
  max-width: 480px;
  min-height: 420px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 48px 32px;
  pointer-events: auto;
  touch-action: none;
  position: relative;
}

.question-text {
  font-size: 22px;
  font-weight: 500;
  color: #2c2c2c;
  line-height: 1.5;
  text-align: center;
  margin-bottom: 32px;
  max-width: 380px;
}

.instruction {
  font-size: 14px;
  color: #7a7a7a;
  margin-bottom: 24px;
  text-align: center;
}

.swipe-legend {
  font-size: 13px;
  color: #9a9a9a;
  line-height: 1.6;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

.status-message {
  position: absolute;
  bottom: 32px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 18px;
  font-weight: 500;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
}

.status-message.visible {
  opacity: 1;
}

.status-message.success {
  color: #4a4a4a;
}

.status-message.error {
  color: #d32f2f;
}

.hidden {
  display: none !important;
}

@media (max-width: 480px) {
  .card {
    padding: 40px 28px;
    min-height: 400px;
  }
  
  .question-text {
    font-size: 20px;
    margin-bottom: 28px;
  }
  
  .swipe-legend {
    font-size: 12px;
  }
}

@media (max-height: 600px) {
  .card {
    min-height: 360px;
    padding: 36px 28px;
  }
  
  .question-text {
    font-size: 19px;
    margin-bottom: 24px;
  }
}
</style>
</head>
<body>
<div id="app">
  <div id="card" class="card">
    <div id="questionText" class="question-text"></div>
    <div id="instruction" class="instruction">Swipe to answer</div>
    <div id="swipeLegend" class="swipe-legend"></div>
    <div id="statusMessage" class="status-message"></div>
  </div>
</div>

<script>
// Configuration: Replace with your Google Apps Script Web App URL
const SHEET_ENDPOINT = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLimFevoV-XE526BcK3TkkMf7Ntmi_dGukllGhr_nEwBfJVaLJKRlCug-ZxE5rb1GDqTY-B1myvXNl7Sngx6XsJFFSZkz3oVEz_FwW01fR-KnEZ4QwMNZdyS9gLVMECA9FPvF8qR9IWAlHED_qZxwSSdn0fD6TOQHmaV3i-JQOLU86oN6KvIvTodjLEhn8P5g-8s8F38i6lhKeo8V5b3Zuhd4K7TStzBvi43sBFZZGeq01gthGm4J3e2Kl29exuVEIdqN5u5rmyltNo6RvKOW9iZpDlFVMzGuos06JTg&lib=MUqFmX3xhxFDzBtrCsRU7H_m8FswXrvlL";

// Survey state machine
const STATE = {
  current: 'Q1',
  q1Answer: null,
  q1Direction: null,
  completed: false
};

// Question configurations
const QUESTIONS = {
  Q1: {
    text: 'How has your condition changed since starting treatment?',
    legend: '↑ Slight improvement   → Moderate improvement   ↓ Major improvement   ← No noticeable change',
    mapping: {
      up: 'Slight improvement',
      right: 'Moderate improvement',
      down: 'Major improvement',
      left: 'No noticeable change'
    }
  },
  Q2: {
    text: 'How much did it improve?',
    legend: '↑ Slight   → Moderate   ↓ Major   ← Prefer not to say',
    mapping: {
      up: 'Slight',
      right: 'Moderate',
      down: 'Major',
      left: 'Prefer not to say'
    }
  }
};

// DOM elements
const card = document.getElementById('card');
const questionText = document.getElementById('questionText');
const instruction = document.getElementById('instruction');
const swipeLegend = document.getElementById('swipeLegend');
const statusMessage = document.getElementById('statusMessage');

// Touch tracking
let touchStartX = 0;
let touchStartY = 0;
let touchEndX = 0;
let touchEndY = 0;

// Initialize survey
function init() {
  renderQuestion('Q1');
  attachSwipeListeners();
}

// Attach swipe event listeners to card
function attachSwipeListeners() {
  card.addEventListener('touchstart', handleTouchStart, { passive: true });
  card.addEventListener('touchend', handleTouchEnd, { passive: true });
}

// Handle touch start
function handleTouchStart(e) {
  if (STATE.completed) return;
  
  touchStartX = e.changedTouches[0].screenX;
  touchStartY = e.changedTouches[0].screenY;
}

// Handle touch end
function handleTouchEnd(e) {
  if (STATE.completed) return;
  
  touchEndX = e.changedTouches[0].screenX;
  touchEndY = e.changedTouches[0].screenY;
  
  const direction = detectSwipeDirection();
  if (direction) {
    handleSwipe(direction);
  }
}

// Detect swipe direction based on touch delta
function detectSwipeDirection() {
  const deltaX = touchEndX - touchStartX;
  const deltaY = touchEndY - touchStartY;
  const absDeltaX = Math.abs(deltaX);
  const absDeltaY = Math.abs(deltaY);
  
  const THRESHOLD = 50;
  
  // Insufficient movement
  if (absDeltaX < THRESHOLD && absDeltaY < THRESHOLD) {
    return null;
  }
  
  // Determine primary direction
  if (absDeltaX > absDeltaY) {
    return deltaX > 0 ? 'right' : 'left';
  } else {
    return deltaY < 0 ? 'up' : 'down';
  }
}

// Handle swipe action
function handleSwipe(direction) {
  const currentQuestion = QUESTIONS[STATE.current];
  const answer = currentQuestion.mapping[direction];
  
  if (!answer) return;
  
  if (STATE.current === 'Q1') {
    // Store Q1 response
    STATE.q1Answer = answer;
    STATE.q1Direction = direction;
    
    // Log Q1 to Google Sheets
    logResponse('Q1', answer, direction);
    
    // Determine next state
    if (direction === 'left') {
      // Skip Q2 if "No noticeable change"
      showFinalState();
    } else {
      // Show Q2
      STATE.current = 'Q2';
      renderQuestion('Q2');
    }
    
  } else if (STATE.current === 'Q2') {
    // Log Q2 to Google Sheets
    logResponse('Q2', answer, direction);
    
    // Show final state
    showFinalState();
  }
}

// Render question to UI
function renderQuestion(questionId) {
  const question = QUESTIONS[questionId];
  questionText.textContent = question.text;
  swipeLegend.textContent = question.legend;
  instruction.classList.remove('hidden');
  swipeLegend.classList.remove('hidden');
  statusMessage.classList.remove('visible');
}

// Show final thank you state
function showFinalState() {
  STATE.completed = true;
  STATE.current = 'DONE';
  
  questionText.textContent = '';
  instruction.classList.add('hidden');
  swipeLegend.classList.add('hidden');
  
  statusMessage.textContent = 'Saved. Thank you.';
  statusMessage.classList.add('success');
  statusMessage.classList.remove('error');
  statusMessage.classList.add('visible');
}

// Show error state
function showErrorState() {
  statusMessage.textContent = 'Not saved';
  statusMessage.classList.add('error');
  statusMessage.classList.remove('success');
  statusMessage.classList.add('visible');
  
  // Hide error after 3 seconds
  setTimeout(() => {
    statusMessage.classList.remove('visible');
  }, 3000);
}

// Log response to Google Sheets
function logResponse(questionId, answerText, swipeDirection) {
  const payload = {
    timestamp: new Date().toISOString(),
    question_id: questionId,
    answer_text: answerText,
    swipe_direction: swipeDirection
  };
  
  // Send to Google Apps Script endpoint
  fetch(SHEET_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(() => {
    console.log('Response logged:', payload);
  })
  .catch(err => {
    console.error('Failed to log response:', err);
    
    // Only show error if this is the final submission
    if (STATE.current === 'DONE') {
      showErrorState();
    }
  });
}

// Start survey on page load
init();
</script>
</body>
</html>
