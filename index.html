<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Kinetic Loop v136.57</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#000000; 
  --card:#0a0a0a; 
  --border:#222;
  --gold:#ffd600; 
  --green:#2ecc71;
  --text-white: #ffffff;
  --text-grey: #888888;
  
  --font-serif: 'Crimson Text', serif;
  --font-sans: 'Inter', sans-serif;
  --font-code: 'JetBrains Mono', monospace;
}

*{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}

body{
  margin:0; height:100vh; background:var(--bg);
  color:var(--text-white); font-family:var(--font-sans);
  overflow:hidden; display:flex; flex-direction:column;
}

/* HEADER */
#header{ width:90%; margin:25px auto 0; z-index:100; flex-shrink: 0; }
.header-meta{
  display:flex; justify-content:space-between;
  font-family:var(--font-code); font-size:0.75rem; 
  color:#666; letter-spacing:1.5px; text-transform:uppercase;
  margin-bottom: 10px;
}

/* PROGRESS BAR */
.progress-track{ width:100%; height:3px; background:#222; border-radius:2px; margin-top: 5px; }
#progress-bar{ height:100%; background:var(--gold); width:0%; transition:width 0.4s ease; border-radius:2px; }

/* KINETIC LOGGER */
#kinetic-logger {
  width: 90%; margin: 0 auto 10px;
  font-family: var(--font-code); font-size: 0.75rem;
  color: #444; line-height: 1.4;
  text-transform: uppercase;
  min-height: 50px; 
  display: flex; flex-direction: column; justify-content: flex-end;
  pointer-events: none;
}
.log-line { opacity: 0.4; transition: opacity 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.log-line.active { color: var(--green); opacity: 1; font-weight: 700; }
.log-line.primary { color: var(--gold); opacity: 1; font-weight: 700; }
.log-line.error { color: #ff4444; opacity: 1; font-weight: 700; }

/* STACK */
#stack{
  position:relative; width:90%; max-width:420px; 
  height: calc(100vh - 180px - env(safe-area-inset-bottom)); 
  margin: 10px auto 20px; 
  perspective:1500px;
  display:flex; align-items:center; justify-content:center;
}

.card{
  position:absolute; width:100%; height:100%;
  background:var(--card); 
  border-radius:14px; 
  border:1px solid var(--border);
  padding:35px; 
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.95);
  will-change:transform; transform-style:preserve-3d;
  overflow: hidden; 
}

.card-q{
  font-family:var(--font-serif);
  font-size: clamp(1.4rem, 5vw, 1.9rem); 
  line-height:1.4;
  font-weight:600; text-align:center;
  color: var(--text-white); 
  width: 100%;
}

.swipe-label{
  position:absolute; inset:0; 
  display:flex; align-items:center; justify-content:center;
  background:#000; 
  font-family:var(--font-sans); 
  font-weight:900; 
  font-size:1.8rem; 
  text-transform:uppercase; 
  letter-spacing:1px;
  opacity:0; pointer-events:none; 
  transition:opacity 0.15s ease;
  border-radius:14px;
  color: var(--text-grey); 
  border: 1px solid #333;
}
</style>
</head>
<body>

<div id="header">
  <div class="header-meta">
    <span style="color:#666; font-weight:700;">VIA.STACK</span> 
    <span id="xp-ui">0 XP</span>
  </div>

  <div id="kinetic-logger">
    <div class="log-line" id="log-1"></div>
    <div class="log-line" id="log-2"></div>
    <div class="log-line active" id="log-3">> SYSTEM BOOT</div>
  </div>

  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack">
  <div class="card">
    <div class="card-q" style="font-family:var(--font-code); font-size:0.9rem; color:#666;">
      INITIALIZING...
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const MASTER_KEY = "ALCHEMIST_MASTER_V1"; 

/* ================= STATE ================= */
let RAW_DATA = [];
let SET_CURSOR = 0; 
let ACTIVE_SET = null;
let POOL = [], WRONG = [], XP = 0;
let SESSION_ALL = [], VOLUME_LIMIT = null;
let ATTEMPTED = new Set(); 
let REVIEW_INDEX = 0;

/* ================= LOGGER ================= */
function log(msg, type="normal") {
  const l1 = log-1, l2 = log-2, l3 = log-3;
  log-1.innerText = log-2.innerText;
  log-2.innerText = log-3.innerText;
  log-3.innerText = `> ${msg}`;
}

/* ================= UTILS ================= */
const chemText = t => String(t||"");
const shuffle = a => { for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; };

/* ================= UI ================= */
const UI = {
  stack: document.getElementById("stack"),
  xp: document.getElementById("xp-ui"),
  bar: document.getElementById("progress-bar")
};

/* ================= PHYSICS ENGINE (UNCHANGED) ================= */
class PhysicsController{
 constructor(el,cbs){
  this.el=el;this.cbs=cbs;this.active=false;this.start={x:0,y:0};
  const s=e=>this.startDrag(e.touches?e.touches[0]:e);
  const m=e=>this.move(e.touches?e.touches[0]:e);
  const e2=()=>this.end();
  el.addEventListener("mousedown",s);
  window.addEventListener("mousemove",m);
  window.addEventListener("mouseup",e2);
  el.addEventListener("touchstart",s,{passive:true});
  el.addEventListener("touchmove",ev=>{if(this.active)ev.preventDefault();m(ev)},{passive:false});
  el.addEventListener("touchend",e2);
 }
 startDrag(p){this.active=true;this.start={x:p.clientX,y:p.clientY};}
 move(p){}
 end(){ if(this.active){ this.active=false; this.cbs.onCommit("UP"); } }
}

/* ================= CARD ================= */
function card(text, labels, cb){
  UI.stack.innerHTML="";
  const el=document.createElement("div");
  el.className="card";
  el.innerHTML=`
    <div class="card-q">${chemText(text).replace(/\n/g,"<br>")}</div>
    <div class="swipe-label sl-up">${labels.up||""}</div>
    <div class="swipe-label sl-down">${labels.down||""}</div>
  `;
  UI.stack.appendChild(el);
  new PhysicsController(el,{onCommit:cb});
}

/* ================= LOOP 1 ================= */
function nextQ(){
  if(!POOL.length){
    if(WRONG.length){ REVIEW_INDEX=0; review(); }
    else report();
    return;
  }
  const d=POOL.shift();
  SESSION_ALL.push(d);
  card(d.q,{up:d.u,down:d.l},()=>nextQ());
}

/* ================= LOOP 2 (FIXED) ================= */
function review(){
  if(WRONG.length===0){ nextQ(); return; }

  if(REVIEW_INDEX >= WRONG.length) REVIEW_INDEX = 0;
  const d = WRONG[REVIEW_INDEX];

  card(
    `REVIEW\n\n${d.logic || "Review the core principles."}`,
    {up:"RETRY", down:"SKIP"},
    dir=>{
      if(dir==="UP"){
        WRONG.splice(REVIEW_INDEX,1);
        POOL.unshift(d);
        nextQ();              // âœ… EXIT REVIEW LOOP
      } else {
        REVIEW_INDEX = (REVIEW_INDEX + 1) % WRONG.length;
        review();             // ðŸ” STAY IN LOOP 2
      }
    }
  );
}

/* ================= REPORT ================= */
function report(){
  card(`SUMMARY\n\n${XP} / ${SESSION_ALL.length}`,{up:"RESTART"},()=>location.reload());
}

/* ================= BOOT ================= */
RAW_DATA=[{id:1,set:"A",q:"Demo Question",u:"Yes",l:"No",r:"Maybe",correct:"Yes",logic:"Demo logic"}];
POOL=[...RAW_DATA];
nextQ();
</script>
</body>
</html>
