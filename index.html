<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Kinetic Loop v136.57</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#000000; 
  --card:#0a0a0a; 
  --border:#222;
  --gold:#ffd600; 
  --green:#2ecc71;
  --text-white: #ffffff;
  --text-grey: #888888;
  
  --font-serif: 'Crimson Text', serif;
  --font-sans: 'Inter', sans-serif;
  --font-code: 'JetBrains Mono', monospace;
}

*{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}

body{
  margin:0; height:100vh; background:var(--bg);
  color:var(--text-white); font-family:var(--font-sans);
  overflow:hidden; display:flex; flex-direction:column;
}

/* HEADER */
#header{ width:90%; margin:25px auto 0; z-index:100; flex-shrink: 0; }
.header-meta{
  display:flex; justify-content:space-between;
  font-family:var(--font-code); font-size:0.75rem; 
  color:#666; letter-spacing:1.5px; text-transform:uppercase;
  margin-bottom: 10px;
}

/* PROGRESS BAR */
.progress-track{ width:100%; height:3px; background:#222; border-radius:2px; margin-top: 5px; }
#progress-bar{ height:100%; background:var(--gold); width:0%; transition:width 0.4s ease; border-radius:2px; }

/* KINETIC LOGGER (v130.73 Style) */
#kinetic-logger {
  width: 90%; margin: 0 auto 10px;
  font-family: var(--font-code); font-size: 0.75rem;
  color: #444; line-height: 1.4;
  text-transform: uppercase;
  min-height: 50px; 
  display: flex; flex-direction: column; justify-content: flex-end;
  pointer-events: none;
}
.log-line { opacity: 0.4; transition: opacity 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.log-line.active { color: var(--green); opacity: 1; font-weight: 700; }
.log-line.primary { color: var(--gold); opacity: 1; font-weight: 700; }
.log-line.error { color: #ff4444; opacity: 1; font-weight: 700; }

/* FLUID STACK ENGINE */
#stack{
  position:relative; width:90%; max-width:420px; 
  /* Calc: 100vh - Header/Logger Space - Safe Area */
  height: calc(100vh - 180px - env(safe-area-inset-bottom)); 
  margin: 10px auto 20px; 
  perspective:1500px;
  display:flex; align-items:center; justify-content:center;
}

.card{
  position:absolute; width:100%; height:100%;
  background:var(--card); 
  border-radius:14px; 
  border:1px solid var(--border);
  padding:35px; 
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.95);
  will-change:transform; transform-style:preserve-3d;
  overflow: hidden; 
}

/* MAIN TEXT - DIAMOND UI (White) */
.card-q{
  font-family:var(--font-serif);
  font-size: clamp(1.4rem, 5vw, 1.9rem); 
  line-height:1.4;
  font-weight:600; text-align:center;
  color: var(--text-white); 
  
  width: 100%;
  max-height: 100%;
  overflow-y: auto; 
  word-wrap: break-word;
  padding: 0 5px; 
  
  display: flex; 
  flex-direction: column;
  justify-content: center;
}

/* SCROLLBAR HIDDEN */
.card-q::-webkit-scrollbar { width: 0px; }

.card-q sub{ font-size:0.7em; vertical-align:-0.3em; }
.card-q sup{ font-size:0.7em; vertical-align:0.5em; }

/* OG SWIPE LABELS - CENTERED OVERLAY (Grey) */
.swipe-label{
  position:absolute; inset:0; 
  display:flex; align-items:center; justify-content:center;
  background:#000; 
  font-family:var(--font-sans); 
  font-weight:900; 
  font-size:1.8rem; 
  text-transform:uppercase; 
  letter-spacing:1px;
  text-align:center; padding:40px;
  opacity:0; pointer-events:none; 
  transition:opacity 0.15s ease;
  border-radius:14px;
  color: var(--text-grey); 
  border: 1px solid #333;
}

</style>
</head>
<body>

<div id="header">
  <div class="header-meta">
    <span style="color:#666; font-weight:700;">VIA.STACK</span> 
    <span id="xp-ui">0 XP</span>
  </div>
  
  <div id="kinetic-logger">
    <div class="log-line" id="log-1"></div>
    <div class="log-line" id="log-2"></div>
    <div class="log-line active" id="log-3">> SYSTEM BOOT</div>
  </div>

  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack">
  <div class="card">
    <div class="card-q" style="font-family:var(--font-code); font-size:0.9rem; color:#666; font-style:normal;">
      INITIALIZING...
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const MASTER_KEY = "ALCHEMIST_MASTER_V1"; 

/* ================= STATE ================= */
let RAW_DATA = [];
let SET_CURSOR = 0; 
let ACTIVE_SET = null;
let POOL = [], WRONG = [], XP = 0;
let SESSION_ALL = [], VOLUME_LIMIT = null;
let ATTEMPTED = new Set(); 
let REVIEW_INDEX = 0; // State for Circular Review

/* ================= LOGGER ENGINE ================= */
function log(msg, type="normal") {
    const l1 = document.getElementById("log-1");
    const l2 = document.getElementById("log-2");
    const l3 = document.getElementById("log-3");
    
    l1.innerText = l2.innerText; l1.className = l2.className;
    l2.innerText = l3.innerText; l2.className = "log-line"; 
    
    l3.innerText = `> ${msg}`;
    l3.className = `log-line ${type}`;
}

/* ================= UTILS ================= */
const chemText = t => String(t||"").replace(/_(\d+)/g,"<sub>$1</sub>").replace(/\^([0-9+\-]+)/g,"<sup>$1</sup>").replace(/<->|↔|\\rightleftharpoons/g,"⇌");
const cleanPDF = t => String(t||"").replace(/<[^>]*>/g, "").replace(/&Delta;/g, "Δ");
const shuffle = a => { for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; };

/* ================= UI ================= */
const UI = {
  stack: document.getElementById("stack"),
  xp: document.getElementById("xp-ui"),
  bar: document.getElementById("progress-bar")
};

/* ================= PHYSICS ENGINE (Optimized) ================= */
class PhysicsController{
 constructor(el,cbs){
  this.el=el;this.cbs=cbs;this.active=false;this.start={x:0,y:0};
  this.labels={
    UP:el.querySelector(".sl-up"),
    LEFT:el.querySelector(".sl-left"),
    RIGHT:el.querySelector(".sl-right"),
    DOWN:el.querySelector(".sl-down")
  };
  const s=e=>this.startDrag(e.touches?e.touches[0]:e);
  const m=e=>this.move(e.touches?e.touches[0]:e);
  const e2=()=>this.end();
  el.addEventListener("mousedown",s); 
  window.addEventListener("mousemove",m); 
  window.addEventListener("mouseup",e2);
  
  // UPGRADE: Passive listener for performance
  el.addEventListener("touchstart",s,{passive:true}); 
  el.addEventListener("touchmove",ev=>{if(this.active)ev.preventDefault();m(ev)},{passive:false}); 
  el.addEventListener("touchend",e2);
 }
 startDrag(p){this.active=true;this.start={x:p.clientX,y:p.clientY};this.el.style.transition="none"}
 move(p){
  if(!this.active)return;
  const dx=p.clientX-this.start.x,dy=p.clientY-this.start.y;
  const d=Math.hypot(dx,dy);
  this.el.style.transform=`translate(${dx}px,${dy}px) rotate(${dx/25}deg)`;
  
  // Center Label Visibility Logic
  Object.values(this.labels).forEach(l=>l&&(l.style.opacity=0));
  if(d>20){
    const dir=this.dir(dx,dy);
    this.labels[dir]&&(this.labels[dir].style.opacity=Math.min(d/50,1));
  }
 }
 end(){
  if(!this.active)return;this.active=false;
  const m=new WebKitCSSMatrix(getComputedStyle(this.el).transform);
  const dx=m.m41,dy=m.m42;
  if(Math.hypot(dx,dy)>100)this.cbs.onCommit(this.dir(dx,dy));
  else{this.el.style.transition=".4s cubic-bezier(0.2, 0.8, 0.2, 1)";this.el.style.transform="translate(0,0)"}
 }
 dir(dx,dy){
  const a=(Math.atan2(-dy,dx)*180/Math.PI+360)%360;
  if(a>45&&a<135)return"UP";
  if(a>135&&a<225)return"LEFT";
  if(a>225&&a<315)return"DOWN";
  return"RIGHT";
 }
}

/* ================= CORE LOOP PROTOCOL ================= */

// 1. BOOT (Hybrid + No-Cache)
async function init() {
    log("SYSTEM CHECK...", "primary");
    const local = localStorage.getItem(MASTER_KEY);
    
    // Bridge Check
    if(local && local.length > 10){
        try { 
            const data = JSON.parse(local);
            log("BRIDGE CONNECTED", "active");
            RAW_DATA = normalize(data);
            begin(); return;
        } catch(e) { log("BRIDGE CORRUPT", "error"); }
    }
    
    // Network Fetch (No-Store)
    log("FETCHING MASTER...", "normal");
    try {
        const r = await fetch('master.json', {cache: "no-store"});
        if(r.ok){ 
            const data = await r.json();
            RAW_DATA = normalize(data);
            log("MASTER LOADED", "active");
            begin(); 
        } else { throw new Error(); }
    } catch(e) { 
        log("NO DATA SOURCE", "error");
        card("NO DATA FOUND\nPush via Admin or Add master.json", {down:"RETRY"}, ()=>location.reload());
    }
}

// 2. BEGIN
function begin() {
    UI.stack.innerHTML = "";
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
        <div class="card-q">SESSION READY<br><br><span style="font-size:0.6em;opacity:0.7;">${RAW_DATA.length} QUESTIONS LOADED</span></div>
        <div class="swipe-label sl-up">SELECT SET</div>
        <div class="swipe-label sl-down">PDF EXPORT</div>
    `;
    UI.stack.appendChild(el);
    new PhysicsController(el, {
        onCommit: (dir) => {
            if(dir==="UP") pickSet();
            if(dir==="DOWN") exportSessionPDF();
        }
    });
}

// 3. SET SELECTION
function pickSet() {
    const sets = [...new Set(RAW_DATA.map(d=>d.set))];
    if(!sets.length) return;
    log("SELECT DATASET", "primary");
    renderSetCard(sets, 0);
}

function renderSetCard(sets, idx) {
    const s = sets[idx];
    card(s, {up:"SELECT", left:"PREV", right:"NEXT", down:"BACK"}, dir => {
        if(dir==="LEFT") renderSetCard(sets, (idx-1+sets.length)%sets.length);
        if(dir==="RIGHT") renderSetCard(sets, (idx+1)%sets.length);
        if(dir==="UP") { ACTIVE_SET = s; pickVolume(); }
        if(dir==="DOWN") begin();
    });
}

// 4. VOLUME SELECTION
function pickVolume() {
    log("SET VOLUME", "primary");
    card("QUESTION VOLUME", {up:"10", left:"25", right:"50", down:"ALL"}, dir => {
        if(dir==="UP") VOLUME_LIMIT=10;
        if(dir==="LEFT") VOLUME_LIMIT=25;
        if(dir==="RIGHT") VOLUME_LIMIT=50;
        if(dir==="DOWN") VOLUME_LIMIT=null;
        startQuiz();
    });
}

// 5. START QUIZ
function startQuiz() {
    log("INITIATING POOL...", "active");
    let base = RAW_DATA.filter(d => d.set === ACTIVE_SET);
    base = shuffle(base);
    if(VOLUME_LIMIT && VOLUME_LIMIT < base.length) base = base.slice(0, VOLUME_LIMIT);
    
    POOL = base;
    WRONG = [];
    SESSION_ALL = [];
    XP = 0;
    ATTEMPTED.clear();
    nextQ();
}

// 6. NEXT QUESTION (Loop 1)
function nextQ() {
    if(!POOL.length) {
        if(WRONG.length) {
            REVIEW_INDEX = 0; // Reset index for review loop
            review();
        } else {
            report();
        }
        return;
    }

    const d = POOL.shift();
    SESSION_ALL.push(d);
    log(`ACTIVE: ${d.id}`, "normal");

    const opts = shuffle([d.u, d.l, d.r]);
    const map = { UP: opts[0], LEFT: opts[1], RIGHT: opts[2] };

    card(d.q, {up:map.UP, left:map.LEFT, right:map.RIGHT}, dir => {
        if(dir==="DOWN") { nextQ(); return; }
        
        const picked = map[dir];
        const isCorrect = String(picked).trim().toLowerCase() === String(d.correct).trim().toLowerCase();
        
        if(isCorrect) {
            if(!ATTEMPTED.has(d.id)) XP++;
            log("OUTCOME: POSITIVE", "active");
        } else {
            WRONG.push(d);
            log("OUTCOME: NEGATIVE", "error");
        }
        
        ATTEMPTED.add(d.id);
        updateHUD();
        nextQ();
    });
}

// 7. CIRCULAR REVIEW LOOP (Loop 2)
function review() {
    // Safety exit
    if(WRONG.length === 0) { nextQ(); return; }
    
    // Bounds Check
    if(REVIEW_INDEX >= WRONG.length) REVIEW_INDEX = 0;
    
    const d = WRONG[REVIEW_INDEX]; 
    log("REVIEW MODE", "primary");
    log(`HINT: ${d.hint || "NONE"}`, "normal"); // Header HINT
    
    card(`REVIEW\n\n${d.logic || "Review the core principles."}`, {up:"RETRY", down:"NEXT"}, dir => {
        if(dir==="UP") {
            // RETRY PATH: Remove from WRONG, Insert into POOL
            WRONG.splice(REVIEW_INDEX, 1);
            POOL.unshift(d);
            log("RE-INSERTING...", "active");
            
            // Adjust Index? Since element removed, next element slides to this index.
            // Just ensure bounds.
            if(REVIEW_INDEX >= WRONG.length) REVIEW_INDEX = 0;
            
            // Check if we need to stay in review or go back to quiz
            if(WRONG.length > 0) {
                review(); // Stay in Loop 2
            } else {
                nextQ(); // Exit to Loop 1
            }
        } else {
            // SKIP PATH: Circular Iterate
            REVIEW_INDEX = (REVIEW_INDEX + 1) % WRONG.length;
            log("SKIPPING...", "normal");
            review(); // Stay in Loop 2
        }
    });
}

// 8. REPORT
function report() {
    log("SESSION COMPLETE", "active");
    const percent = Math.round((XP / SESSION_ALL.length) * 100) || 0;
    card(`SUMMARY\n\n${XP} / ${SESSION_ALL.length} (${percent}%)`, {down:"PDF", up:"RESTART"}, dir => {
        if(dir==="DOWN") exportSessionPDF();
        if(dir==="UP") begin();
    });
}

/* ================= HELPERS ================= */
function card(text, labels, cb) {
    UI.stack.innerHTML = "";
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
        <div class="card-q">${chemText(text).replace(/\n/g,"<br>")}</div>
        <div class="swipe-label sl-up">${chemText(labels.up||"")}</div>
        <div class="swipe-label sl-left">${chemText(labels.left||"")}</div>
        <div class="swipe-label sl-right">${chemText(labels.right||"")}</div>
        <div class="swipe-label sl-down">${chemText(labels.down||"")}</div>
    `;
    UI.stack.appendChild(el);
    new PhysicsController(el, {onCommit: cb});
}

function updateHUD() {
    UI.xp.textContent = `${XP} XP`;
    // Stable Math: Session / Total Active Items
    const total = SESSION_ALL.length + POOL.length + WRONG.length;
    const progress = (SESSION_ALL.length / total) * 100;
    UI.bar.style.width = `${progress}%`;
}

function normalize(data) {
    return data.map(d => ({
        id: d.id, set: d.set || "DEFAULT",
        q: d.q, u: d.u, l: d.l, r: d.r, correct: d.correct,
        logic: d.logic || "", hint: d.hint || "", trap: d.trap || "",
        dom: d.dom || "GENERAL", topic: d.topic || "",
        ref: d.ref || "", s1: d.s1 || "", s2: d.s2 || ""
    })).filter(d => d.q && d.u);
}

function exportSessionPDF(){
 if(!SESSION_ALL.length){alert("No data");return;}
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();
 let y=20;
 SESSION_ALL.forEach((d, i)=>{
  if(y>260){doc.addPage();y=20;}
  doc.setFont("courier","bold"); doc.setFontSize(11);
  doc.text(`Q${i+1} | ${d.id}`, 15, y); y+=8;
  doc.setFont("times","normal");
  const q=doc.splitTextToSize(`Q: ${cleanPDF(d.q)}`, 180);
  doc.text(q, 15, y); y+=q.length*6;
  doc.setFontSize(10);
  doc.text(`A) ${cleanPDF(d.u)}`, 15, y); y+=5;
  doc.text(`B) ${cleanPDF(d.l)}`, 15, y); y+=5;
  doc.text(`C) ${cleanPDF(d.r)}`, 15, y); y+=6;
  doc.setFont("courier","bold");
  doc.text(`ANSWER: ${cleanPDF(d.correct)}`, 15, y); y+=6;
  doc.setFont("times","italic");
  const l=doc.splitTextToSize(`LOGIC: ${cleanPDF(d.logic)}`, 180);
  doc.text(l, 15, y); y+=l.length*5;
  y+=10;
 });
 doc.save(`ALCHEMIST_${Date.now()}.pdf`);
}

init();
</script>
</body>
</html>
