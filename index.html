<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Final v137.14</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#000000; 
  --card:#0a0a0a; 
  --border:#222;
  --gold:#ffd600; 
  --green:#2ecc71;
  --text-white: #ffffff;
  --text-grey: #888888;
  
  --font-serif: 'Crimson Text', serif;
  --font-sans: 'Inter', sans-serif;
  --font-code: 'JetBrains Mono', monospace;
}

*{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}

body{
  margin:0; height:100vh; background:var(--bg);
  color:var(--text-white); font-family:var(--font-sans);
  overflow:hidden; display:flex; flex-direction:column;
}

/* HEADER */
#header{ width:90%; margin:25px auto 0; z-index:100; flex-shrink: 0; }
.header-meta{
  display:flex; justify-content:space-between;
  font-family:var(--font-code); font-size:0.75rem; 
  color:#666; letter-spacing:1.5px; text-transform:uppercase;
  margin-bottom: 15px;
}

/* PROGRESS BAR */
.progress-track{ width:100%; height:3px; background:#222; border-radius:2px; }
#progress-bar{ height:100%; background:var(--gold); width:0%; transition:width 0.4s ease; border-radius:2px; }

/* KINETIC LOGGER */
#kinetic-logger {
  width: 90%; margin: 15px auto 5px;
  font-family: var(--font-code); font-size: 0.8rem;
  color: #444; line-height: 1.4;
  text-transform: uppercase;
  min-height: 60px; 
  display: flex; flex-direction: column; justify-content: flex-end;
  pointer-events: none;
}
.log-line { opacity: 0.5; transition: opacity 0.2s; }
.log-line.active { color: var(--green); opacity: 1; font-weight: 700; }
.log-line.primary { color: var(--gold); opacity: 1; font-weight: 700; }

/* FLUID STACK ENGINE */
#stack{
  position:relative; width:90%; max-width:420px; 
  height: calc(100vh - 220px - env(safe-area-inset-bottom)); 
  margin: 10px auto 20px; 
  perspective:1500px;
  display:flex; align-items:center; justify-content:center;
}

.card{
  position:absolute; width:100%; height:100%;
  background:var(--card); 
  border-radius:14px; 
  border:1px solid var(--border);
  padding:35px; 
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.95);
  will-change:transform; transform-style:preserve-3d;
  overflow: hidden; 
}

/* MAIN TEXT */
.card-q{
  font-family:var(--font-serif);
  font-size: clamp(1.4rem, 5vw, 1.9rem); 
  line-height:1.4;
  font-weight:600; text-align:center;
  color: var(--text-white); 
  width: 100%;
  max-height: 100%;
  overflow-y: auto; 
  word-wrap: break-word;
  padding: 0 5px; 
  display: flex; flex-direction: column; justify-content: center;
}
.card-q::-webkit-scrollbar { width: 0px; }
.card-q sub{ font-size:0.7em; vertical-align:-0.3em; }
.card-q sup{ font-size:0.7em; vertical-align:0.5em; }

/* SWIPE LABELS */
.swipe-label{
  position:absolute; inset:0; 
  display:flex; align-items:center; justify-content:center;
  background:#000; 
  font-family:var(--font-sans); 
  font-weight:900; 
  font-size:1.8rem; 
  text-transform:uppercase; 
  letter-spacing:1px;
  text-align:center; padding:40px;
  opacity:0; pointer-events:none; 
  transition:opacity 0.15s ease;
  border-radius:14px;
  color: var(--text-grey); 
  border: 1px solid #333;
}
</style>
</head>
<body>

<div id="header">
  <div class="header-meta">
    <span id="id-ui">VIA.STACK</span> 
    <span id="xp-ui">0 XP</span>
  </div>
  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="kinetic-logger">
  <div class="log-line" id="log-1">> SYSTEM BOOT</div>
  <div class="log-line" id="log-2">> WAITING FOR DATA</div>
  <div class="log-line active" id="log-3">> ...</div>
</div>

<div id="stack">
  <div class="card">
    <div class="card-q" style="font-family:var(--font-code); font-size:0.9rem; color:#666; font-style:normal;">
      INITIALIZING CORE...
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const MASTER_KEY = "ALCHEMIST_MASTER_V1"; 

/* ================= STATE ================= */
let RAW_DATA = [];
let SET_CURSOR = 0; 
let ACTIVE_SET = null;
let POOL = [], WRONG = [], XP = 0;
let SESSION_ALL = []; 
let ATTEMPTED = new Set(); 
let REVIEW_INDEX = 0;

/* ================= LOGGER ENGINE ================= */
function log(msg, type="normal") {
    const l1 = document.getElementById("log-1");
    const l2 = document.getElementById("log-2");
    const l3 = document.getElementById("log-3");
    l1.innerText = l2.innerText; l1.className = l2.className;
    l2.innerText = l3.innerText; l2.className = "log-line"; 
    l3.innerText = `> ${msg}`;
    l3.className = type === "active" ? "log-line active" : 
                   type === "primary" ? "log-line primary" : "log-line";
}

/* ================= UTILS ================= */
const chemText = t => String(t||"").replace(/_(\d+)/g,"<sub>$1</sub>").replace(/\^([0-9+\-]+)/g,"<sup>$1</sup>").replace(/<->|↔|\\rightleftharpoons/g,"⇌");
const cleanPDF = t => String(t||"").replace(/<[^>]*>/g, "").replace(/&Delta;/g, "Δ").trim();
const shuffle = a => { for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a; };

/* ================= UI ================= */
const UI = {
  stack: document.getElementById("stack"),
  xp: document.getElementById("xp-ui"),
  bar: document.getElementById("progress-bar")
};

/* ================= PHYSICS ENGINE ================= */
class PhysicsController{
 constructor(el,cbs){
  this.el=el;this.cbs=cbs;this.active=false;this.start={x:0,y:0};
  this.labels={
    UP:el.querySelector(".sl-up"),
    LEFT:el.querySelector(".sl-left"),
    RIGHT:el.querySelector(".sl-right"),
    DOWN:el.querySelector(".sl-down")
  };
  const s=e=>this.startDrag(e.touches?e.touches[0]:e);
  const m=e=>this.move(e.touches?e.touches[0]:e);
  const e2=()=>this.end();
  el.addEventListener("mousedown",s); window.addEventListener("mousemove",m); window.addEventListener("mouseup",e2);
  el.addEventListener("touchstart",s,{passive:true}); el.addEventListener("touchmove",ev=>{if(this.active)ev.preventDefault();m(ev)},{passive:false}); el.addEventListener("touchend",e2);
 }
 startDrag(p){this.active=true;this.start={x:p.clientX,y:p.clientY};this.el.style.transition="none"}
 move(p){
  if(!this.active)return;
  const dx=p.clientX-this.start.x,dy=p.clientY-this.start.y;
  const d=Math.hypot(dx,dy);
  this.el.style.transform=`translate(${dx}px,${dy}px) rotate(${dx/25}deg)`;
  Object.values(this.labels).forEach(l=>l&&(l.style.opacity=0));
  if(d>20){
    const dir=this.dir(dx,dy);
    this.labels[dir]&&(this.labels[dir].style.opacity=Math.min(d/50,1));
  }
 }
 end(){
  if(!this.active)return;this.active=false;
  const m=new WebKitCSSMatrix(getComputedStyle(this.el).transform);
  const dx=m.m41,dy=m.m42;
  if(Math.hypot(dx,dy)>100)this.cbs.onCommit(this.dir(dx,dy));
  else{this.el.style.transition=".4s cubic-bezier(0.2, 0.8, 0.2, 1)";this.el.style.transform="translate(0,0)"}
 }
 dir(dx,dy){
  const a=(Math.atan2(-dy,dx)*180/Math.PI+360)%360;
  if(a>45&&a<135)return"UP";
  if(a>135&&a<225)return"LEFT";
  if(a>225&&a<315)return"DOWN";
  return"RIGHT";
 }
}

/* ================= RENDER LOGIC ================= */
function card(text,labels,cb){
 UI.stack.innerHTML="";
 const el=document.createElement("div");
 el.className="card";
 el.innerHTML=`
  <div class="card-q">${chemText(text).replace(/\n/g,"<br>")}</div>
  <div class="swipe-label sl-up">${chemText(labels.up||"")}</div>
  <div class="swipe-label sl-left">${chemText(labels.left||"")}</div>
  <div class="swipe-label sl-right">${chemText(labels.right||"")}</div>
  <div class="swipe-label sl-down">${chemText(labels.down||"")}</div>`;
 UI.stack.appendChild(el);
 new PhysicsController(el,{onCommit:cb});
}

/* ================= APP FLOW ================= */
function begin(){
 log("SESSION READY", "active");
 card(`DATA LOADED\n${RAW_DATA.length} UNITS`,{up:"QUIZ",down:"EXPORT",left:"RAPID",right:"LEARN"},dir=>{
  if(dir==="UP") setPick();
  if(dir==="DOWN") exportMenu();
 });
}

function setPick(){
 log("SELECT DATASET", "primary");
 const sets=[...new Set(RAW_DATA.map(d=>d.set))];
 if(sets.length===0) { card("NO DATA FOUND", {down:"RETRY"}, () => location.reload()); return; }
 card(sets[SET_CURSOR],{left:"",right:"",up:"SELECT",down:"BACK"},dir=>{
  if(dir==="LEFT"){SET_CURSOR=(SET_CURSOR-1+sets.length)%sets.length;setPick();}
  if(dir==="RIGHT"){SET_CURSOR=(SET_CURSOR+1)%sets.length;setPick();}
  if(dir==="UP"){ACTIVE_SET=sets[SET_CURSOR];volumePick();}
  if(dir==="DOWN") begin();
 });
}

function volumePick(){
 log("SET VOLUME", "primary");
 card("QUESTION VOLUME",{up:"10 Q",left:"25 Q",right:"50 Q",down:"ALL"},dir=>{
    let limit = null;
    if(dir==="UP") limit = 10;
    if(dir==="LEFT") limit = 25;
    if(dir==="RIGHT") limit = 50;
    startQuiz(limit);
 });
}

function startQuiz(limit){
 log("INITIATING POOL...", "active");
 let base = RAW_DATA.filter(d=>d.set===ACTIVE_SET);
 base = shuffle(base); 
 if(limit && limit < base.length) base = base.slice(0, limit);
 
 POOL=base; WRONG=[]; SESSION_ALL=[...POOL]; XP=0; ATTEMPTED=new Set();
 nextQ();
}

function nextQ(){
 if(!POOL.length){
    if(WRONG.length){ REVIEW_INDEX=0; review(); return; } 
    report(); return;
 }
 const d=POOL.shift();
 log(`ID: ${d.id}`, "normal");
 
 const opts = shuffle([d.u, d.l, d.r]);
 const map = { up: opts[0], left: opts[1], right: opts[2] };

 card(d.q, map, dir=>{
  if(dir==="DOWN"){nextQ();return;}
  let picked = null;
  if(dir==="UP") picked = map.up;
  if(dir==="LEFT") picked = map.left;
  if(dir==="RIGHT") picked = map.right;

  let c = d.correct;
  if(c==="UP"||c==="A") c=d.u;
  else if(c==="LEFT"||c==="B") c=d.l;
  else if(c==="RIGHT"||c==="R"||c==="C") c=d.r;

  const isCorrect = String(picked).trim().toLowerCase() === String(c).trim().toLowerCase();
  if(!isCorrect){ WRONG.push(d); log("OUTCOME: NEGATIVE", "primary"); } 
  else { if(!ATTEMPTED.has(d.id)){ XP+=1; } log("OUTCOME: POSITIVE", "active"); }
  
  ATTEMPTED.add(d.id);
  UI.xp.textContent=`${XP} / ${SESSION_ALL.length}`;
  const total = SESSION_ALL.length + POOL.length + WRONG.length;
  UI.bar.style.width = ((SESSION_ALL.length) / (total||1)) * 100 + "%";
  nextQ();
 });
}

function review(){
 if(WRONG.length === 0){ nextQ(); return; }
 if(REVIEW_INDEX >= WRONG.length) REVIEW_INDEX = 0;

 const d = WRONG[REVIEW_INDEX]; 
 log("REVIEW MODE", "primary");
 log(`HINT: ${d.hint || "NONE"}`, "normal"); 
 
 card(
  `REVIEW NOTE\n\n${d.logic || "Review the core principles."}`,
  {up:"RETRY", down:"SKIP"},
  dir=>{
    if(dir==="UP"){
        WRONG.splice(REVIEW_INDEX, 1);
        POOL.unshift(d);
        log("RE-INSERTING...", "active");
        nextQ();
    } else {
        REVIEW_INDEX = (REVIEW_INDEX + 1) % WRONG.length;
        log("SKIPPING...", "normal");
        review();
    }
  }
 );
}

function report(){
 log("SESSION COMPLETE", "active");
 const percent = Math.round((XP / SESSION_ALL.length) * 100) || 0;
 
 // POINT DOWN TO EXPORT MENU
 card(`SUMMARY\n\n${XP} / ${SESSION_ALL.length} (${percent}%)`,{down:"EXPORT", up:"RESTART", left:"MENU"},dir=>{
    if(dir==="DOWN") exportMenu();
    if(dir==="UP") startQuiz(); 
    if(dir==="LEFT") begin();
 });
}

/* ================= EXPORT MENU ================= */
function exportMenu(){
    log("SELECT FORMAT", "primary");
    card(
        "VIA.STACK\n\nSELECT OUTPUT FORMAT",
        { left:"SESSION PDF", right:"SUPPORT PDF", down:"BACK" },
        dir => {

            if(dir === "LEFT"){
                renderSessionPDF(SESSION_ALL);
                return;
            }

           if(dir === "RIGHT"){
  log("OPENING SUPPORT LINK", "active");

  // HARD EXIT FROM PHYSICS + SAFE NAV
  setTimeout(() => {
    window.open(SUPPORT_LINK, "_blank");
  }, 150);

  return;
}

            if(dir === "DOWN"){
                report();
            }
        }
    );
}
function showUnlockCard(){
  log("GATEWAY LOCKED", "primary");
  card(

<div style="text-align:center">
  <div style="margin-bottom:14px; font-size:1.1rem; font-weight:700;">
    UNLOCK SUPPORT PDF
  </div>

  <div style="margin-bottom:20px; font-size:0.8rem; color:#888;">
    Complete Academy Analysis
  </div>

  <a href="${https://wa.me/916351537770?text=Support%20PDF%20Unlock}" target="_blank"
     style="
       display:inline-block;
       padding:14px 22px;
       background:#25D366;
       color:#000;
       font-family:Inter,sans-serif;
       font-weight:700;
       border-radius:10px;
       text-decoration:none;
     ">
     Unlock via WhatsApp (₹1)
  </a>

  <div style="margin-top:15px; font-size:0.6rem; color:#444;">
    SECURE UPI GATEWAY
  </div>
</div>

{ down: "BACK" },
dir => { if(dir === "DOWN") exportMenu(); }
  );
}

/* ================= RENDERER A: SESSION PDF (Worksheet) ================= */
function renderSessionPDF(data){
    log("GENERATING SESSION PDF...", "active");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;

    const header = () => {
        doc.setFont("times", "bold"); doc.setFontSize(16); doc.setTextColor(0);
        doc.text("ALCHEMIST // SESSION WORKSHEET", 15, 20);
        doc.setLineWidth(0.5); doc.line(15, 25, 195, 25);
        y = 35;
    };

    header();

    data.forEach((d, i) => {
        if (y > 260) { doc.addPage(); header(); }

        doc.setFont("courier", "bold"); doc.setFontSize(11);
        doc.text(`Q${i+1} | ${d.id}`, 15, y); 
        y += 6;

        doc.setFont("times", "normal"); doc.setFontSize(11);
        const qLines = doc.splitTextToSize(cleanPDF(d.q), 180);
        doc.text(qLines, 15, y);
        y += qLines.length * 5 + 2;

        doc.setFont("helvetica", "normal"); doc.setFontSize(10); doc.setTextColor(60);
        doc.text(`(A) ${cleanPDF(d.u)}`, 15, y); y += 5;
        doc.text(`(B) ${cleanPDF(d.l)}`, 15, y); y += 5;
        doc.text(`(C) ${cleanPDF(d.r)}`, 15, y); y += 10; 
        
        doc.setTextColor(0); 
    });

    doc.save(`SESSION_PDF_${Date.now()}.pdf`);
    setTimeout(exportMenu, 1000); 
}

/* ================= RENDERER B: SUPPORT PDF (Academy) ================= */
function renderSupportPDF(data){
    log("GENERATING SUPPORT PDF...", "active");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;

    const ML = 15; const W = 180;
    const COL_W = { OPT: 45, LOG: 65, EXE: 65 };
    const COL_X = { OPT: ML, LOG: ML + 45 + 5, EXE: ML + 45 + 65 + 10 };

    data.forEach(d => {
        const a = (d.correct || "").trim().toUpperCase();
        if(a === "A" || a === "UP") d.correct = d.u;
        else if(a === "B" || a === "LEFT") d.correct = d.l;
        else if(a === "C" || a === "RIGHT") d.correct = d.r;
    });

    const header = () => {
        doc.setFont("times", "bold"); doc.setFontSize(16); doc.setTextColor(0);
        doc.text("ALCHEMIST // ACADEMY REPORT", 105, 15, {align:"center"});
        doc.setDrawColor(0); doc.setLineWidth(0.5);
        doc.line(ML, 18, 195, 18); doc.line(ML, 19, 195, 19); 
        y = 25;
    };

    header();

    data.forEach((d, i) => {
        if (y > 230) { doc.addPage(); header(); }

        doc.setFont("helvetica", "bold"); doc.setFontSize(8); doc.setTextColor(100);
        const headerText = `${d.id} // ${d.dom || "GENERAL"} > ${d.topic || "CONCEPTS"}`;
        doc.text(headerText, ML, y);
        y += 6;

        doc.setFont("times", "bold"); doc.setFontSize(12); doc.setTextColor(0);
        const qLines = doc.splitTextToSize(cleanPDF(d.q), W);
        doc.text(qLines, ML, y);
        y += (qLines.length * 5) + 4;

        doc.setDrawColor(180); doc.setLineWidth(0.3);
        doc.line(ML, y, 195, y); doc.line(ML, y+1, 195, y+1);
        y += 6;

        doc.setFont("helvetica", "bold"); doc.setFontSize(7); doc.setTextColor(150);
        doc.text("OPTIONS", COL_X.OPT, y);
        doc.text("THEORY & LOGIC", COL_X.LOG, y);
        doc.text("EXECUTION", COL_X.EXE, y);
        y += 5;

        const contentY = y;
        let maxH = y;

        doc.setFont("helvetica", "normal"); doc.setFontSize(9); doc.setTextColor(80);
        let optY = contentY;
        const optA = doc.splitTextToSize(`(A) ${cleanPDF(d.u)}`, COL_W.OPT);
        const optB = doc.splitTextToSize(`(B) ${cleanPDF(d.l)}`, COL_W.OPT);
        const optC = doc.splitTextToSize(`(C) ${cleanPDF(d.r)}`, COL_W.OPT);
        doc.text(optA, COL_X.OPT, optY); optY += optA.length*4 + 2;
        doc.text(optB, COL_X.OPT, optY); optY += optB.length*4 + 2;
        doc.text(optC, COL_X.OPT, optY); optY += optC.length*4 + 2;
        if(optY > maxH) maxH = optY;

        doc.setFont("times", "italic"); doc.setTextColor(50);
        const logLines = doc.splitTextToSize(cleanPDF(d.logic) || "Analysis pending.", COL_W.LOG);
        doc.text(logLines, COL_X.LOG, contentY);
        const logH = contentY + (logLines.length * 4);
        if(logH > maxH) maxH = logH;

        doc.setFont("helvetica", "normal"); doc.setTextColor(0);
        const textS1 = cleanPDF(d.step1);
        const textS2 = cleanPDF(d.step2);
        const s1 = `1. ${textS1 || "Identify governing principle."}`;
        const s2 = `2. ${textS2 || "Apply principle and verify result."}`;
        
        const s1L = doc.splitTextToSize(s1, COL_W.EXE);
        const s2L = doc.splitTextToSize(s2, COL_W.EXE);
        let exeY = contentY;
        doc.text(s1L, COL_X.EXE, exeY); exeY += s1L.length*4 + 2;
        doc.text(s2L, COL_X.EXE, exeY); exeY += s2L.length*4;
        if(exeY > maxH) maxH = exeY;

        y = maxH + 6;

        if(d.trap && d.trap !== "undefined") {
            doc.setLineDash([1, 1], 0); doc.setDrawColor(200); doc.line(ML, y, 195, y); doc.setLineDash([]);
            y += 4;
            doc.setFont("helvetica", "bold"); doc.setFontSize(8); doc.setTextColor(200, 50, 50);
            doc.text("DISTRACTOR ANALYSIS:", ML, y);
            doc.setFont("times", "italic"); doc.setTextColor(80);
            doc.text(cleanPDF(d.trap), ML + 35, y);
            y += 8;
        }
        y += 6; 
    });

    doc.save(`SUPPORT_PDF_${Date.now()}.pdf`);
    setTimeout(exportMenu, 1000); 
}

/* ================= ROBUST DATA BOOT ================= */
async function init(){
  log("SYSTEM BOOT", "active");

  let loaded = false;

  // 1️⃣ Try localStorage FIRST
  try {
    const localData = localStorage.getItem(MASTER_KEY);
    if(localData && localData.length > 10){
      RAW_DATA = JSON.parse(localData);
      loaded = true;
      log("BRIDGE CONNECTED", "primary");
    }
  } catch(e){
    RAW_DATA = [];
  }

  // 2️⃣ Try master.json with timeout
  if(!loaded){
    log("FETCHING MASTER...", "normal");

    try {  
      const controller = new AbortController();  
      setTimeout(() => controller.abort(), 3000); // HARD STOP  

      const r = await fetch('./master.json', {  
        cache: "no-store",  
        signal: controller.signal  
      });  

      if(r.ok){  
        RAW_DATA = await r.json();  
        loaded = true;  
        log("MASTER LOADED", "primary");  
      }  
    } catch(e){  
      log("MASTER FETCH FAILED", "normal");  
    }
  }

  // 3️⃣ Normalize
  RAW_DATA = (RAW_DATA || []).map(d => ({
    id: d.id,
    set: d.set || "DEFAULT",
    dom: d.dom || "GENERAL",
    topic: d.topic || "",
    q: d.q,
    u: d.u,
    l: d.l,
    r: d.r,
    correct: d.correct,
    logic: d.logic || "",
    hint: d.hint || "",
    trap: d.trap || "",
    step1: d.step1 || d.s1 || "",
    step2: d.step2 || d.s2 || ""
  })).filter(d => d.id && d.q && d.u);

  // 4️⃣ HARD FAIL SAFE
  if(!RAW_DATA.length){
    log("NO DATA FOUND", "primary");
    card(
      "NO DATA FOUND\n\nPush data via Admin",
      { down: "RETRY" },
      () => location.reload()
    );
    return;
  }

  // 5️⃣ SUCCESS
  log(`DATA READY (${RAW_DATA.length})`, "active");
  begin();
}

init();
</script>
</body>
</html>
