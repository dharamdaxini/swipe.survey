<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Operator v136.36</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#000; --card:#121212; --border:#333;
  --gold:#d4af37; 
  --text-grey: #cccccc;
  
  --font-serif: 'Crimson Text', serif;
  --font-sans: 'Inter', sans-serif;
  --font-code: 'JetBrains Mono', monospace;
}

*{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}

body{
  margin:0; height:100vh; background:var(--bg);
  color:#e0e0e0; font-family:var(--font-sans);
  overflow:hidden; display:flex; flex-direction:column;
}

/* HEADER */
#header{ width:90%; margin:25px auto 0; z-index:100; }
.header-meta{
  display:flex; justify-content:space-between;
  font-family:var(--font-code); font-size:0.75rem; 
  color:#666; letter-spacing:1.5px; text-transform:uppercase;
}

/* REVIEW HEADER (HINT) */
#review-text{
  margin-top:20px;
  font-family:var(--font-serif);
  font-size:1.3rem; line-height:1.4;
  font-style:italic; text-align:center;
  color:var(--gold); 
  min-height:3.5em;
  display:flex; align-items:flex-end; justify-content:center;
  text-shadow: 0 4px 12px rgba(0,0,0,0.9);
}

.progress-track{ width:100%; height:3px; background:#222; margin-top:15px; border-radius:2px; }
#progress-bar{ height:100%; background:var(--gold); width:0%; transition:width 0.4s ease; border-radius:2px; }

/* STACK ENGINE */
#stack{
  position:relative; width:90%; max-width:420px; height:62vh;
  margin:auto; perspective:1500px;
  display:flex; align-items:center; justify-content:center;
}

.card{
  position:absolute; width:100%; height:95%;
  background:var(--card); border-radius:12px; 
  border:1px solid var(--border);
  padding:35px; 
  display:flex; flex-direction:column; justify-content:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.95);
  will-change:transform; transform-style:preserve-3d;
  overflow: hidden; 
}

/* MAIN TEXT - SCROLLABLE & FITTED */
.card-q{
  font-family:var(--font-serif);
  font-size: clamp(1.1rem, 4vw, 1.7rem); 
  line-height:1.5;
  font-weight:600; text-align:center;
  color: var(--text-grey);
  
  width: 100%;
  max-height: 100%;
  overflow-y: auto; 
  padding-right: 5px; 
  pointer-events: auto;
}

/* CUSTOM SCROLLBAR */
.card-q::-webkit-scrollbar { width: 4px; }
.card-q::-webkit-scrollbar-track { background: transparent; }
.card-q::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

.card-error { color: #e74c3c; font-family: var(--font-code); font-size: 0.9rem; text-align: left; }

.card-q sub{ font-size:0.7em; vertical-align:-0.3em; }
.card-q sup{ font-size:0.7em; vertical-align:0.5em; }

/* SWIPE LABELS */
.swipe-label{
  position:absolute; inset:0; display:flex;
  align-items:center; justify-content:center;
  background:#000; 
  font-family:var(--font-sans); font-weight:800; font-size:1.4rem;
  text-transform:uppercase; letter-spacing:1px;
  opacity:0; pointer-events:none; padding:40px;
  text-align:center; z-index:10; transition:opacity 0.1s ease;
  border-radius:12px;
  color: #fff; 
  border: 1px solid #333;
}

/* Option Colors in Swipe Mode */
.sl-up{ color: var(--green); } 
.sl-left{ color: var(--text-grey); } 
.sl-right{ color: var(--text-grey); }
.sl-down{ color: var(--blue); }

</style>
</head>
<body>

<div id="header">
  <div class="header-meta">
    <span id="id-ui">BOOT</span>
    <span id="xp-ui">0 XP</span>
  </div>
  <div id="review-text"></div>
  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack">
  <div class="card">
    <div class="card-q" style="font-family:var(--font-code); font-size:0.9rem; color:#666; font-style:normal;">
      VIA.STACK | V136.36<br>CONNECTING BRIDGE...
    </div>
  </div>
</div>

<script>
/* ================= BRIDGE CONFIG ================= */
const MASTER_URL = "https://raw.githubusercontent.com/dharamdaxini/swipe.survey/e939bcc47c331c43fb8875e3a77f1125329a3810/master.json";
const MASTER_KEY = "ALCHEMIST_MASTER_V1"; 
const VERSION_KEY = "ALCHEMIST_VERSION";
const APP_VERSION = "v136.36"; // Forces Reset

/* ================= STATE ================= */
let RAW_DATA = [];
let SET_CURSOR = 0; 
let ACTIVE_SET = null;
let POOL = [], WRONG = [], REVIEW_INDEX = 0;
let SESSION_ALL = [], XP = 0;
let VOLUME_LIMIT = null;
let ATTEMPTED = new Set(); 

/* ================= UTILS ================= */
function chemText(t){
  if(!t) return "";
  return String(t)
    .replace(/_([0-9]+)/g,"<sub>$1</sub>")
    .replace(/\^([0-9+\-]+)/g,"<sup>$1</sup>")
    .replace(/<->|↔|\\rightleftharpoons/g,"⇌");
}

function cleanPDF(t){
  if(!t) return "";
  return String(t).replace(/<[^>]*>/g, "").replace(/&Delta;/g, "Δ");
}

function shuffle(array) {
  let currentIndex = array.length, randomIndex;
  while (currentIndex != 0) {
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;
    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
  }
  return array;
}

/* ================= VERSION CONTROL ================= */
(function checkVersion(){
    const v = localStorage.getItem(VERSION_KEY);
    if(v !== APP_VERSION){
        console.log("VERSION UPDATE: Clearing old caches...");
        // Keeps MASTER_KEY intact so local Admin work isn't lost
        localStorage.setItem(VERSION_KEY, APP_VERSION);
    }
})();

/* ================= UI ================= */
const UI = {
  stack: document.getElementById("stack"),
  id: document.getElementById("id-ui"),
  xp: document.getElementById("xp-ui"),
  bar: document.getElementById("progress-bar"),
  review: document.getElementById("review-text")
};

/* ================= PHYSICS ENGINE ================= */
class PhysicsController{
 constructor(el,cbs){
  this.el=el;this.cbs=cbs;this.active=false;this.start={x:0,y:0};
  this.labels={
    UP:el.querySelector(".sl-up"),
    LEFT:el.querySelector(".sl-left"),
    RIGHT:el.querySelector(".sl-right"),
    DOWN:el.querySelector(".sl-down")
  };
  const s=e=>this.startDrag(e.touches?e.touches[0]:e);
  const m=e=>this.move(e.touches?e.touches[0]:e);
  const e2=()=>this.end();
  el.addEventListener("mousedown",s);
  window.addEventListener("mousemove",m);
  window.addEventListener("mouseup",e2);
  el.addEventListener("touchstart",s,{passive:false});
  el.addEventListener("touchmove",ev=>{if(this.active)ev.preventDefault();m(ev)},{passive:false});
  el.addEventListener("touchend",e2);
 }
 startDrag(p){this.active=true;this.start={x:p.clientX,y:p.clientY};this.el.style.transition="none"}
 move(p){
  if(!this.active)return;
  const dx=p.clientX-this.start.x,dy=p.clientY-this.start.y;
  const d=Math.hypot(dx,dy);
  this.el.style.transform=`translate(${dx}px,${dy}px) rotate(${dx/25}deg)`;
  Object.values(this.labels).forEach(l=>l&&(l.style.opacity=0));
  if(d>20){
    const dir=this.dir(dx,dy);
    this.labels[dir]&&(this.labels[dir].style.opacity=Math.min(d/50,1));
  }
 }
 end(){
  if(!this.active)return;this.active=false;
  const m=new WebKitCSSMatrix(getComputedStyle(this.el).transform);
  const dx=m.m41,dy=m.m42;
  if(Math.hypot(dx,dy)>100)this.cbs.onCommit(this.dir(dx,dy));
  else{this.el.style.transition=".4s cubic-bezier(0.2, 0.8, 0.2, 1)";this.el.style.transform="translate(0,0)"}
 }
 dir(dx,dy){
  const a=(Math.atan2(-dy,dx)*180/Math.PI+360)%360;
  if(a>45&&a<135)return"UP";
  if(a>135&&a<225)return"LEFT";
  if(a>225&&a<315)return"DOWN";
  return"RIGHT";
 }
}

/* ================= RENDER LOGIC ================= */
function card(text,labels,cb, isError=false){
  UI.stack.innerHTML="";
  const el=document.createElement("div");
  el.className="card";
  
  let content = chemText(text).replace(/\n/g,"<br>");
  if(isError) content = `<div class="card-error">SYSTEM ERROR:\n${text}</div>`;
  
  el.innerHTML=`
    <div class="card-q">${content}</div>
    <div class="swipe-label sl-up">${chemText(labels.up)||""}</div>
    <div class="swipe-label sl-left">${chemText(labels.left)||""}</div>
    <div class="swipe-label sl-right">${chemText(labels.right)||""}</div>
    <div class="swipe-label sl-down">${chemText(labels.down)||""}</div>
  `;
  UI.stack.appendChild(el);
  new PhysicsController(el,{onCommit:cb});
}

/* ================= NORMALIZER ================= */
function normalize(d){
  if(!d || !d.id || !d.q) return null;
  let c = d.correct;
  if(c==="UP"||c==="A") c=d.u;
  else if(c==="LEFT"||c==="B") c=d.l;
  else if(c==="RIGHT"||c==="C"||c==="R") c=d.r;

  return {
    id: String(d.id),
    set: d.set || "SET_A",
    dom: d.dom || "GENERAL",
    topic: d.topic || "",
    q: d.q,
    u: d.u,
    l: d.l,
    r: d.r,
    correct: c || d.u,
    logic: d.logic || "",
    hint: d.hint || "",
    trap: d.trap || "",
    step1: d.step1 || "",
    step2: d.step2 || ""
  };
}

/* ================= APP FLOW ================= */
function begin(){
  UI.review.textContent="";
  card(
    `SESSION READY\n${RAW_DATA.length} Questions Loaded`,
    {up:"QUIZ",down:"MY PDF",left:"RAPID",right:"LEARN"},
    dir=>{ 
      if(dir==="UP") setPick(); 
      if(dir==="DOWN") exportSessionPDF();
    }
  );
}

function setPick(){
  const sets=[...new Set(RAW_DATA.map(d=>d.set))];
  if(!sets.length){
    card("NO DATA\n(0 Records)",{down:"RELOAD"},()=>location.reload());
    return;
  }
  card(
    sets[SET_CURSOR],
    {left:"",right:"",up:"SELECT",down:"BACK"},
    dir=>{
      if(dir==="LEFT"){SET_CURSOR=(SET_CURSOR+sets.length-1)%sets.length;setPick();}
      if(dir==="RIGHT"){SET_CURSOR=(SET_CURSOR+1)%sets.length;setPick();}
      if(dir==="UP"){ACTIVE_SET=sets[SET_CURSOR];volumePick();}
      if(dir==="DOWN") begin();
    }
  );
}

function volumePick(){
 card(
  `QUESTION VOLUME`,
  {up:"10 Q",left:"25 Q",right:"50 Q",down:"ALL"},
  dir=>{
    if(dir==="UP") VOLUME_LIMIT=10;
    if(dir==="LEFT") VOLUME_LIMIT=25;
    if(dir==="RIGHT") VOLUME_LIMIT=50;
    if(dir==="DOWN") VOLUME_LIMIT=null;
    startQuiz();
  }
 );
}

function startQuiz(){
  let base = RAW_DATA.filter(d=>d.set===ACTIVE_SET);
  base = shuffle(base); 
  if(VOLUME_LIMIT) base = base.slice(0, VOLUME_LIMIT);
  
  POOL=base;
  WRONG=[]; SESSION_ALL=[]; XP=0; ATTEMPTED.clear();
  nextQ();
}

function nextQ(){
  UI.review.textContent="";
  if(!POOL.length){
     if(WRONG.length){ review(); return; } 
     report(); return;
  }

  const d=POOL.shift();
  UI.id.textContent=d.id;
  if(!SESSION_ALL.includes(d)) SESSION_ALL.push(d);

  // SHUFFLE & MAP 3 OPTIONS (Fixes "UP" label issue)
  const opts=shuffle([d.u,d.l,d.r]);
  const map = { up: opts[0], left: opts[1], right: opts[2] };

  card(
    d.q,
    map,
    dir=>{
      let picked = null;
      if(dir==="UP") picked = map.up;
      if(dir==="LEFT") picked = map.left;
      if(dir==="RIGHT") picked = map.right;

      const isCorrect = String(picked).trim().toLowerCase() === String(d.correct).trim().toLowerCase();

      if(!isCorrect){
        WRONG.push(d);
      } else {
        if(!ATTEMPTED.has(d.id)){ XP+=1; }
      }
      ATTEMPTED.add(d.id);
      UI.xp.textContent=`${XP} / ${SESSION_ALL.length}`;
      UI.bar.style.width = ((SESSION_ALL.length - POOL.length) / SESSION_ALL.length) * 100 + "%";
      
      nextQ();
    }
  );
}

function review(){
 if(!WRONG.length){ report(); return; } 
 const d=WRONG[REVIEW_INDEX];
 UI.review.innerHTML = chemText(`HINT: ${d.hint || "Recall the basics."}`);
 
 // LOGIC IN MAIN CARD (Scrollable)
 card(
  `REVIEW NOTE\n\n${d.logic || "Review the core principles."}`,
  {up:"RETRY", down:"SKIP"},
  dir=>{
    if(dir==="UP"){
        WRONG.splice(REVIEW_INDEX,1);
        POOL.unshift(d);
        if(REVIEW_INDEX >= WRONG.length) REVIEW_INDEX=0;
        nextQ();
    }
    if(dir==="DOWN"){
        REVIEW_INDEX=(REVIEW_INDEX+1)%WRONG.length;
        review();
    }
  }
 );
}

function report(){
 UI.review.textContent="SESSION COMPLETE"; 
 const total = SESSION_ALL.length;
 const percent = Math.round((XP / total) * 100);
 let feedback = percent > 90 ? "Excellent Mastery." : "Review Recommended.";
 
 card(
  `SUMMARY\n\n${XP} / ${total} Correct\n(${percent}%)\n\n${feedback}`,
  {down:"EXPORT PDF", up:"RETRY SET", left:"MAIN MENU", right:"NEXT LEVEL"},
  dir=>{
    if(dir==="DOWN") exportSessionPDF();
    if(dir==="UP") startQuiz(); 
    if(dir==="LEFT") begin();
    if(dir==="RIGHT"){
        const sets=[...new Set(RAW_DATA.map(d=>d.set))];
        const curr = sets.indexOf(ACTIVE_SET);
        if(curr > -1 && curr < sets.length - 1){
            ACTIVE_SET = sets[curr+1];
            volumePick();
        } else {
            alert("All Sets Completed!");
            begin();
        }
    }
  }
 );
}

/* ================= PDF EXPORT (v132.21 Academy Layout) ================= */
function exportSessionPDF(){
 if(!SESSION_ALL.length){alert("No session data");return;}
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();
 const unique=SESSION_ALL.filter((q,i,self)=>i===self.findIndex(t=>(t.id===q.id)));

 let y=20;
 const ML=15; const W=180;
 const COL_OPT_W=45; const COL_LOG_W=65; const COL_EXE_W=65;
 const COL_LOG_X=ML+COL_OPT_W+5; const COL_EXE_X=COL_LOG_X+COL_LOG_W+5;

 doc.setFont("times","bold"); doc.setFontSize(16);
 doc.text("ACADEMY SESSION REPORT",105,y,{align:"center"});
<script>
/* ================= FINAL INIT — LOCAL FIRST, HARD STOP ================= */
async function init(){

  let sourceData = null;

  /* --------------------------------------------------
     1. LOCAL STORAGE HAS ABSOLUTE PRIORITY
     -------------------------------------------------- */
  if (localStorage.getItem(MASTER_KEY) !== null) {
    try {
      sourceData = JSON.parse(localStorage.getItem(MASTER_KEY) || "[]");
      console.log("INIT: Local master detected. Remote disabled.");
    } catch (e) {
      card(
        `CRITICAL ERROR\nLocal master is corrupted.\n\n${e.message}`,
        { down: "RESET" },
        () => {
          localStorage.removeItem(MASTER_KEY);
          location.reload();
        },
        true
      );
      return;
    }
  }

  /* --------------------------------------------------
     2. REMOTE BOOTSTRAP (ONLY IF LOCAL DOES NOT EXIST)
     -------------------------------------------------- */
  if (sourceData === null) {
    try {
      console.log("INIT: No local master. Fetching remote bootstrap.");
      const res = await fetch(
        MASTER_URL + "?t=" + Date.now(),
        { cache: "no-store" }
      );

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      sourceData = await res.json();

      // Persist immediately — future loads are local-only
      localStorage.setItem(MASTER_KEY, JSON.stringify(sourceData));

    } catch (e) {
      card(
        `BOOTSTRAP FAILURE\nNo local data and remote fetch failed.\n\n${e.message}`,
        { down: "RETRY" },
        () => location.reload(),
        true
      );
      return;
    }
  }

  /* --------------------------------------------------
     3. NORMALIZE DATA
     -------------------------------------------------- */
  RAW_DATA = Array.isArray(sourceData)
    ? sourceData.map(normalize).filter(Boolean)
    : [];

  /* --------------------------------------------------
     4. FINAL GUARD
     -------------------------------------------------- */
  if (RAW_DATA.length === 0) {
    console.log("INIT: Data empty. Starting clean session.");
    begin(); // shows "0 Questions Loaded"
    return;
  }

  /* --------------------------------------------------
     5. START APP
     -------------------------------------------------- */
  console.log(`INIT: Loaded ${RAW_DATA.length} questions.`);
  begin();
}

/* --------------------------------------------------
   EXECUTE
   -------------------------------------------------- */
init();
</script>
</body>
</html>
