<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Kinetic v144.0 Gold</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
 --bg:#000;--card:#0a0a0a;--border:#222;
 --gold:#ffd600;--green:#2ecc71;--red:#ff4444;
 --text-white:#fff;--text-grey:#888;
 --font-serif:'Crimson Text',serif;
 --font-sans:'Inter',sans-serif;
 --font-code:'JetBrains Mono',monospace;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;height:100vh;background:var(--bg);color:var(--text-white);font-family:var(--font-sans);overflow:hidden;display:flex;flex-direction:column}

/* HEADER */
#header{width:90%;margin:25px auto 0;flex-shrink:0}
.header-meta{display:flex;justify-content:space-between;font-family:var(--font-code);font-size:.75rem;color:#666;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:15px}
.progress-track{width:100%;height:3px;background:#222;border-radius:2px}
#progress-bar{height:100%;background:var(--gold);width:0%;transition:width .3s ease;border-radius:2px}

/* LOGGER */
#kinetic-logger{width:90%;margin:15px auto 5px;font-family:var(--font-code);font-size:.8rem;color:#444;line-height:1.4;text-transform:uppercase;min-height:60px;display:flex;flex-direction:column;justify-content:flex-end}
.log-line{opacity:.4}
.log-line.active{opacity:1;color:var(--green);font-weight:700}
.log-line.primary{opacity:1;color:var(--gold);font-weight:700}
.log-line.danger{opacity:1;color:var(--red);font-weight:700}

/* STACK */
#stack{position:relative;width:90%;max-width:420px;height:calc(100vh - 220px - env(safe-area-inset-bottom));margin:10px auto 20px;perspective:1500px;display:flex;align-items:center;justify-content:center}
.card{position:absolute;width:100%;height:100%;background:var(--card);border-radius:14px;border:1px solid var(--border);padding:35px;display:flex;flex-direction:column;justify-content:center;align-items:center;box-shadow:0 20px 60px rgba(0,0,0,.95);will-change:transform;transform-style:preserve-3d;overflow:hidden}
.card-q{font-family:var(--font-serif);font-size:clamp(1.4rem,5vw,1.9rem);line-height:1.4;font-weight:600;text-align:center;width:100%;overflow-y:auto}
.card-q::-webkit-scrollbar{width:0}
.swipe-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:#000;font-weight:900;font-size:1.8rem;letter-spacing:1px;opacity:0;pointer-events:none;border-radius:14px;color:var(--text-grey);border:1px solid #333}
</style>
</head>

<body>

<div id="header">
  <div class="header-meta">
    <span id="id-ui">VIA.STACK</span>
    <span id="xp-ui">0</span>
  </div>
  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="kinetic-logger">
  <div class="log-line" id="log-1">> BOOT</div>
  <div class="log-line" id="log-2">> ...</div>
  <div class="log-line active" id="log-3">> READY</div>
</div>

<div id="stack">
  <div class="card">
    <div class="card-q" style="font-family:var(--font-code);font-size:.9rem;color:#666">INITIALIZING...</div>
  </div>
</div>

<script>
/* ================= GOLD MASTER CONSTANTS ================= */
const VERSION = "v144.0-GOLD";
const VAULT_TTL = 86400000;

const KEY_CREDITS="K1_CREDITS";
const KEY_DUMPS="K1_DUMPS";
const KEY_VAULT="K1_VAULT";

const BEACON_URL="https://script.google.com/macros/s/AKfycbwV8ALtVlLe31BcEi6AIq7MBNlu498vzU-kNpvaHl1zCafZVpffJe-1NtYkJtEKCT8m/exec";
const GITHUB_RAW_URL="https://raw.githubusercontent.com/dharamdaxini/swipe.survey/a02e6e66410562062a98e8f96183aec7227a5819/master.json";

/* ================= STATE ================= */
let RAW_DATA=[],POOL=[],WRONG=[],SESSION_ALL=[];
let XP=0,SET_CURSOR=0,ACTIVE_SET=null;
let SESSION_LOG=[],PIVOT_COUNT=0;
let USER_MOBILE=localStorage.getItem("USER_MOBILE")||null;
let CURRENT_SES_ID=null;

/* ECONOMY */
let CREDITS=parseFloat(localStorage.getItem(KEY_CREDITS)||"10.0");
let DUMPS=parseInt(localStorage.getItem(KEY_DUMPS)||"0");

/* VAULT */
let VAULT=[];
try{VAULT=JSON.parse(localStorage.getItem(KEY_VAULT)||"[]")}catch(e){VAULT=[]}

/* ================= LOGGER ================= */
function log(msg,type="normal"){
 const l1=log_1,l2=log_2,l3=log_3;
 l1.innerText=l2.innerText;l1.className=l2.className;
 l2.innerText=l3.innerText;l2.className="log-line";
 l3.innerText="> "+msg;
 l3.className="log-line "+(type||"");
}

/* ================= VAULT GC ================= */
function gcVault(){
 const now=Date.now();
 VAULT=VAULT.filter(v=>v.ts&&(now-v.ts)<VAULT_TTL);
 localStorage.setItem(KEY_VAULT,JSON.stringify(VAULT));
}

/* ================= PHYSICS KERNEL ================= */
const ROT_COEFF=20,COMMIT_RADIUS=100,LABEL_START=30,SNAP_TIME=300,SNAP_CURVE="cubic-bezier(0.2,0.8,0.2,1)";

class PhysicsController{
 constructor(el,cb){
  this.el=el;this.cb=cb;this.active=false;this.start={x:0,y:0};
  el.addEventListener("touchstart",e=>this.s(e.touches[0]),{passive:false});
  el.addEventListener("touchmove",e=>{if(this.active)e.preventDefault();this.m(e.touches[0])},{passive:false});
  el.addEventListener("touchend",()=>this.e());
 }
 s(p){this.active=true;this.start={x:p.clientX,y:p.clientY};this.el.style.transition="none"}
 m(p){
  if(!this.active)return;
  const dx=p.clientX-this.start.x,dy=p.clientY-this.start.y;
  const d=Math.hypot(dx,dy);
  this.el.style.transform=`translate(${dx}px,${dy}px) rotate(${dx/ROT_COEFF}deg)`;
 }
 e(){
  if(!this.active)return;
  this.active=false;
  const m=new WebKitCSSMatrix(getComputedStyle(this.el).transform);
  const dx=m.m41,dy=m.m42,d=Math.hypot(dx,dy);
  if(d>COMMIT_RADIUS)this.cb();
  else{
   if(d>LABEL_START)PIVOT_COUNT++;
   this.el.style.transition=`${SNAP_TIME}ms ${SNAP_CURVE}`;
   this.el.style.transform="translate(0,0)";
  }
 }
}

/* ================= CORE ================= */
const UI={stack,bar:progress_bar,xp:xp_ui};

function card(text,cb){
 UI.stack.innerHTML="";
 const el=document.createElement("div");
 el.className="card";
 el.innerHTML=`<div class="card-q">${text}</div>`;
 UI.stack.appendChild(el);
 new PhysicsController(el,cb);
}

/* ================= FLOW ================= */
function begin(){
 log("SYSTEM READY "+VERSION,"primary");
 card(`DATA LOADED\n${RAW_DATA.length}`,()=>setPick());
}

function setPick(){
 const sets=[...new Set(RAW_DATA.map(d=>d.set))];
 card(`SET\n${sets[SET_CURSOR]}`,()=>{ACTIVE_SET=sets[SET_CURSOR];startQuiz()});
}

function startQuiz(){
 XP=0;SESSION_ALL=[];WRONG=[];
 POOL=[...RAW_DATA.filter(d=>d.set===ACTIVE_SET)];
 nextQ();
}

function nextQ(){
 if(!POOL.length){report();return}
 const d=POOL.shift();
 SESSION_ALL.push(d);
 card(d.q,()=>{
  XP++;UI.xp.textContent=XP;
  nextQ();
 });
}

function report(){
 card(`SUMMARY\n${XP}/${SESSION_ALL.length}\nDOWNLOAD PDF`,()=>exportSessionPDF());
}

function exportSessionPDF(){
 if(CREDITS<1){log("NO CREDITS","danger");return}
 CREDITS-=1;DUMPS+=1;
 localStorage.setItem(KEY_CREDITS,CREDITS.toFixed(1));
 localStorage.setItem(KEY_DUMPS,DUMPS);
 VAULT.unshift({id:"SES_"+Date.now(),ts:Date.now(),score:XP,total:SESSION_ALL.length,data:SESSION_ALL});
 gcVault();
 log("PDF GENERATED","active");
}

/* ================= INIT ================= */
async function init(){
 gcVault();
 log("BOOT "+VERSION,"active");
 try{
  const r=await fetch(GITHUB_RAW_URL);
  RAW_DATA=await r.json();
 }catch(e){RAW_DATA=[]}
 RAW_DATA=RAW_DATA.filter(d=>d.id&&d.q&&d.u);
 begin();
}
init();
</script>
</body>
</html>
