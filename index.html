<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Kinetic v1</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700&family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* --- 01. CORE VISUALS (v144.2 UI) --- */
:root{ --bg:#000; --card:#0a0a0a; --border:#222; --gold:#ffd600; --green:#2ecc71; --cyan:#00e5ff; --red:#ff4444; --text:#fff; --font-serif:'Crimson Text',serif; --font-sans:'Inter',sans-serif; --font-code:'JetBrains Mono',monospace; }
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent; user-select: none;}
body{margin:0; height:100vh; background:var(--bg); color:var(--text); font-family:var(--font-sans); overflow:hidden; display:flex; flex-direction:column;}

/* --- 02. DUAL HUD LOGGERS --- */
#header{width:90%; margin:25px auto 0; z-index:100; flex-shrink:0;}
.header-meta{display:flex; justify-content:space-between; font-family:var(--font-code); font-size:0.75rem; color:#666; letter-spacing:1.5px; text-transform:uppercase; margin-bottom:10px;}
.progress-track{width:100%; height:3px; background:#222; border-radius:2px;}
#progress-bar{height:100%; background:var(--gold); width:0%; transition:width 0.4s ease;}

#hud-grid { display: grid; grid-template-columns: 1fr 1fr; width: 90%; margin: 12px auto 5px; gap: 10px; font-family: var(--font-code); font-size: 0.65rem; text-transform: uppercase; min-height: 45px; }
.log-line { opacity: 0.4; transition: 0.2s; white-space: nowrap; overflow: hidden; }
.log-line.active { color: var(--green); opacity: 1; font-weight: 700; }
.log-line.warn { color: var(--gold); opacity: 1; }
.log-line.danger { color: var(--red); opacity: 1; font-weight: 700; }

/* --- 03. PHYSICS STACKS --- */
.stack-container{position:absolute; inset:0; top:120px; width:90%; max-width:420px; height:calc(100vh - 220px); margin:0 auto; perspective:1500px; display:flex; align-items:center; justify-content:center; pointer-events: none; opacity: 0; transition: opacity 0.3s;}
.stack-container.active { pointer-events: all; opacity: 1; z-index: 20; }

.card{position:absolute; width:100%; height:100%; background:var(--card); border-radius:14px; border:1px solid var(--border); padding:30px; display:flex; flex-direction:column; justify-content:center; align-items:center; box-shadow:0 20px 60px rgba(0,0,0,0.9); will-change:transform; transform-style:preserve-3d; overflow:hidden;}
.card.vault-card { border-color: #333; background: #080808; }

.card-q{font-family:var(--font-serif); font-size:clamp(1.3rem, 5vw, 1.8rem); line-height:1.4; text-align:center; width:100%;}
.swipe-label{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:#000; font-weight:900; font-size:1.6rem; text-transform:uppercase; opacity:0; transition:opacity 0.15s; border-radius:14px; border:1px solid #444; color:var(--gold);}

/* EXPIRE TIMER UI */
.timer-badge { position: absolute; top: 15px; font-family: var(--font-code); font-size: 0.65rem; color: var(--red); letter-spacing: 1px; }
.erk-display { margin-top: 15px; font-family: var(--font-code); font-size: 0.7rem; color: #555; background: #111; padding: 5px 10px; border-radius: 4px; }

</style>
</head>
<body>

<div id="header">
  <div class="header-meta">
    <span id="sys-status">KINETIC.v1</span> 
    <span id="xp-ui">0 XP</span>
  </div>
  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="hud-grid">
    <div class="hud-col">
        <div class="log-line" id="sys-1">> SYSTEM BOOT</div>
        <div class="log-line active" id="sys-2">> ONLINE</div>
    </div>
    <div class="hud-col" style="text-align:right">
        <div class="log-line" id="nic-1">WAITING <</div>
        <div class="log-line active" id="nic-2">READY <</div>
    </div>
</div>

<div id="stack-game" class="stack-container active">
  <div class="card"><div class="card-q" style="font-family:var(--font-code); font-size:0.8rem; color:#444;">SYNCING ENGINE...</div></div>
</div>

<div id="stack-vault" class="stack-container"></div>

<script>
/* =================================================================
   VIA.STACK | KINETIC v1 MASTER
   ================================================================= */

// --- 01. ENGINE CONFIG & ECONOMY ---
const BEACON_URL = "YOUR_APPS_SCRIPT_URL"; // Replace after deployment
const MASTER_KEY = "ALCHEMIST_MASTER_V1"; 
const START_CREDITS = 10;
const DUMP_REWARD = 0.5;
const MAX_DUMPS = 20;

let RAW_DATA=[], POOL=[], WRONG=[], SESSION_ALL=[];
let XP=0, VOL=10, ATTEMPTED=new Set();
let CREDITS = parseFloat(localStorage.getItem("K1_CREDITS") || START_CREDITS);
let DUMPS_USED = parseInt(localStorage.getItem("K1_DUMPS") || "0");
let VAULT = JSON.parse(localStorage.getItem("K1_VAULT") || "[]");
let VAULT_CURSOR = 0;

// --- 02. HUD & LOGGING ---
function sysLog(msg, type="active") {
    document.getElementById("sys-1").innerText = document.getElementById("sys-2").innerText;
    const l2 = document.getElementById("sys-2"); l2.innerText = `> ${msg}`; l2.className = `log-line ${type}`;
}
function nicLog(msg) {
    document.getElementById("nic-1").innerText = document.getElementById("nic-2").innerText;
    const l2 = document.getElementById("nic-2"); l2.innerText = `${msg} <`;
}

// --- 03. PHYSICS ENGINE (v144.2 BASE) ---
class Physics {
    constructor(el,cb){
        this.el=el; this.cb=cb; this.active=false; this.start={x:0,y:0};
        this.ls={UP:el.querySelector('.sl-up'), LEFT:el.querySelector('.sl-left'), RIGHT:el.querySelector('.sl-right')};
        const s=e=>this.dragStart(e.touches?e.touches[0]:e);
        const m=e=>this.dragMove(e.touches?e.touches[0]:e);
        const e2=()=>this.dragEnd();
        el.addEventListener('mousedown',s); window.addEventListener('mousemove',m); window.addEventListener('mouseup',e2);
        el.addEventListener('touchstart',s); el.addEventListener('touchmove',ev=>{if(this.active)ev.preventDefault();m(ev.touches[0])},{passive:false}); el.addEventListener('touchend',e2);
    }
    dragStart(p){this.active=true; this.start={x:p.clientX, y:p.clientY}; this.el.style.transition="none";}
    dragMove(p){
        if(!this.active)return;
        const dx=p.clientX-this.start.x, dy=p.clientY-this.start.y;
        this.el.style.transform=`translate(${dx}px,${dy}px) rotate(${dx/20}deg)`;
        const d=Math.hypot(dx,dy);
        Object.values(this.ls).forEach(l=>l&&(l.style.opacity=0));
        if(d>30){
            const dir=this.getDir(dx,dy);
            if(this.ls[dir]) this.ls[dir].style.opacity=Math.min(d/60,1);
        }
    }
    dragEnd(){
        if(!this.active)return; this.active=false;
        const m=new WebKitCSSMatrix(getComputedStyle(this.el).transform);
        if(Math.hypot(m.m41, m.m42)>100) this.cb(this.getDir(m.m41,m.m42));
        else { this.el.style.transition="0.3s cubic-bezier(0.2,0.8,0.2,1)"; this.el.style.transform="translate(0,0)"; }
    }
    getDir(x,y){
        const a=(Math.atan2(-y,x)*180/Math.PI+360)%360;
        if(a>45&&a<135)return "UP"; if(a>135&&a<225)return "LEFT"; return "RIGHT";
    }
}

// --- 04. UI RENDERING ---
function render(q, labels, cb, isVault=false, expireStr="") {
    const cont = isVault ? document.getElementById('stack-vault') : document.getElementById('stack-game');
    cont.innerHTML = ''; const el = document.createElement('div'); el.className = isVault ? 'card vault-card' : 'card';
    let timerHtml = isVault ? `<div class="timer-badge">⏳ EXPIRES IN: ${expireStr}</div>` : "";
    el.innerHTML = `${timerHtml}<div class="card-q">${q}</div>
                    <div class="swipe-label sl-up">${labels.up||""}</div>
                    <div class="swipe-label sl-left">${labels.left||""}</div>
                    <div class="swipe-label sl-right">${labels.right||""}</div>`;
    cont.appendChild(el); new Physics(el, cb);
}

// --- 05. GAME LOOP ---
function begin() {
    document.getElementById('stack-vault').classList.remove('active');
    document.getElementById('stack-game').classList.add('active');
    sysLog(`FUEL: ${CREDITS.toFixed(1)} | DUMPS: ${DUMPS_USED}/20`);
    render(`KINETIC v1\n${RAW_DATA.length} UNITS`, {up:"QUIZ", left:"VAULT", right:"SYNC"}, dir => {
        if(dir==="UP") volumePick();
        if(dir==="LEFT") openVault();
        if(dir==="RIGHT") location.reload();
    });
}

function volumePick() {
    render(`SELECT VOLUME`, {up:"10 Q", left:"20 Q", right:"30 Q"}, dir => {
        VOL = dir==="UP" ? 10 : (dir==="LEFT" ? 20 : 30);
        startSession();
    });
}

function startSession() {
    POOL = shuffle([...RAW_DATA]).slice(0, VOL);
    SESSION_ALL = []; XP = 0; ATTEMPTED.clear();
    nextQ();
}

function nextQ() {
    if(!POOL.length) { report(); return; }
    const d = POOL.shift(); SESSION_ALL.push(d);
    const opts = shuffle([d.u, d.l, d.r]);
    nicLog(`${d.dom} | ${d.topic}`);
    render(d.q, {up:opts[0], left:opts[1], right:opts[2]}, dir => {
        const picked = dir==="UP"?opts[0]:(dir==="LEFT"?opts[1]:opts[2]);
        const correct = d.correct==="UP"?d.u:(d.correct==="LEFT"?d.l:d.r);
        if(picked === correct) XP++;
        document.getElementById('xp-ui').innerText = `${XP}/${SESSION_ALL.length} XP`;
        document.getElementById('progress-bar').style.width = `${(SESSION_ALL.length/VOL)*100}%`;
        nextQ();
    });
}

function report() {
    const sid = "SES_" + Math.random().toString(36).substr(2,5).toUpperCase();
    saveToVault(sid);
    sendTelemetry(sid);
    render(`SESSION COMPLETE\nSCORE: ${XP}/${VOL}\nID: ${sid}`, {up:"RESTART", left:"MENU", right:"PDF"}, dir => {
        if(dir==="UP") volumePick();
        if(dir==="LEFT") begin();
        if(dir==="RIGHT") alert("PDF Generation requires 1.0 Credits.");
    });
}

// --- 06. VAULT & TIMER LOGIC (v143.1) ---
function saveToVault(sid) {
    const session = { id: sid, data: [...SESSION_ALL], score: XP, total: VOL, time: Date.now() };
    VAULT.unshift(session);
    localStorage.setItem("K1_VAULT", JSON.stringify(VAULT));
}

function openVault() {
    document.getElementById('stack-game').classList.remove('active');
    document.getElementById('stack-vault').classList.add('active');
    VAULT_CURSOR = 0; showVaultCard();
}

function showVaultCard() {
    if(!VAULT.length || VAULT_CURSOR >= VAULT.length) { begin(); return; }
    const v = VAULT[VAULT_CURSOR];
    const remaining = (24 * 60 * 60 * 1000) - (Date.now() - v.time);
    
    if(remaining <= 0) { 
        VAULT.splice(VAULT_CURSOR, 1); 
        localStorage.setItem("K1_VAULT", JSON.stringify(VAULT));
        showVaultCard(); return; 
    }

    const h = Math.floor(remaining / 3600000);
    const m = Math.floor((remaining % 3600000) / 60000);
    const timerStr = `${h}h ${m}m`;

    render(`${v.id}\nScore: ${v.score}/${v.total}\nDue: ${new Date(v.time + 86400000).getHours()}:${new Date(v.time + 86400000).getMinutes()}`, 
    {up:"NEXT", left:"DUMP (+0.5)", right:"RELOAD (-1)"}, dir => {
        if(dir === "UP") { VAULT_CURSOR++; showVaultCard(); }
        if(dir === "LEFT") executeDump(v);
        if(dir === "RIGHT") executeReload(v);
    }, true, timerStr);
}

function executeDump(v) {
    if(DUMPS_USED >= MAX_DUMPS) { alert("FREE DUMP LIMIT REACHED."); showVaultCard(); return; }
    DUMPS_USED++; CREDITS += DUMP_REWARD;
    localStorage.setItem("K1_DUMPS", DUMPS_USED); localStorage.setItem("K1_CREDITS", CREDITS);
    VAULT.splice(VAULT_CURSOR, 1); localStorage.setItem("K1_VAULT", JSON.stringify(VAULT));
    sysLog("RECLAIMED 0.5"); showVaultCard();
}

function executeReload(v) {
    if(CREDITS < 1) { alert("INSUFFICIENT CREDITS. TOP UP ₹9 FOR 100."); showVaultCard(); return; }
    CREDITS -= 1; localStorage.setItem("K1_CREDITS", CREDITS);
    sysLog("PDF RELOADED");
    // PDF Trigger logic here
    showVaultCard();
}

// --- 07. TELEMETRY & INIT ---
function sendTelemetry(sid) {
    if(!BEACON_URL || BEACON_URL === "YOUR_APPS_SCRIPT_URL") return;
    const payload = { action: "TELEMETRY", ses_id: sid, score: XP, volume: VOL, manifest: SESSION_ALL.map(x=>x.id) };
    fetch(BEACON_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
}

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a;}

async function init() {
    const ld = localStorage.getItem(MASTER_KEY);
    if(ld) RAW_DATA = JSON.parse(ld);
    if(!RAW_DATA.length) {
        try { const r = await fetch('master.json'); if(r.ok) RAW_DATA = await r.json(); } catch(e){}
    }
    RAW_DATA = RAW_DATA.map(d=>({id:d.Question_ID||d.id, q:d.Question_Text||d.q, u:d.Correct_Answer||d.u, l:d.Distractor_1||d.l, r:d.Distractor_2||d.r, correct:d.Correct_Direction||d.correct, dom:d.Domain||d.dom, topic:d.Topic_Label||d.topic}));
    begin();
}
init();
</script>
</body>
</html>
