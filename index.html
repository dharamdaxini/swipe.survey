<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ALCHEMIST V130.88 | DIAGNOSTIC EXPORT</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,600;1,600&family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #000; --card: #111; --border: #262626; --gold: #ffd600; --green: #2ecc71; --blue: #2979FF; --font-chem: 'Crimson Text', serif; --font-ui: 'Inter', sans-serif; --font-code: 'JetBrains Mono', monospace; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; height: 100vh; background: var(--bg); color: #fff; font-family: var(--font-ui); overflow: hidden; display: flex; flex-direction: column; }
        
        #header { width: 92%; margin: 25px auto 10px; flex-shrink: 0; z-index: 9000; display: none; position: relative; }
        .progress-track { width: 100%; height: 3px; background: #1a1a1a; margin-top: 10px; border-radius: 10px; overflow: hidden; }
        #progress-bar { height: 100%; background: var(--gold); width: 0%; transition: 0.8s; }
        #session-log { position: absolute; top: 42px; left: 0; font-family: var(--font-code); font-size: 0.85rem; color: #444; z-index: 9500; pointer-events: auto; }

        #portal { flex: 1; padding: 30px; overflow-y: auto; padding-bottom: 150px; }
        h1 { color: var(--gold); letter-spacing: 5px; font-size: 1.4rem; text-transform: uppercase; text-align: center; }
        #library { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .topic-tile { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 15px; text-align: center; aspect-ratio: 1.6/1; display: flex; align-items: center; justify-content: center; }
        
        #import-section { margin-top: 30px; border-top: 1px solid #111; padding-top: 20px; }
        textarea { width: 100%; height: 160px; background: #050505; border: 1px solid var(--border); border-radius: 12px; color: #00FF41; font-family: var(--font-code); font-size: 0.7rem; padding: 15px; resize: none; margin-bottom: 12px; }

        .btn-stack { display: flex; flex-direction: column; gap: 10px; }
        .btn-inject { width: 100%; padding: 16px; background: var(--blue); color: #fff; border: none; border-radius: 12px; font-weight: 900; text-transform: uppercase; cursor: pointer; font-size: 0.85rem; }
        .btn-tsv { width: 100%; padding: 12px; background: #111; border: 1px solid var(--blue); color: var(--blue); border-radius: 12px; font-weight: 700; text-transform: uppercase; cursor: pointer; font-size: 0.7rem; display: none; }

        #stack { position: absolute; top: 52%; left: 50%; transform: translate(-50%, -50%); width: 94%; height: 55vh; perspective: 1500px; display: none; transform-origin: calc(50% + 13.2px) calc(50% + 13.2px); }
    </style>
</head>
<body>

<div id="header">
    <div class="progress-track"><div id="progress-bar"></div></div>
    <div id="session-log"><span onclick="location.reload()">> READY</span></div>
</div>

<div id="portal">
    <h1>Alchemist.v130</h1>
    <div id="library"></div>
    
    <div id="import-section">
        <div style="font-family:var(--font-code);font-size:0.6rem;color:#444;margin-bottom:8px;">R1 UPSERT & DIAGNOSTIC EXPORT</div>
        <textarea id="data-input" placeholder="Paste datasets... Merged by ID automatically."></textarea>
        <div class="btn-stack">
            <button id="inject-btn" class="btn-inject" onclick="executeUpsert()">Execute R1 Injection</button>
            <button id="download-btn" class="btn-tsv" onclick="downloadTSV()">Download as TSV (Check)</button>
        </div>
    </div>
</div>

<div id="stack"></div>

<script>
    let db, currentBuffer = [];
    const R1_SCHEMA = ["ID", "SET", "DOM", "DEP", "QUESTION", "UP", "RIGHT", "LEFT", "ANS", "EXPL", "HINT", "CONTEXT"];

    async function executeUpsert() {
        const raw = document.getElementById('data-input').value.trim();
        if (!raw) return;

        try {
            let lines = raw.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
            let headerIdx = lines.findIndex(l => l.toLowerCase().includes("id") || l.toLowerCase().includes("question"));
            if (headerIdx === -1) throw new Error("Header Recognition Failure");

            const headers = lines[headerIdx].toLowerCase().split(/\t|,|\|/).map(h => h.trim());
            const rows = lines.slice(headerIdx + 1);
            const mapIdx = {}; R1_SCHEMA.forEach(h => { mapIdx[h] = headers.findIndex(uh => uh.includes(h.toLowerCase()) || h.toLowerCase().includes(uh)); });

            const currentPasteMap = new Map();
            rows.forEach(row => {
                const cells = row.split(/\t|,|\|/).map(c => c.trim().replace(/^"|"$/g, ''));
                if (cells.length < 2) return;
                let entry = {}; R1_SCHEMA.forEach(h => { entry[h.toLowerCase()] = (mapIdx[h] !== -1 && cells[mapIdx[h]]) ? cells[mapIdx[h]] : "---"; });
                currentPasteMap.set(entry.id, entry); 
            });

            currentBuffer = Array.from(currentPasteMap.values());
            document.getElementById('download-btn').style.display = 'block';

            const vaultName = prompt("Successful! Assign Research Name:", "SET_F_SOVEREIGN");
            if (!vaultName) return;

            const tx = db.transaction(["Vaults"], "readwrite");
            const store = tx.objectStore("Vaults");
            const existing = await new Promise(r => { store.get(vaultName).onsuccess = e => r(e.target.result || []); });
            
            const dbMap = new Map(existing.map(obj => [obj.id, obj]));
            currentPasteMap.forEach((val, key) => dbMap.set(key, val));

            await new Promise((resolve, reject) => {
                const req = store.put(Array.from(dbMap.values()), vaultName);
                req.onsuccess = resolve; req.onerror = reject;
            });

            document.getElementById('inject-btn').innerText = "UPSERT SUCCESSFUL";
            setTimeout(() => location.reload(), 1200);
        } catch (e) { alert(e.message); }
    }

    function downloadTSV() {
        if (!currentBuffer.length) return;
        let tsvContent = R1_SCHEMA.join("\t") + "\n";
        currentBuffer.forEach(row => {
            tsvContent += R1_SCHEMA.map(h => row[h.toLowerCase()]).join("\t") + "\n";
        });
        const blob = new Blob([tsvContent], { type: 'text/tab-separated-values' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `ALCHEMIST_EXPORT_${new Date().getTime()}.tsv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    const request = indexedDB.open("AlchemistDB", 1);
    request.onupgradeneeded = e => { e.target.result.createObjectStore("Vaults"); };
    request.onsuccess = e => { db = e.target.result; renderLibrary(); };

    function renderLibrary() {
        const container = document.getElementById('library');
        const store = db.transaction(["Vaults"], "readonly").objectStore("Vaults");
        store.openCursor().onsuccess = e => {
            const cursor = e.target.result;
            if (cursor) {
                const div = document.createElement('div'); div.className = "topic-tile";
                div.innerHTML = `<span style="color:var(--gold);font-weight:900;font-size:0.8rem;">${cursor.key}</span>`;
                container.appendChild(div);
                cursor.continue();
            }
        };
    }
</script>
</body>
</html>
