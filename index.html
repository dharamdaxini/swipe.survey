<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>Alchemist | Operator UI v136.25</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
 --bg:#000;
 --card:#121212;
 --border:#333;
 --text-main:#e6e6e6;
 --text-grey:#9a9a9a;
 --font-serif:'Crimson Text',serif;
 --font-sans:'Inter',sans-serif;
 --font-code:'JetBrains Mono',monospace;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

body{
 margin:0;height:100vh;background:var(--bg);
 color:var(--text-main);
 font-family:var(--font-sans);
 overflow:hidden;display:flex;flex-direction:column;
}

/* HEADER */
#header{width:90%;margin:25px auto 0}
.header-meta{
 display:flex;justify-content:space-between;
 font-family:var(--font-code);
 font-size:.75rem;color:#666;
 letter-spacing:1.5px;text-transform:uppercase;
}
#review-text{
 margin-top:18px;
 font-family:var(--font-serif);
 font-size:1.25rem;
 font-style:italic;
 text-align:center;
 color:#777;
 min-height:3em;
}

/* PROGRESS */
.progress-track{width:100%;height:3px;background:#222;margin-top:14px;border-radius:2px}
#progress-bar{height:100%;background:#666;width:0%;transition:width .4s ease}

/* STACK */
#stack{
 position:relative;
 width:90%;
 max-width:420px;
 height:62vh;
 margin:auto;
 perspective:1500px;
 display:flex;
 align-items:center;
 justify-content:center;
}

.card{
 position:absolute;
 width:100%;
 height:95%;
 background:var(--card);
 border-radius:14px;
 border:1px solid var(--border);
 padding:36px;
 display:flex;
 justify-content:center;
 align-items:center;
 box-shadow:0 20px 60px rgba(0,0,0,.95);
 transform-style:preserve-3d;
 overflow:hidden;
}

/* MAIN TEXT */
.card-q{
 font-family:var(--font-serif);
 font-size:clamp(1.15rem,4vw,1.75rem);
 line-height:1.55;
 font-weight:600;
 text-align:center;
 color:var(--text-main);
 width:100%;
 max-height:100%;
 overflow-y:auto;
 padding:0 6px;
 opacity:0;
 transform:translateY(10px);
 transition:opacity .35s ease,transform .35s ease;
}
.card-q.show{opacity:1;transform:translateY(0)}

.card-q::-webkit-scrollbar{width:4px}
.card-q::-webkit-scrollbar-thumb{background:#333;border-radius:2px}

.card-q sub{font-size:.7em;vertical-align:-.3em}
.card-q sup{font-size:.7em;vertical-align:.5em}

/* SWIPE LABELS */
.swipe-label{
 position:absolute;inset:0;
 display:flex;align-items:center;justify-content:center;
 background:#000;
 font-family:var(--font-sans);
 font-weight:700;
 font-size:1.5rem;
 letter-spacing:1px;
 text-transform:uppercase;
 color:var(--text-grey);
 opacity:0;
 pointer-events:none;
 padding:40px;
 text-align:center;
 border-radius:14px;
 border:1px solid #333;
 transition:opacity .18s ease,transform .18s ease;
 transform:scale(.98);
}
.swipe-label.active{opacity:1;transform:scale(1)}
</style>
</head>

<body>

<div id="header">
 <div class="header-meta">
  <span id="id-ui">BOOT</span>
  <span id="xp-ui">0 XP</span>
 </div>
 <div id="review-text"></div>
 <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="stack">
 <div class="card">
  <div class="card-q show" style="font-family:var(--font-code);font-size:.9rem;color:#666">
   VIA.STACK | OPERATOR<br>INITIALIZINGâ€¦
  </div>
 </div>
</div>

<script>
/* ================= CONFIG ================= */
const MASTER_KEY="ALCHEMIST_MASTER_V1";

/* ================= STATE ================= */
let RAW_DATA=[],POOL=[],SESSION_ALL=[],XP=0;

/* ================= UTILS ================= */
const chemText=t=>!t?"":String(t)
 .replace(/_([0-9]+)/g,"<sub>$1</sub>")
 .replace(/\^([0-9+\-]+)/g,"<sup>$1</sup>");

const shuffle=a=>{
 for(let i=a.length-1;i>0;i--){
  const j=Math.floor(Math.random()*(i+1));
  [a[i],a[j]]=[a[j],a[i]];
 }
 return a;
};

/* ================= UI ================= */
const UI={
 stack:document.getElementById("stack"),
 id:document.getElementById("id-ui"),
 xp:document.getElementById("xp-ui"),
 bar:document.getElementById("progress-bar"),
 review:document.getElementById("review-text")
};

/* ================= PHYSICS (UNCHANGED) ================= */
class PhysicsController{
 constructor(el,cbs){
  this.el=el;this.cbs=cbs;this.active=false;this.start={x:0,y:0};
  this.labels={
   UP:el.querySelector(".sl-up"),
   LEFT:el.querySelector(".sl-left"),
   RIGHT:el.querySelector(".sl-right"),
   DOWN:el.querySelector(".sl-down")
  };
  const s=e=>this.startDrag(e.touches?e.touches[0]:e);
  const m=e=>this.move(e.touches?e.touches[0]:e);
  const e2=()=>this.end();
  el.addEventListener("mousedown",s);
  window.addEventListener("mousemove",m);
  window.addEventListener("mouseup",e2);
  el.addEventListener("touchstart",s,{passive:false});
  el.addEventListener("touchmove",ev=>{if(this.active)ev.preventDefault();m(ev)},{passive:false});
  el.addEventListener("touchend",e2);
 }
 startDrag(p){this.active=true;this.start={x:p.clientX,y:p.clientY};this.el.style.transition="none"}
 move(p){
  if(!this.active)return;
  const dx=p.clientX-this.start.x,dy=p.clientY-this.start.y;
  const d=Math.hypot(dx,dy);
  this.el.style.transform=`translate(${dx}px,${dy}px) rotate(${dx/25}deg)`;
  Object.values(this.labels).forEach(l=>l&&(l.classList.remove("active")));
  if(d>20){
   const dir=this.dir(dx,dy);
   this.labels[dir]&&(this.labels[dir].classList.add("active"));
  }
 }
 end(){
  if(!this.active)return;
  this.active=false;
  const m=new WebKitCSSMatrix(getComputedStyle(this.el).transform);
  if(Math.hypot(m.m41,m.m42)>100)this.cbs.onCommit(this.dir(m.m41,m.m42));
  else this.el.style.transform="translate(0,0)";
 }
 dir(dx,dy){
  const a=(Math.atan2(-dy,dx)*180/Math.PI+360)%360;
  if(a>45&&a<135)return"UP";
  if(a>135&&a<225)return"LEFT";
  if(a>225&&a<315)return"DOWN";
  return"RIGHT";
 }
}

/* ================= RENDER ================= */
function card(text,labels,cb){
 UI.stack.innerHTML="";
 const el=document.createElement("div");
 el.className="card";
 el.innerHTML=`
  <div class="card-q">${chemText(text).replace(/\n/g,"<br>")}</div>
  <div class="swipe-label sl-up">${labels.up||""}</div>
  <div class="swipe-label sl-left">${labels.left||""}</div>
  <div class="swipe-label sl-right">${labels.right||""}</div>
  <div class="swipe-label sl-down">${labels.down||""}</div>`;
 UI.stack.appendChild(el);
 requestAnimationFrame(()=>el.querySelector(".card-q").classList.add("show"));
 new PhysicsController(el,{onCommit:cb});
}

/* ================= FLOW ================= */
function begin(){
 card("BEGIN SESSION",{up:"QUIZ"},d=>d==="UP"&&startQuiz());
}

function startQuiz(){
 POOL=shuffle([...RAW_DATA]);
 SESSION_ALL=[];XP=0;
 nextQ();
}

function nextQ(){
 if(!POOL.length)return exportPDF();
 const d=POOL.shift();
 SESSION_ALL.push(d);
 UI.id.textContent=d.id;

 const opts=shuffle([d.u,d.l,d.r]);
 const map={up:opts[0],left:opts[1],right:opts[2]};

 card(d.q,map,dir=>{
  const picked=dir==="UP"?map.up:dir==="LEFT"?map.left:map.right;
  if(picked.trim().toLowerCase()===d.u.trim().toLowerCase())XP++;
  UI.xp.textContent=`${XP} / ${SESSION_ALL.length}`;
  UI.bar.style.width=`${(SESSION_ALL.length/(SESSION_ALL.length+POOL.length))*100}%`;
  nextQ();
 });
}

/* ================= PDF (FIXED STEPS) ================= */
function exportPDF(){
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();
 let y=20;

 SESSION_ALL.forEach(d=>{
  if(y>250){doc.addPage();y=20}
  doc.setFont("times","bold");doc.setFontSize(12);
  doc.text(d.q,10,y);y+=10;

  doc.setFont("helvetica","normal");doc.setFontSize(10);
  doc.text(`A) ${d.u}`,10,y);y+=6;
  doc.text(`B) ${d.l}`,10,y);y+=6;
  doc.text(`C) ${d.r}`,10,y);y+=6;

  doc.setFont("times","italic");
  doc.text(d.logic||"",10,y);y+=10;

  const s1=d.s1||d.step1||d.exec1||"-";
  const s2=d.s2||d.step2||d.exec2||"-";

  doc.text(`1. ${s1}`,10,y);y+=6;
  doc.text(`2. ${s2}`,10,y);y+=10;
 });

 doc.save(`SESSION_${Date.now()}.pdf`);
 begin();
}

/* ================= INIT ================= */
function init(){
 const raw=localStorage.getItem(MASTER_KEY);
 RAW_DATA=raw?JSON.parse(raw):[];
 begin();
}
init();
</script>

</body>
</html>
