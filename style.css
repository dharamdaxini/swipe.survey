:root { 
    --bg: #000; --card: #111; --border: #262626; 
    --gold: #ffd600; --green: #2ecc71; --blue: #3498db;
    --font-chem: 'Crimson Text', serif; --font-ui: 'Inter', sans-serif; --font-code: 'JetBrains Mono', monospace; 
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body { margin: 0; height: 100vh; background: var(--bg); color: #fff; font-family: var(--font-ui); overflow: hidden; touch-action: none; display: flex; flex-direction: column; }

/* Formula Physics & Visuality */
sub { font-size: 0.7em; vertical-align: baseline; position: relative; bottom: -0.2em; }
sup { font-size: 0.7em; vertical-align: baseline; position: relative; top: -0.4em; }

#header { width: 92%; margin: 20px auto 10px; flex-shrink: 0; z-index: 1000; }
.header-meta { display: flex; justify-content: space-between; font-family: var(--font-code); font-size: 0.85rem; color: #777; letter-spacing: 2px; font-weight: 900; }
.progress-track { width: 100%; height: 4px; background: #1a1a1a; margin-top: 12px; border-radius: 2px; overflow: hidden; }
#progress-bar { height: 100%; background: var(--gold); width: 0%; transition: width 0.4s ease; box-shadow: 0 0 15px rgba(255, 214, 0, 0.4); }

#history-tape { width: 90%; margin: 0 auto; flex-grow: 1; max-height: 10vh; overflow-y: auto; display: flex; flex-direction: column-reverse; font-family: var(--font-code); font-size: 0.75rem; text-align: right; border-right: 2px solid #222; padding-right: 12px; mask-image: linear-gradient(to bottom, transparent 0%, black 40%); -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 40%); }
.log-item { margin-bottom: 4px; color: #333; text-transform: uppercase; transition: 0.3s; }
.log-item.active { color: var(--green); font-weight: 900; }

#stack { position: relative; width: 94%; max-width: 420px; height: 62vh; margin: 0 auto 30px; perspective: 1500px; display: flex; align-items: center; justify-content: center; }

/* V81.1 Touch Profile */
.card { 
    position: absolute; width: 100%; height: 100%; background: var(--card); 
    border-radius: 44px; border: 1px solid var(--border); padding: 35px; 
    display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; 
    box-shadow: 0 40px 100px rgba(0,0,0,0.9); 
    will-change: transform, opacity;
    transform-origin: center center;
    transition: transform 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* V81.1 Elastic Snap */
}

.card-q { font-family: var(--font-chem); font-size: clamp(22px, 5.5vmin, 30px); line-height: 1.35; font-weight: 600; color: #ffffff; width: 100%; max-height: 80%; overflow-y: auto; scrollbar-width: none; }
.swipe-label { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.92); color: #fff; font-weight: 900; font-size: clamp(0.9rem, 3.5vw, 1.6rem); text-transform: uppercase; border-radius: 44px; z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.1s; border: 2px solid var(--gold); padding: 20px; text-align: center; }

.overlay { position: absolute; inset: 0; background: #080808; z-index: 1100; padding: 35px; border-radius: 44px; display: none; flex-direction: column; border: 1px solid var(--gold); text-align: left; }
.overlay.active { display: flex; opacity: 1; pointer-events: auto; }
.overlay-body { font-size: 1.15rem; line-height: 1.6; color: #dddddd; font-family: var(--font-chem); overflow-y: auto; flex-grow: 1; margin-bottom: 20px; scrollbar-width: none; }
.btn { width: 100%; padding: 22px; border-radius: 100px; border: none; background: #fff; color: #000; font-weight: 900; text-transform: uppercase; cursor: pointer; font-family: var(--font-ui); }
#loader { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; font-family: var(--font-code); color: var(--gold); letter-spacing: 10px; font-weight: 900; }


/* V106.3 | MAGNETIC PHYSICS ENGINE */
function bindPhysics(el, data) {
    let x = 0, y = 0, sx = 0, sy = 0, active = false, td = null;
    const lbs = { up: el.querySelector('.sl-up'), dn: el.querySelector('.sl-down'), lt: el.querySelector('.sl-left'), rt: el.querySelector('.sl-right') };
    
    // 1cm radius in pixels (approx 38px for mobile)
    const MAX_RADIUS = 38; 

    el.onmousedown = el.ontouchstart = e => { 
        active = true; 
        const p = e.touches ? e.touches[0] : e; 
        sx = p.clientX; sy = p.clientY; 
        el.style.transition = "none"; 
    };
    
    window.onmousemove = window.ontouchmove = e => { 
        if (!active) return; 
        const p = e.touches ? e.touches[0] : e; 
        let dx = p.clientX - sx; 
        let dy = p.clientY - sy; 
        
        // Calculate current distance from center
        const distance = Math.sqrt(dx*dx + dy*dy);
        
        // Apply 1cm Radius Constraint (Magnetic Tether)
        if (distance > MAX_RADIUS) {
            const ratio = MAX_RADIUS / distance;
            x = dx * ratio;
            y = dy * ratio;
        } else {
            x = dx;
            y = dy;
        }
        
        requestAnimationFrame(() => {
            if (active) {
                // High tilt (divisor 12) for a responsive feel in small movements
                el.style.transform = `translate3d(${x}px,${y}px,0) rotate(${dx/12}deg) scale(1.05)`; 
            }
        });
        
        const ang = Math.atan2(-dy, dx) * (180 / Math.PI);
        Object.values(lbs).forEach(l => { if (l) l.style.opacity = 0; });
        
        // Trigger swipe labels earlier due to small radius
        if (distance > 20) {
            let d = (ang >= 45 && ang < 135) ? "up" : (ang >= 135 || ang < -135) ? "lt" : (ang >= -135 && ang < -45) ? "dn" : "rt";
            if (lbs[d]) lbs[d].style.opacity = 1; 
            td = d.toUpperCase();
        }
    };
    
    window.onmouseup = window.ontouchend = e => { 
        if (!active) return; 
        active = false; 
        
        const p = e.changedTouches ? e.changedTouches[0] : e;
        const finalDist = Math.sqrt(Math.pow(p.clientX - sx, 2) + Math.pow(p.clientY - sy, 2));

        // Threshold to execute action (If pulled near the 1cm limit)
        if (finalDist > 30) {
            handleAction(el, data, td);
        } else { 
            el.style.transition = "transform 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.275)"; 
            el.style.transform = "none"; 
        } 
    };
}
