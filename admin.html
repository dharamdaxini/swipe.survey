<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIA.STACK | PDF TRANSMUTER v137.11</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#050505; --card:#111; --border:#222;
  --gold:#ffd600; --green:#2ecc71; --blue:#2979ff;
  --font-ui:'Inter',sans-serif; --font-code:'JetBrains Mono',monospace;
}
*{box-sizing:border-box}
body{
  margin:0; height:100vh; background:var(--bg); color:#eee;
  font-family:var(--font-ui); display:flex; flex-direction:column;
  align-items:center; justify-content:center;
}

.container{
  text-align:center; width:90%; max-width:450px;
  background:var(--card); border:1px solid var(--border);
  padding:40px; border-radius:16px;
}

.brand{font-weight:900; letter-spacing:1px; margin-bottom:10px;}
.brand span{color:var(--gold);}

.upload-box{
  margin-top:20px;
  border:2px dashed #333; border-radius:8px;
  padding:30px; transition:.2s; cursor:pointer;
}
.upload-box:hover{ border-color:var(--gold); background:#1a1a1a; }

.status{
  margin-top:20px; font-family:var(--font-code); 
  font-size:0.8rem; color:#666; height:20px;
}
.status.active{ color:var(--green); }
.status.error{ color:#ff4444; }

/* DUAL BUTTONS */
#download-area {
  display: none; margin-top: 25px; gap: 10px; flex-direction: column;
}

.btn {
  width: 100%; padding: 15px; border-radius: 8px;
  font-family: var(--font-code); font-size: 0.8rem; font-weight: 700;
  text-transform: uppercase; cursor: pointer; transition: 0.2s;
  border: 1px solid var(--border); background: #1a1a1a; color: #aaa;
  display: flex; justify-content: space-between; align-items: center;
}
.btn:hover { border-color: var(--gold); color: #fff; }
.btn.primary { background: var(--gold); color: #000; border-color: var(--gold); }
.btn.primary:hover { opacity: 0.9; }

.btn-icon { font-size: 1.2em; }

</style>
</head>
<body>

<div class="container">
  <div class="brand">VIA.<span>STACK</span> // TRANSMUTER</div>
  <div style="font-size:0.8rem; color:#666">SESSION PDF ‚ûî DUAL EXPORT</div>

  <div class="upload-box" id="drop-zone" onclick="document.getElementById('fileIn').click()">
    <div style="font-size:2rem; margin-bottom:10px">üìÑ</div>
    <div style="font-weight:700; font-size:0.9rem">CLICK TO UPLOAD PDF</div>
    <div style="font-size:0.7rem; color:#555; margin-top:5px">Supports Alphanumeric IDs</div>
  </div>
  
  <input type="file" id="fileIn" hidden accept="application/pdf" onchange="loadPDF(this)">
  
  <div class="status" id="status">WAITING FOR INPUT...</div>

  <div id="download-area">
    <button class="btn" onclick="triggerDownload('SESSION')">
      <span>SESSION PDF</span>
      <span class="btn-icon">üìù</span>
    </button>
    <button class="btn primary" onclick="triggerDownload('SUPPORT')">
      <span>SUPPORT PDF</span>
      <span class="btn-icon">üìö</span>
    </button>
  </div>
</div>

<script>
// --- CONFIG ---
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// --- STATE ---
let PARSED_DATA = [];

// --- 1. ENGINE: EXTRACTION (Linear Sort) ---
async function loadPDF(inp){
  const f = inp.files[0];
  if(!f) return;
  
  document.getElementById('download-area').style.display = 'none';
  document.getElementById('drop-zone').style.opacity = '0.5';
  updateStatus("READING FILE...", "active");
  
  try {
    const buf = await f.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    let fullText = "";

    // Extract text page by page
    for(let i=1; i<=pdf.numPages; i++){
      updateStatus(`PARSING PAGE ${i} OF ${pdf.numPages}...`, "active");
      const p = await pdf.getPage(i);
      const c = await p.getTextContent();
      
      const lines = {};
      c.items.forEach(it => {
        const y = Math.round(it.transform[5]); 
        if(!lines[y]) lines[y] = [];
        lines[y].push({ x: it.transform[4], str: it.str });
      });

      const ordered = Object.keys(lines)
        .sort((a,b) => b - a) 
        .map(y => lines[y].sort((a,b) => a.x - b.x).map(o => o.str).join(" "))
        .join("\n");

      fullText += ordered + "\n";
    }

    updateStatus("ANALYZING STRUCTURE...", "active");
    PARSED_DATA = parseVaultText(fullText);
    
    if(PARSED_DATA.length === 0) throw new Error("NO QUESTIONS FOUND.");
    
    updateStatus(`READY: ${PARSED_DATA.length} UNITS RECONSTRUCTED`, "active");
    document.getElementById('download-area').style.display = 'flex';
    document.getElementById('drop-zone').innerHTML = '<div style="font-size:2rem">‚úÖ</div><div style="font-weight:700">FILE PROCESSED</div>';
    inp.value = ""; 

  } catch(e) {
    console.error(e);
    updateStatus("ERROR: " + e.message, "error");
    document.getElementById('drop-zone').style.opacity = '1';
  }
}

// --- 2. ENGINE: PARSER (Alphanumeric Support) ---
function parseVaultText(text){
  const lines = text.split(/\n+/).map(l => l.trim()).filter(Boolean);
  const out = [];
  let cur = null;

  const flush = () => {
    if(cur && cur.u && cur.l && cur.r){
      if(!cur.correct) cur.correct = "UP"; 
      if(!cur.trap) cur.trap = "";
      if(!cur.step1) cur.step1 = "‚Äî";
      if(!cur.step2) cur.step2 = "‚Äî";
      delete cur._stepMode;
      out.push(cur);
    }
    cur = null;
  };

  lines.forEach(l=>{
    if(/^(EXECUTION|THEORY|LOGIC|OPTIONS)/.test(l)) return;

    // PATCH: HEADER DETECTION FOR ALPHANUMERIC IDs
    // Matches: "Q1 | A_001" OR "A_001 // Dom > Topic" OR "175 // ..."
    const isSessionHeader = /^Q\d+\s*\|\s*[\w-]+/.test(l);
    const isVaultHeader = /^[\w-]+\s*\/\//.test(l);

    if(isSessionHeader || isVaultHeader){
      flush();
      
      let rawID = "000";
      let dom = "GENERAL";
      let topic = "CONCEPTS";

      if(l.includes("//")){
        // Format: "A_001 // Domain > Topic"
        rawID = l.split("//")[0].trim();
        const meta = l.split("//")[1].split(">");
        if(meta[0]) dom = meta[0].trim();
        if(meta[1]) topic = meta[1].trim();
      }
      else if(l.includes("|")){
        // Format: "Q1 | A_001"
        const parts = l.split("|");
        if(parts[1]) rawID = parts[1].trim().split(" ")[0];
      }

      cur = { 
        id: rawID, dom: dom, topic: topic,
        q:"", u:"", l:"", r:"", correct:"", logic:"", 
        trap:"", step1:"", step2:"" 
      };
      return;
    }

    if(!cur) return;

    if(l.startsWith("A)")) cur.u = l.replace(/^\(A\)\s*|^A\)\s*/, "");
    else if(l.startsWith("B)")) cur.l = l.replace(/^\(B\)\s*|^B\)\s*/, "");
    else if(l.startsWith("C)")) cur.r = l.replace(/^\(C\)\s*|^C\)\s*/, "");
    else if(l.startsWith("ANSWER:")) cur.correct = l.replace("ANSWER:", "").trim();
    else if(l.startsWith("LOGIC:")) cur.logic += l.replace("LOGIC:", "").trim() + " ";
    else if(l.startsWith("DISTRACTOR ANALYSIS:")) cur.trap = l.replace("DISTRACTOR ANALYSIS:", "").trim();
    
    // EXECUTION STATE MACHINE
    else if(/^1\s*\./.test(l)) { 
      cur._stepMode = 1;
      cur.step1 = l.replace(/^1\s*\.\s*/, "").trim();
    }
    else if(/^2\s*\./.test(l)) { 
      cur._stepMode = 2;
      cur.step2 = l.replace(/^2\s*\.\s*/, "").trim();
    }
    else if(cur._stepMode === 1) {
      cur.step1 += " " + l;
    }
    else if(cur._stepMode === 2) {
      cur.step2 += " " + l;
    }
    else {
      if(!cur.u) cur.q += l + " "; 
      else if(cur.logic && !cur.trap && !cur._stepMode) cur.logic += l + " ";
    }
  });

  flush();
  return out;
}

// --- 3. EXPORT ROUTER ---
function triggerDownload(mode) {
    // Normalization ensures fields exist, but we keep raw values if valid
    const normalized = PARSED_DATA.filter(d => d.id && d.q);
    if(mode === 'SESSION') renderSessionPDF(normalized);
    if(mode === 'SUPPORT') renderSupportPDF(normalized);
}

// --- RENDERER A: SESSION PDF ---
function renderSessionPDF(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;
    const clean = t => String(t||"").replace(/<[^>]*>/g,"").replace(/&Delta;/g,"Œî").trim();

    const header = () => {
        doc.setFont("times", "bold"); doc.setFontSize(16); doc.setTextColor(0);
        doc.text("ALCHEMIST // SESSION WORKSHEET", 15, 20);
        doc.setLineWidth(0.5); doc.line(15, 25, 195, 25);
        y = 35;
    };

    header();

    data.forEach((d, i) => {
        if (y > 260) { doc.addPage(); header(); }

        doc.setFont("courier", "bold"); doc.setFontSize(11);
        doc.text(`Q${i+1} | ${d.id}`, 15, y); 
        y += 6;

        doc.setFont("times", "normal"); doc.setFontSize(11);
        const qLines = doc.splitTextToSize(clean(d.q), 180);
        doc.text(qLines, 15, y);
        y += qLines.length * 5 + 2;

        doc.setFont("helvetica", "normal"); doc.setFontSize(10); doc.setTextColor(60);
        doc.text(`(A) ${clean(d.u)}`, 15, y); y += 5;
        doc.text(`(B) ${clean(d.l)}`, 15, y); y += 5;
        doc.text(`(C) ${clean(d.r)}`, 15, y); y += 10; 
        
        doc.setTextColor(0); 
    });

    doc.save(`SESSION_PDF_${Date.now()}.pdf`);
}

// --- RENDERER B: SUPPORT PDF ---
function renderSupportPDF(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;

    const ML = 15; const W = 180;
    const COL_W = { OPT: 45, LOG: 65, EXE: 65 };
    const COL_X = { OPT: ML, LOG: ML + 45 + 5, EXE: ML + 45 + 65 + 10 };
    const clean = t => String(t||"").replace(/<[^>]*>/g,"").replace(/&Delta;/g,"Œî").trim();

    // Answer Normalization
    data.forEach(d => {
        const a = (d.correct || "").trim().toUpperCase();
        if(a === "A" || a === "UP" || a.includes("(A)")) d.correct = d.u;
        else if(a === "B" || a === "LEFT" || a.includes("(B)")) d.correct = d.l;
        else if(a === "C" || a === "RIGHT" || a.includes("(C)")) d.correct = d.r;
    });

    const header = () => {
        doc.setFont("times", "bold"); doc.setFontSize(16); doc.setTextColor(0);
        doc.text("ALCHEMIST // ACADEMY REPORT", 105, 15, {align:"center"});
        doc.setDrawColor(0); doc.setLineWidth(0.5);
        doc.line(ML, 18, 195, 18); doc.line(ML, 19, 195, 19); 
        y = 25;
    };

    header();

    data.forEach((d, i) => {
        if(!d.q || !d.u) return;

        if (y > 230) { doc.addPage(); header(); }

        doc.setFont("helvetica", "bold"); doc.setFontSize(8); doc.setTextColor(100);
        const headerText = `${d.id} // ${d.dom.toUpperCase()} > ${d.topic}`;
        doc.text(headerText, ML, y);
        y += 6;

        doc.setFont("times", "bold"); doc.setFontSize(12); doc.setTextColor(0);
        const qLines = doc.splitTextToSize(clean(d.q), W);
        doc.text(qLines, ML, y);
        y += (qLines.length * 5) + 4;

        doc.setDrawColor(180); doc.setLineWidth(0.3);
        doc.line(ML, y, 195, y); doc.line(ML, y+1, 195, y+1);
        y += 6;

        doc.setFont("helvetica", "bold"); doc.setFontSize(7); doc.setTextColor(150);
        doc.text("OPTIONS", COL_X.OPT, y);
        doc.text("THEORY & LOGIC", COL_X.LOG, y);
        doc.text("EXECUTION", COL_X.EXE, y);
        y += 5;

        const contentY = y;
        let maxH = y;

        doc.setFont("helvetica", "normal"); doc.setFontSize(9); doc.setTextColor(80);
        let optY = contentY;
        const optA = doc.splitTextToSize(`(A) ${clean(d.u)}`, COL_W.OPT);
        const optB = doc.splitTextToSize(`(B) ${clean(d.l)}`, COL_W.OPT);
        const optC = doc.splitTextToSize(`(C) ${clean(d.r)}`, COL_W.OPT);
        doc.text(optA, COL_X.OPT, optY); optY += optA.length*4 + 2;
        doc.text(optB, COL_X.OPT, optY); optY += optB.length*4 + 2;
        doc.text(optC, COL_X.OPT, optY); optY += optC.length*4 + 2;
        if(optY > maxH) maxH = optY;

        doc.setFont("times", "italic"); doc.setTextColor(50);
        const logLines = doc.splitTextToSize(clean(d.logic) || "Analysis pending.", COL_W.LOG);
        doc.text(logLines, COL_X.LOG, contentY);
        const logH = contentY + (logLines.length * 4);
        if(logH > maxH) maxH = logH;

        doc.setFont("helvetica", "normal"); doc.setTextColor(0);
        const s1 = `1. ${clean(d.step1)}`;
        const s2 = `2. ${clean(d.step2)}`;
        const s1L = doc.splitTextToSize(s1, COL_W.EXE);
        const s2L = doc.splitTextToSize(s2, COL_W.EXE);
        let exeY = contentY;
        doc.text(s1L, COL_X.EXE, exeY); exeY += s1L.length*4 + 2;
        doc.text(s2L, COL_X.EXE, exeY); exeY += s2L.length*4;
        if(exeY > maxH) maxH = exeY;

        y = maxH + 6;

        if(d.trap && d.trap !== "undefined") {
            doc.setLineDash([1, 1], 0); doc.setDrawColor(200); doc.line(ML, y, 195, y); doc.setLineDash([]);
            y += 4;
            doc.setFont("helvetica", "bold"); doc.setFontSize(8); doc.setTextColor(200, 50, 50);
            doc.text("DISTRACTOR ANALYSIS:", ML, y);
            doc.setFont("times", "italic"); doc.setTextColor(80);
            doc.text(clean(d.trap), ML + 35, y);
            y += 8;
        }
        y += 6; 
    });

    doc.save(`SUPPORT_PDF_${Date.now()}.pdf`);
}

// --- UTILS ---
function updateStatus(msg, type){
  const el = document.getElementById("status");
  el.innerText = msg;
  el.className = "status " + type;
}
</script>

</body>
</html>
