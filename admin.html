<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VIA.STACK | ADMIN v136.53</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
 --bg:#050505; --panel:#0a0a0a; --border:#222;
 --gold:#ffd600; --blue:#2979ff; --red:#ff4757; --green:#00e676;
 --font-ui:'Inter',sans-serif; --font-code:'JetBrains Mono',monospace;
}
*{box-sizing:border-box}
body{
 margin:0;height:100vh;background:var(--bg);color:#ccc;
 font-family:var(--font-ui);display:flex;flex-direction:column;overflow:hidden;
}
header{
 position:sticky;top:0;z-index:100;background:#050505;
 border-bottom:1px solid var(--border);
 padding:15px 25px;display:flex;justify-content:space-between;align-items:center;
}
.brand{font-size:1.1rem;font-weight:900}
.brand span{color:var(--gold)}
.status-pill{
 background:#111;border:1px solid #333;padding:6px 12px;border-radius:4px;
 font-family:var(--font-code);font-size:.6rem;color:var(--green);
 display:flex;align-items:center;gap:6px;cursor:pointer;
}
.dot{width:6px;height:6px;background:var(--green);border-radius:50%}
.dot.off{background:var(--red)}
#master-scroll{flex:1;overflow-y:auto;padding-bottom:80px}
.zone{padding:30px;border-bottom:1px dashed #222}
.zone-title{
 font-size:.7rem;font-weight:900;color:#666;margin-bottom:15px;
 text-transform:uppercase;letter-spacing:1px
}
.ingest-box{
 width:100%;height:200px;background:#080808;border:1px solid #333;
 border-radius:12px;padding:20px;font-family:var(--font-code);
 font-size:.7rem;color:var(--blue);white-space:pre;overflow:auto
}
.action-bar{display:flex;gap:15px;margin-top:20px}
.btn-pill{
 background:var(--gold);color:#000;border:none;padding:12px 30px;
 border-radius:50px;font-weight:900;font-size:.8rem;cursor:pointer
}
.btn-ghost{
 background:transparent;border:1px solid #444;color:#888;
 padding:10px 20px;border-radius:50px;font-weight:700;font-size:.7rem;cursor:pointer
}
.push-btn{
 width:100%;background:var(--green);color:#000;border:none;
 padding:20px;border-radius:12px;font-weight:900;font-size:1rem;
 margin-top:20px;cursor:pointer
}
.terminal{
 background:#000;border:1px solid #222;border-radius:8px;padding:15px;
 font-family:var(--font-code);font-size:.7rem;color:#666;height:120px;overflow-y:auto
}
.log-success{color:var(--green)}
.log-warn{color:var(--gold)}
.log-err{color:var(--red)}
</style>
</head>

<body>

<header>
 <div class="brand">VIA.<span>STACK</span> // ADMIN</div>
 <div class="status-pill" onclick="checkLocalData()">
   <div class="dot" id="db-status-dot"></div>
   <span id="db-status-text">DB CHECK</span>
 </div>
</header>

<div id="master-scroll">

<div class="zone">
 <div class="zone-title">01 // INGESTION ENGINE</div>

 <!-- TSV FILE UPLOAD -->
 <input type="file" id="tsv-file" hidden accept=".tsv,.txt" onchange="loadTSVFile(this)">
 <div class="action-bar">
   <button class="btn-ghost" onclick="document.getElementById('tsv-file').click()">UPLOAD TSV FILE</button>
 </div>

 <textarea id="raw-input" class="ingest-box"
 placeholder=">> PASTE RAW TSV HERE (OPTIONAL)\n>> FILE UPLOAD ALSO SUPPORTED"></textarea>

 <div class="action-bar">
  <button class="btn-pill" onclick="initiateAlignment()">INITIATE ALIGNMENT</button>
  <button class="btn-ghost" onclick="document.getElementById('raw-input').value=''">CLEAR INPUT</button>
 </div>

 <div class="terminal" id="console-log">
  <div>> ADMIN READY</div>
 </div>
</div>

<div class="zone">
 <div class="zone-title">02 // DEPLOYMENT DOCK</div>
 <button class="push-btn" onclick="pushToIndex()">>>> PUSH TO OPERATOR BRIDGE >>></button>
</div>

</div>

<script>
/* ===== GLOBAL STATE ===== */
const DB_KEY = "ALCHEMIST_MASTER_V1";
let RAW_LINES = [];
let STAGED_DATA = [];
let FAULTY_ROW_INDEX = -1;

/* ===== TSV FILE INGEST ===== */
function loadTSVFile(input){
 const file = input.files[0];
 if(!file) return;
 const reader = new FileReader();
 reader.onload = e=>{
   document.getElementById("raw-input").value = e.target.result;
   log("TSV FILE LOADED INTO BUFFER","success");
 };
 reader.readAsText(file);
 input.value="";
}

/* ===== INGESTION PIPELINE ===== */
function initiateAlignment(){
 const raw = document.getElementById("raw-input").value;
 if(!raw.trim()) return log("NO INPUT DETECTED","err");

 RAW_LINES = raw.split(/\r?\n/).filter(l =>
   l.trim() && !l.toUpperCase().startsWith("ID\t")
 );
 runGatekeeper();
}

function runGatekeeper(){
 const seen = new Set();
 for(let i=0;i<RAW_LINES.length;i++){
  const cols = RAW_LINES[i].split("\t");
  if(cols.length < 9){
   FAULTY_ROW_INDEX=i;
   return log(`ROW ${i+1} TOO SHORT (${cols.length} COLS)`,"err");
  }
  if(seen.has(cols[0].trim())){
   FAULTY_ROW_INDEX=i;
   return log(`DUPLICATE ID: ${cols[0]}`,"err");
  }
  seen.add(cols[0].trim());
 }
 finalizeStaging();
}

function finalizeStaging(){
 STAGED_DATA = RAW_LINES.map(line=>{
  const c=line.split("\t");
  let ans=c[6];
  if(c[9]?.includes("OPT_B")) ans=c[7];
  if(c[9]?.includes("OPT_C")) ans=c[8];
  return {
   id:c[0].trim(), set:c[1]||"SET_A", dom:c[2]||"",
   topic:c[3]||"", q:c[5], u:c[6], l:c[7], r:c[8],
   correct:ans, logic:c[10]||"", hint:c[11]||"",
   trap:c[12]||"", s1:c[23]||"", s2:c[24]||""
  };
 });
 log(`ALIGNMENT COMPLETE: ${STAGED_DATA.length} ROWS STAGED`,"success");
}

/* ===== DEPLOY ===== */
function pushToIndex(){
 if(!STAGED_DATA.length) return log("STAGE EMPTY","err");
 const existing = JSON.parse(localStorage.getItem(DB_KEY)||"[]");
 const map=new Map();
 existing.forEach(r=>map.set(r.id,r));
 STAGED_DATA.forEach(r=>map.set(r.id,r));
 localStorage.setItem(DB_KEY,JSON.stringify([...map.values()]));
 log("PUSH SUCCESSFUL","success");
 checkLocalData();
}

/* ===== STATUS ===== */
function checkLocalData(){
 const has=!!localStorage.getItem(DB_KEY);
 document.getElementById("db-status-text").innerText=has?"BRIDGE ACTIVE":"BRIDGE EMPTY";
 document.getElementById("db-status-dot").classList.toggle("off",!has);
}

/* ===== LOGGER ===== */
function log(msg,type){
 const t=document.getElementById("console-log");
 const d=document.createElement("div");
 d.textContent="> "+msg;
 d.className=type==="success"?"log-success":type==="err"?"log-err":"log-warn";
 t.prepend(d);
}

checkLocalData();
</script>
</body>
</html>
