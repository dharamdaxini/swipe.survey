<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIA.STACK | MASTER LAB v134.0</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- Fonts (UI only, NOT PDF) -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#050505;--panel:#0b0b0b;--border:#222;
  --gold:#ffd600;--green:#2ecc71;--red:#ff4444;
  --font-ui:'Inter',sans-serif;--font-mono:'JetBrains Mono',monospace;
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:#ccc;font-family:var(--font-ui);
  height:100vh;display:flex;flex-direction:column;overflow:hidden;
}
header{
  padding:20px;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;
}
.brand{font-weight:900;color:#fff}
.brand span{color:var(--gold)}
.status{font-family:var(--font-mono);font-size:.7rem;color:var(--green)}

#workspace{flex:1;padding:20px;display:flex;flex-direction:column}
textarea{
  flex:1;background:#000;border:1px solid #333;border-radius:12px;
  color:#ccc;font-family:var(--font-mono);font-size:12px;
  padding:15px;resize:none;
}

.actions{display:grid;grid-template-columns:2fr 1fr;gap:15px;padding:20px}
.btn{
  padding:18px;border-radius:40px;border:2px solid var(--gold);
  background:transparent;color:var(--gold);
  font-weight:900;text-transform:uppercase;cursor:pointer;
}
.btn.secondary{border-color:#444;color:#777}

.exports{
  display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
  padding:0 20px 20px;
}
.btn-export{
  background:#111;border:1px solid #222;border-radius:16px;
  padding:18px;color:#777;font-weight:700;font-size:.65rem;
  text-transform:uppercase;cursor:pointer;
}

#overlay{
  position:fixed;top:0;left:0;right:0;
  padding:10px;text-align:center;
  font-family:var(--font-mono);font-size:10px;font-weight:bold;
  transform:translateY(-100%);transition:.3s;z-index:999;
}
#overlay.active{transform:translateY(0)}
</style>
</head>

<body>

<div id="overlay">PROCESSING…</div>

<header>
  <div class="brand">VIA.<span>STACK</span> // MASTER LAB</div>
  <div class="status" id="sys">READY</div>
</header>

<div id="workspace">
  <textarea id="raw" placeholder="PASTE TSV (25-COLUMN CANONICAL) OR UPLOAD BELOW"></textarea>
</div>

<div class="actions">
  <button class="btn" onclick="align()">INITIATE ALIGNMENT</button>
  <button class="btn secondary" onclick="document.getElementById('file').click()">UPLOAD TSV</button>
  <input type="file" id="file" hidden accept=".tsv,.txt,.csv" onchange="loadFile(this)">
</div>

<div class="exports">
  <button class="btn-export" onclick="exportPDF()">PDF</button>
  <button class="btn-export" onclick="exportJSON()">JSON</button>
  <button class="btn-export" onclick="exportTSV()">TSV</button>
  <button class="btn-export" onclick="exportCSV()">CSV</button>
  <button class="btn-export" onclick="exportJS()">JS</button>
  <button class="btn-export" onclick="exportTXT()">TXT</button>
</div>

<script>
/* ================= CONSTANTS ================= */
const COLS = 25;
const LOCK_HEAD = 15;
const LOCK_TAIL = 7;

/* ================= STATE ================= */
const UI={
 raw:document.getElementById('raw'),
 overlay:document.getElementById('overlay'),
 sys:document.getElementById('sys')
};
let HEADERS=[],ROWS=[];

/* ================= FILE INGEST ================= */
function loadFile(input){
 const f=input.files[0];
 if(!f) return;
 const r=new FileReader();
 r.onload=e=>{
   UI.raw.value=e.target.result;
   status("FILE LOADED");
 };
 r.readAsText(f);
 input.value="";
}

/* ================= ALIGNER ================= */
function normalizeRow(cols){
 if(cols.length===COLS) return cols;
 const head=cols.slice(0,LOCK_HEAD);
 const tail=cols.slice(cols.length-LOCK_TAIL);
 const mid=cols.slice(LOCK_HEAD,cols.length-LOCK_TAIL)
   .join(' ').replace(/\s+/g,' ').trim();
 let rebuilt=head.concat([mid]).concat(tail);
 while(rebuilt.length<COLS) rebuilt.splice(COLS-LOCK_TAIL,0,"");
 return rebuilt.slice(0,COLS);
}

function align(){
 const txt=UI.raw.value.trim();
 if(!txt) return status("NO DATA",true);

 const lines=txt.split(/\r?\n/).filter(l=>l.trim());
 HEADERS=lines[0].split('\t');
 if(HEADERS.length!==COLS){
   return status(`HEADER ${HEADERS.length} ≠ ${COLS}`,true);
 }

 const map=new Map();
 let fixed=0;

 lines.slice(1).forEach(l=>{
   let c=l.split('\t');
   if(c.length!==COLS){ c=normalizeRow(c); fixed++; }
   map.set(c[0],c); // last ID wins
 });

 ROWS=[...map.values()];
 status(`ALIGNED ${ROWS.length} | FIXED ${fixed}`);
}

/* ================= EXPORTERS ================= */
function exportTSV(){
 dl([HEADERS.join('\t')].concat(ROWS.map(r=>r.join('\t'))).join('\n'),'vault.tsv','text/plain');
}
function exportCSV(){
 dl([HEADERS.join(',')].concat(ROWS.map(r=>r.join(','))).join('\n'),'vault.csv','text/csv');
}
function exportTXT(){
 dl(ROWS.map(r=>r.join(' | ')).join('\n'),'vault.txt','text/plain');
}
function exportJSON(){
 const data=ROWS.map(r=>{const o={};HEADERS.forEach((h,i)=>o[h]=r[i]||"");return o;});
 dl(JSON.stringify(data,null,2),'vault.json','application/json');
}
function exportJS(){
 const data=ROWS.map(r=>{const o={};HEADERS.forEach((h,i)=>o[h]=r[i]||"");return o;});
 dl(`const VAULT_DATA=${JSON.stringify(data,null,2)};`,'vault.js','application/javascript');
}

/* ================= FONT-SAFE PDF ================= */
function exportPDF(){
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();
 let y=20;

 ROWS.forEach((r,i)=>{
   if(y>260){doc.addPage();y=20;}
   doc.setFont("courier","bold");doc.setFontSize(11);
   doc.text(`Q${i+1} | ${r[0]}`,15,y);y+=6;

   doc.setFont("times","normal");
   const q=doc.splitTextToSize(r[5],180);
   doc.text(q,15,y);y+=q.length*5+4;

   doc.setFont("helvetica","normal");
   doc.text(`A) ${r[6]}`,15,y);y+=4;
   doc.text(`B) ${r[7]}`,15,y);y+=4;
   doc.text(`C) ${r[8]}`,15,y);y+=5;

   doc.setFont("courier","bold");
   doc.text(`ANSWER: ${r[9]}`,15,y);y+=6;

   if(r[10]){
     doc.setFont("times","italic");
     const lg=doc.splitTextToSize(`LOGIC: ${r[10]}`,180);
     doc.text(lg,15,y);y+=lg.length*4;
   }
   y+=6;
 });
 doc.save(`VAULT_${Date.now()}.pdf`);
 status("PDF EXPORTED");
}

/* ================= UTILS ================= */
function dl(c,n,t){
 const b=new Blob([c],{type:t});
 const a=document.createElement('a');
 a.href=URL.createObjectURL(b);a.download=n;a.click();
 status(`${n} EXPORTED`);
}
function status(msg,err){
 UI.overlay.textContent=msg;
 UI.overlay.style.background=err?'#ff4444':'#ffd600';
 UI.overlay.style.color=err?'#fff':'#000';
 UI.overlay.classList.add('active');
 setTimeout(()=>UI.overlay.classList.remove('active'),2000);
 UI.sys.textContent=msg;
}
</script>

</body>
</html>
