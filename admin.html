<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>VIA.STACK // MASTER ADMIN</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
 --bg:#050505;--card:#111;--border:#222;
 --gold:#ffd600;--red:#ff4757;--green:#00e676;
 --font-ui:'Inter',sans-serif;--font-code:'JetBrains Mono',monospace;
}
*{box-sizing:border-box}
body{margin:0;height:100vh;background:var(--bg);color:#eee;font-family:var(--font-ui);display:flex;flex-direction:column}

/* HEADER */
header{
 padding:15px 20px;border-bottom:1px solid var(--border);background:#000;
 display:flex;justify-content:space-between;align-items:center;height:60px;
}
.brand{font-size:14px;font-weight:900;letter-spacing:1px}
.brand span{color:var(--gold)}
.status-badge{
 font-family:var(--font-code);font-size:10px;padding:4px 8px;
 background:#222;border-radius:4px;color:#888;
}

/* LAYOUT */
#layout{flex:1;display:grid;grid-template-columns:1fr;overflow:hidden}
@media(min-width:768px){#layout{grid-template-columns:300px 1fr}}

aside{
 border-right:1px solid var(--border);padding:20px;background:#080808;
 display:flex;flex-direction:column;gap:20px;overflow-y:auto;
}

.zone-label{
 font-family:var(--font-code);font-size:10px;color:#555;
 margin-bottom:10px;font-weight:700
}

.btn{
 width:100%;padding:14px;border:1px solid var(--border);background:#111;
 color:#ccc;font-family:var(--font-code);font-size:11px;font-weight:700;
 cursor:pointer;border-radius:6px;
 display:flex;justify-content:space-between;align-items:center;
}
.btn.primary{background:var(--gold);color:#000;border-color:var(--gold)}
.btn.danger{background:#220000;color:var(--red);border-color:#440000}

main{padding:20px;overflow-y:auto}

.panel{
 background:var(--card);border:1px solid var(--border);
 border-radius:12px;padding:20px
}

#terminal{
 font-family:var(--font-code);font-size:11px;color:#666;
 background:#000;border:1px solid var(--border);border-radius:8px;
 padding:15px;height:200px;overflow-y:auto;white-space:pre-wrap;
}
.log-success{color:var(--green)}
.log-error{color:var(--red)}
.log-warn{color:var(--gold)}

.stats{
 display:grid;grid-template-columns:repeat(2,1fr);
 gap:10px;margin-bottom:10px
}
.stat-box{
 background:#000;padding:10px;border-radius:6px;border:1px solid #222
}
.stat-val{font-size:18px;font-weight:900;color:#fff}
.stat-lbl{font-size:10px;color:#666;font-family:var(--font-code)}
</style>
</head>

<body>

<header>
 <div class="brand">VIA.<span>STACK</span> // MASTER ADMIN</div>
 <div class="status-badge" id="db-status">DB: EMPTY</div>
</header>

<div id="layout">
<aside>

<div>
 <div class="zone-label">01 // INGESTION</div>
 <input type="file" id="fileInput" hidden onchange="handleFile(this)">
 <button class="btn" onclick="fileInput.click()">
  <span>UPLOAD TSV (26-COL)</span><span>+</span>
 </button>
</div>

<div>
 <div class="zone-label">02 // MASTER VAULT OPS</div>
 <button class="btn primary" onclick="pushToMaster()">
  <span>PUSH TO MASTER</span><span>â†’</span>
 </button>
 <div style="height:10px"></div>
 <button class="btn" onclick="exportMaster()">
  <span>EXPORT MASTER (JSON)</span><span>â†“</span>
 </button>
</div>

<div style="margin-top:auto">
 <div class="zone-label" style="color:var(--red)">DANGER ZONE</div>
 <button class="btn danger" onclick="purgeMaster()">
  <span>PURGE MASTER VAULT</span><span>Ã—</span>
 </button>
</div>

</aside>

<main>
<div class="panel">
 <div class="zone-label">STAGING BUFFER</div>
 <div class="stats">
  <div class="stat-box">
   <div class="stat-val" id="count-staged">0</div>
   <div class="stat-lbl">ROWS STAGED</div>
  </div>
  <div class="stat-box">
   <div class="stat-val" id="count-master">0</div>
   <div class="stat-lbl">ROWS IN MASTER</div>
  </div>
 </div>
 <div id="terminal">> SYSTEM INITIALIZED</div>
</div>
</main>
</div>

<script>
/* ================= CONFIG ================= */
const MASTER_KEY = "ALCHEMIST_MASTER_V1";
const USER_KEY   = "ALCHEMIST_DATA_V1";   // ðŸ”¥ BRIDGE TARGET
let STAGED_DATA = [];

/* ================= INIT ================= */
window.onload = () => {
 updateStats();
 log("Admin Ready. Bridge Mode Enabled.", "success");
};

/* ================= TSV PARSER ================= */
function handleFile(input){
 const file=input.files[0]; if(!file) return;
 const reader=new FileReader();

 reader.onload=e=>{
  try{
   const rows=e.target.result.trim().split(/\r?\n/);

   STAGED_DATA = rows.map(line=>{
    const c=line.split("\t");
    if(c.length<10) return null;

    let correct=c[9];
    if(correct==="OPT_A") correct=c[6];
    if(correct==="OPT_B") correct=c[7];
    if(correct==="OPT_C") correct=c[8];

    return {
      id:c[0],
      set:c[1]||"SET_A",
      dom:"MASTER",
      topic:c[2]||"",
      q:c[5],
      u:c[6],
      l:c[7],
      r:c[8],
      correct:correct,
      logic:c[10]||"",
      hint:c[18]||"",
      trap:c[17]||"",
      step1:c[23]||"",
      step2:c[24]||""
    };
   }).filter(Boolean);

   log(`PARSED ${STAGED_DATA.length} ROWS`, "success");
   updateStats();
  }catch(err){
   log("PARSE ERROR: "+err.message,"error");
  }
 };
 reader.readAsText(file);
 input.value="";
}

/* ================= MASTER OPS ================= */
function pushToMaster(){
 if(!STAGED_DATA.length) return log("NO DATA TO PUSH","warn");

 const existing=JSON.parse(localStorage.getItem(MASTER_KEY)||"[]");
 const map=new Map(existing.map(x=>[x.id,x]));
 STAGED_DATA.forEach(x=>map.set(x.id,x));
 const merged=[...map.values()];

 localStorage.setItem(MASTER_KEY,JSON.stringify(merged));

 // ðŸ”¥ BRIDGE: inject into USER_KEY for app
 localStorage.setItem(USER_KEY, JSON.stringify(merged));

 STAGED_DATA=[];
 log(`PUSHED ${merged.length} QUESTIONS (BRIDGE ACTIVE)`,"success");
 updateStats();
}

function exportMaster(){
 const data=localStorage.getItem(MASTER_KEY);
 if(!data) return log("MASTER EMPTY","warn");

 const blob=new Blob([data],{type:"application/json"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="master.json";
 a.click();
 log("EXPORTED master.json","success");
}

function purgeMaster(){
 if(!confirm("DELETE ALL MASTER DATA?")) return;
 localStorage.removeItem(MASTER_KEY);
 localStorage.removeItem(USER_KEY);
 log("MASTER PURGED","error");
 updateStats();
}

/* ================= UI ================= */
function log(msg,type){
 const t=document.getElementById("terminal");
 const d=document.createElement("div");
 d.textContent="> "+msg;
 d.className=type==="success"?"log-success":type==="error"?"log-error":"log-warn";
 t.appendChild(d); t.scrollTop=t.scrollHeight;
}

function updateStats(){
 const m=JSON.parse(localStorage.getItem(MASTER_KEY)||"[]");
 count-staged.innerText=STAGED_DATA.length;
 count-master.innerText=m.length;
 db-status.innerText=m.length?"DB: CONNECTED":"DB: EMPTY";
 db-status.style.color=m.length?"#00e676":"#ff4757";
}
</script>

</body>
</html>
