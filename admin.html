
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIA.STACK | ADMIN v136.80</title>  
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --panel: #0a0a0a; --gold: #ffd600; --green: #00e676; --red: #ff4757; --blue: #2979ff; --font-code: 'JetBrains Mono', monospace; }
        body { margin: 0; background: var(--bg); color: #ccc; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { padding: 15px 25px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; background: #000; }
        .brand { font-weight: 900; color: #fff; letter-spacing: -0.5px; } .brand span { color: var(--gold); }
        #master-scroll { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .zone { padding: 30px; border-bottom: 1px dashed #222; }
        .zone-title { font-size: 0.7rem; font-weight: 900; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .ingest-box { width: 100%; height: 150px; background: #080808; border: 1px solid #333; color: var(--blue); padding: 15px; font-family: var(--font-code); font-size: 0.75rem; border-radius: 8px; resize: none; }
        .ingest-box:focus { border-color: var(--gold); outline: none; }
        .action-bar { margin-top: 15px; display: flex; gap: 10px; }
        button { border: none; padding: 10px 20px; border-radius: 4px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 0.7rem; }
        .btn-green { background: var(--green); color: #000; }
        .btn-ghost { background: transparent; border: 1px solid #444; color: #888; }
        .terminal { background: #000; border: 1px solid #222; padding: 15px; height: 120px; overflow-y: auto; font-family: var(--font-code); font-size: 0.7rem; margin-top: 15px; border-radius: 8px; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #111; }
        .log-success { color: var(--green); } .log-err { color: var(--red); } .log-warn { color: var(--gold); }
    </style>
</head>
<body>

<header>
    <div class="brand">VIA.<span>STACK</span> <span style="font-weight:400; color:#666; font-size:0.7rem;">// ADMIN v136.80</span></div>
</header>

<div id="master-scroll">

    <div class="zone" style="border-left: 3px solid var(--gold);">
        <div class="zone-title" style="color:var(--gold)">04 // IDENTITY LINKER (SMART SCAN)</div>
        <textarea id="wa-dump" class="ingest-box" placeholder="PASTE CHAT HERE...&#10;&#10;It detects:&#10;LINK MY ID: SES_XXXXX&#10;(Next Line) 7861966919"></textarea>
        <div class="action-bar">
            <button class="btn-green" onclick="linkIdentities()">ðŸ”— SCAN & LINK</button>
            <button class="btn-ghost" onclick="document.getElementById('wa-dump').value=''">CLEAR</button>
        </div>
        <div class="terminal" id="link-log">
            <div class="log-entry">> WAITING FOR INPUT...</div>
        </div>
    </div>

    <div class="zone">
        <div class="zone-title" style="color:#666">01 // DATA INGESTION</div>
        <textarea id="raw-input" class="ingest-box" placeholder="PASTE QUESTIONS TSV..."></textarea>
        <div class="action-bar">
            <button class="btn-ghost" onclick="initiateAlignment()">PROCESS TSV</button>
        </div>
        <div class="terminal" id="console-log">
            <div class="log-entry">> READY.</div>
        </div>
    </div>

</div>

<script>
    // --- CONFIGURATION ---
    const BEACON_URL = "https://script.google.com/macros/s/AKfycbwV8ALtVlLe31BcEi6AIq7MBNlu498vzU-kNpvaHl1zCafZVpffJe-1NtYkJtEKCT8m/exec"; 
    
    /* --- IDENTITY LINKER LOGIC (MULTI-LINE SCANNER) --- */
    function linkIdentities() {
        const dump = document.getElementById('wa-dump').value;
        const logger = document.getElementById('link-log');
        
        if(!dump.trim()) {
            logger.innerHTML += `<div class="log-entry log-err">> ERROR: EMPTY INPUT.</div>`; 
            return;
        }

        const lines = dump.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
        let found = 0;

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            
            // 1. Hunt for SES ID
            const sesMatch = line.match(/SES_[A-Z0-9]{5,6}/);
            
            if (sesMatch) {
                const sesID = sesMatch[0];
                let mobileFound = null;

                // 2. Look Ahead (Next 5 lines) for a standalone number
                for (let j = 0; j <= 5; j++) { // j=0 checks current line too
                    if (i + j >= lines.length) break;
                    
                    const nextLine = lines[i + j];
                    // Strict 10-digit match (ignoring spaces/dashes)
                    const cleanNum = nextLine.replace(/[^0-9]/g, '');
                    
                    if (cleanNum.length >= 10 && cleanNum.length <= 13) {
                        // Take last 10 digits
                        mobileFound = "+91" + cleanNum.slice(-10);
                        break; 
                    }
                }

                if (mobileFound) {
                    logger.innerHTML += `<div class="log-entry log-success">> MATCH: ${sesID} + ${mobileFound}</div>`;
                    sendLinkToCloud(sesID, mobileFound, logger);
                    found++;
                } else {
                    logger.innerHTML += `<div class="log-entry log-warn">> FOUND ${sesID} BUT NO NUMBER NEARBY.</div>`;
                }
            }
        }

        if(found === 0) {
            logger.innerHTML += `<div class="log-entry log-warn">> SCAN COMPLETE. 0 LINKS FOUND.</div>`;
        }
    }

    function sendLinkToCloud(sesID, mobile, logger) {
        fetch(BEACON_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                action: "LINK",
                ses_id: sesID,
                mobile: mobile
            })
        }).then(() => {
            // logger.innerHTML += `<div class="log-entry">> SENT TO CLOUD.</div>`;
        }).catch(e => {
            logger.innerHTML += `<div class="log-entry log-err">> UPLINK FAILED.</div>`;
        });
    }

    function log(msg, type) {
        const t = document.getElementById('console-log');
        t.innerHTML += `<div class="log-entry log-${type}">> ${msg}</div>`;
        t.scrollTop = t.scrollHeight;
    }
    function initiateAlignment() { log("TSV PROCESSING PLACEHOLDER", "success"); }

</script>
</body>
</html>
